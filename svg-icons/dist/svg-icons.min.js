!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).SVGPlugin={})}(this,(function(e){"use strict";class t{constructor(e){this.rgbaObj=e}static fromRgb(e){const{r:a,g:i,b:n}=e;return new t({r:a,b:n,g:i,a:1})}static isLight(e,t=186){return.299*e.r+.587*e.g+.114*e.b>t}get isLight(){return t.isLight(this)}static contrastColor(e,a){let i=!1;return"auto"===e&&"auto"!==a&&(i=t.fromCssColorToRgb(a).isLight),i?t.fromRgb({r:0,g:0,b:0}):t.fromRgb({r:255,g:255,b:255})}static fromCssColorToRgb(e){const a=document.createElement("canvas");a.width=1,a.height=1;const i=a.getContext("2d");if(!i)return new t({r:0,g:0,b:0,a:0});i.fillStyle=e,i.fillRect(0,0,1,1);const n=i.getImageData(0,0,1,1),[s,r,o,g]=n.data;return new t({r:s,g:r,b:o,a:Math.round(g/255)})}get r(){return this.rgbaObj.r}get g(){return this.rgbaObj.g}get b(){return this.rgbaObj.b}get a(){return this.rgbaObj.a}set r(e){this.rgbaObj.r=e}set g(e){this.rgbaObj.g=e}set b(e){this.rgbaObj.b=e}set a(e){this.rgbaObj.a=e}get rgba(){const{r:e,g:t,b:a,a:i}=this.rgbaObj;return`rgba(${e},${t},${a},${i})`}get rgbaArray(){const{r:e,g:t,b:a,a:i}=this.rgbaObj;return[e,t,a,i]}get rgbaArray255(){const{r:e,g:t,b:a,a:i}=this.rgbaObj;return[e,t,a,Math.round(255*i)]}get hex(){let[e,t,a,i]=this.rgbaArray255;const n=e=>e.toString(16).padStart(2,"0");return`#${n(e)}${n(t)}${n(a)}${n(i)}`}}class a{constructor(e){if("string"==typeof e){const t=document.createElement("div");t.innerHTML=e;let a=t.querySelector("svg");if(!a)throw new Error("Not a valid SVG");this.svgElement=a}else this.svgElement=e}get width(){var e;const t=this.svgElement.style.width,a=t?Number(t.replace(/[^0-9-]+/g,"")):void 0,i=this.svgElement.getAttribute("width"),n=i?Number(i.replace(/[^0-9-]+/g,"")):void 0;return null!==(e=null!=a?a:n)&&void 0!==e?e:this.svgElement.getBoundingClientRect().width}get height(){var e;const t=this.svgElement.style.height,a=t?Number(t.replace(/[^0-9-]+/g,"")):void 0,i=this.svgElement.getAttribute("height"),n=i?Number(i.replace(/[^0-9-]+/g,"")):void 0;return null!==(e=null!=a?a:n)&&void 0!==e?e:this.svgElement.getBoundingClientRect().height}set width(e){this.svgElement.setAttribute("width",e.toString()+"px")}set height(e){this.svgElement.setAttribute("height",e.toString()+"px")}getSvgDimensions(){const e=this.svgElement,t=null==e?void 0:e.getAttribute("width"),a=null==e?void 0:e.getAttribute("height");return{width:t?Number(t.replace(/[^0-9-]+/g,"")):void 0,height:a?Number(a.replace(/[^0-9-]+/g,"")):void 0}}getCurrentSvgValues(){var e;const t=["animate","animateTransform","animateMotion","animateColor","set","discard"],a=document.createElementNS("http://www.w3.org/2000/svg","svg");[...this.svgElement.attributes].forEach((({name:e,value:t})=>a.setAttribute(e,t)));const i=[...this.svgElement.children].map((e=>({parent:a,child:e})));for(;i.length>0;){const{parent:a,child:n}=i.shift();let s;if(n.nodeType===Node.ELEMENT_NODE&&-1===t.indexOf(n.tagName)){s=document.createElementNS("http://www.w3.org/2000/svg",n.tagName),[...n.attributes].forEach((({name:e,value:t})=>{var a;const i=null===(a=n[e])||void 0===a?void 0:a.animVal,r=void 0!==i&&void 0!==i.value?i.value:t;s.setAttribute(e,r)})),(null===(e=n.firstChild)||void 0===e?void 0:e.nodeValue)&&(s.textContent=n.firstChild.nodeValue);const t=window.getComputedStyle(n);for(let e=0;e<t.length;e++){let a=t[e];s.style[a]=t.getPropertyValue(a)}}s&&(a.appendChild(s),n.children&&n.children.length&&i.push(...[...n.children].map((e=>({parent:s,child:e})))))}return a}animatedSvg(e,t){const a=this;let i=t.data,n=!0,s=!1;return{width:t.width,height:t.height,data:t.data,onAdd:function(){e.plugin.map._canvasContainer.appendChild(a.svgElement);const t=Array.from(a.svgElement.getElementsByTagName("animate")).map((e=>new Promise((t=>{e.addEventListener("endEvent",(()=>{t()}),!1)}))));Promise.all(t).then((()=>{n=!1}))},onRemove:()=>{a.svgElement.remove()},render:function(){if(!n&&s)return!1;const t=new Image,r=document.createElement("canvas");r.width=this.width,r.height=this.height;const o=r.getContext("2d"),g=(new XMLSerializer).serializeToString(a.getCurrentSvgValues.bind(a)()),l=new Blob([g],{type:"image/svg+xml;charset=utf-8"}),c=URL.createObjectURL(l),h=new Promise(((e,a)=>{t.onload=()=>e(),t.onerror=e=>a(e)}));return t.src=c,h.then((()=>{URL.revokeObjectURL(c),o.drawImage(t,0,0,r.width,r.height),i=o.getImageData(0,0,r.width,r.height).data})).catch((e=>{throw URL.revokeObjectURL(c),e})),this.data=i,!n&&s&&(s=!0,this.onRemove&&this.onRemove()),e.plugin.map.triggerRepaint(),!0}}}async asImageData(e){let{height:t,width:a}=this;a*=e.config.imageOptions.pixelRatio,t*=e.config.imageOptions.pixelRatio;const i=new Image,n=(new XMLSerializer).serializeToString(this.svgElement),s=new Blob([n],{type:"image/svg+xml;charset=utf-8"}),r=URL.createObjectURL(s),o=new Promise(((e,t)=>{i.onload=()=>e(),i.onerror=e=>t(e)}));i.src=r;try{await o}catch(e){throw e}finally{URL.revokeObjectURL(r)}const g=document.createElement("canvas");g.width=a,g.height=t;const l=g.getContext("2d");null==l||l.drawImage(i,0,0,g.width,g.height);return l.getImageData(0,0,g.width,g.height)}async asStyleImage(e){const t=["animate","animateTransform","animateMotion","animateColor","set","discard"].reduce(((e,t)=>e||this.svgElement.getElementsByTagName(t).length>0),!1),a=await this.asImageData(e);return t?this.animatedSvg(e,a):a}}async function i(){void 0===this.imageData&&(this.imageData=this.config.fallbackImage);let e=this.imageData;if("string"==typeof e||e instanceof SVGElement){e instanceof SVGElement&&(e=e.outerHTML);try{const t=new a(e);e=await t.asStyleImage(this)}catch(e){throw e}}if(this.plugin.getTypes.isStyleImageInterface(e))return e;{const t=Array(7).fill(void 0).map((()=>Math.random().toString(36).substring(2))).join("-");return this.plugin.map.addImage(t,e),e=this.plugin.map.style.imageManager.getImage(t).data,this.plugin.map.style.imageManager.removeImage(t),e}}class n{constructor(e,t){if("string"==typeof e){this._originalId=e;try{e=JSON.parse(decodeURIComponent(e))}catch(a){e={...t.options,baseImageId:void 0}}}else this._originalId=t.stringifyConfig(e);this.config={...t.options,...e,imageOptions:{...t.options.imageOptions,...e.imageOptions}},this.plugin=t}get imageId(){return this._originalId}async execute(e){const t=this.config;let a,n=[];return t.baseImageId&&void 0===e?(e=t.fallbackImage,n=this.config.fallbackFunctions||this.config.functions||[]):n=this.config.functions||[],a=await n.reduce((async(e,a)=>{const i=await e,n=this.plugin.options.customFunctions[a.name];if(!n)return void console.warn("Image processing function missing: "+a.name);return await n.bind({...this,imageData:i||t.fallbackImage})(a.params)}),Promise.resolve(e)),await i.bind({...this,imageData:a||t.fallbackImage})()}}const s={black:"black",white:"white",removeTransparency:!1,threshold:186};function r(e){return"object"==typeof e&&null!==e&&!("number"!=typeof e.width||"number"!=typeof e.height||!(e.data instanceof Uint8Array||e.data instanceof Uint8ClampedArray)||void 0!==e.render&&"function"!=typeof e.render||void 0!==e.onAdd&&"function"!=typeof e.onAdd||void 0!==e.onRemove&&"function"!=typeof e.onRemove)}class o{constructor(e,t={}){this.missingBaseImages=new Map,this.imageDataLibrary=new Map,this.getTypes=o.getTypes,this.stringifyConfig=o.stringifyConfig,this.map=e,this.options={...o.defaultOptions,...t},e.on("styleimagemissing",(e=>this.addMissingBaseImage(e.id)));const a=this.debounce((()=>{this.processNewImages(e.style.imageManager.images)}),10);e.on("data",(e=>{"style"===e.dataType&&a()}))}processNewImages(e){Object.entries(e).filter((([e])=>this.missingBaseImages.has(e))).forEach((([e,t])=>{this.addImage(e,t.data)}))}addImage(e,t){this.imageDataLibrary.set(e,t);const a=new n(e,this);this.updateImage(a,t),Array.from(this.missingBaseImages).filter((([t])=>t===e)).forEach((([,e])=>{Array.from(e).forEach((e=>{const a=new n(e,this);this.updateImage(a,t)}))}))}addMissingBaseImage(e){var t;const a=new n(e,this),{baseImageId:i,imageOptions:s}=a.config,r={width:0,height:0,data:new Uint8Array};this.map.addImage(e,r,{sdf:s.sdf}),i&&(this.missingBaseImages.has(i)||this.missingBaseImages.set(i,new Set),null===(t=this.missingBaseImages.get(i))||void 0===t||t.add(e));const o=i&&this.imageDataLibrary.get(i);o||void 0===i?this.updateImage(a,o):this.setImageIdToFallback(a)}removeMissingBaseImage(e){const t=e.config.baseImageId;if(t&&this.missingBaseImages.has(t)){const a=this.missingBaseImages.get(t);a&&(a.delete(e.imageId),0===a.size&&this.missingBaseImages.delete(t))}}setImageIdToFallback(e){return this._updateImage(e,void 0)}async updateImage(e,t){const a=await this._updateImage(e,t);return a&&this.removeMissingBaseImage(e),a}async _updateImage(e,t){try{const a=await e.execute(t);this.map.hasImage(e.imageId)&&this.map.removeImage(e.imageId),this.map.addImage(e.imageId,a,e.config.imageOptions);const{version:i,data:n,...s}=this.map.style.getImage(e.imageId);return{...s,data:n.data,height:n.height,width:n.width}}catch(e){return void console.error("Error loading image",e)}}prefetchImageId(e){this.map.style.fire(new Event("styleimagemissing",{id:e}))}debounce(e,t){let a=null;return function(){null!==a&&clearTimeout(a),a=setTimeout((()=>{a=null,e()}),t)}}}o.defaultImageOptions={pixelRatio:window.devicePixelRatio,sdf:!1,stretchX:void 0,stretchY:void 0,content:void 0},o.defaultOptions={fallbackImage:'\n<svg width="10" height="10" xmlns="http://www.w3.org/2000/svg">\n  <circle cx="5" cy="5" r="5" fill="currentColor"/>\n</svg>',imageOptions:o.defaultImageOptions,fallbackFunctions:void 0,customFunctions:{applyCss:async function(e){let t=this.imageData;if(!("string"==typeof t||t instanceof SVGElement))return console.warn("ImageData passed to the applyCss function is not in SVG format, css cannot be applied"),this.imageData;t instanceof SVGElement&&(t=t.outerHTML);try{const i=new a(t);return Object.entries(e).forEach((([e,t])=>i.svgElement.style[e]=t)),i.svgElement.outerHTML}catch(e){return console.warn("SVG Image was not able to be processed, css could not be applied"),console.error(e),this.imageData}},recolorRaster:async function(e){const a=s;Object.entries(e).forEach((([e,t])=>{a.hasOwnProperty(e)?typeof t==typeof s[e]?a[e]=t:console.warn('Invalid type for "'+e+'" ("'+typeof t+'") using the default "'+s[e]+'".'):console.warn('Invalid key "'+e+'", the only accepted keys are: '+Object.keys(s).join(", "))}));return function(e,a,i,n,s){const{width:r,height:o,data:g}=e;let l=[];for(let e=0;e<o;e++)for(let o=0;o<r;o++){let c,h,m,d;c=g[4*o+e*(4*r)],h=g[4*o+e*(4*r)+1],m=g[4*o+e*(4*r)+2],d=g[4*o+e*(4*r)+3]/255,n&&(d=1);const u=new t({r:c,g:h,b:m,a:d});t.isLight(u,s)?l.push(...i.rgbaArray255):l.push(...a.rgbaArray255)}return{width:r,height:o,data:new Uint8ClampedArray(l)}}(await i.bind(this)(),t.fromCssColorToRgb(a.black),t.fromCssColorToRgb(a.white),a.removeTransparency,a.threshold)},toStyleImage:i,replaceValues:async function(e){var t;let i=this.imageData;if(!("string"==typeof i||i instanceof SVGElement))return console.warn("ImageData passed to the replaceValues function is not in SVG format, css could not replace values"),this.imageData;{i instanceof SVGElement&&(i=i.outerHTML);const n=t=>t.replace(/\{(.+?)\}/g,((t,a)=>e[a]||t));try{const e=new a(i);let s=[e.svgElement];for(;s.length>0;){const e=s.pop();e&&((null===(t=e.firstChild)||void 0===t?void 0:t.nodeValue)&&(e.firstChild.nodeValue=n(e.firstChild.nodeValue)),[...(null==e?void 0:e.attributes)||[]].forEach((t=>{let a=n(t.value);a!==t.value&&e.setAttribute(t.name,a),s.push(...e.children)})))}return e.svgElement.outerHTML}catch(e){return console.warn("SVG Image was not able to be processed, could not replace values"),console.error(e),this.imageData}}}}},o.ColorTools=t,o.getTypes={isStyleImageInterface:r},o.stringifyConfig=e=>encodeURIComponent(JSON.stringify(e,(function(e,t){return"string"==typeof t&&t.includes("{")&&t.includes("}")?t.replace(/{/g,"\\{").replace(/}/g,"\\}"):t}))).replace(/%5C%5C%7B/g,"{").replace(/%5C%5C%7D/g,"}"),e.SVGPlugin=o,e.isStyleImageInterface=r}));
//# sourceMappingURL=svg-icons.min.js.map
