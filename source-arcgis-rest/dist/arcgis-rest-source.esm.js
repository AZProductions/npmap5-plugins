/* @preserve
* @terraformer/arcgis - v2.1.1 - MIT
* Copyright (c) 2012-2022 Environmental Systems Research Institute, Inc.
* Tue Aug 02 2022 14:23:48 GMT-0700 (Pacific Daylight Time)
*/
var I=function(I,g,C,A){var i=(A[0]-C[0])*(I[1]-C[1])-(A[1]-C[1])*(I[0]-C[0]),e=(g[0]-I[0])*(I[1]-C[1])-(g[1]-I[1])*(I[0]-C[0]),l=(A[1]-C[1])*(g[0]-I[0])-(A[0]-C[0])*(g[1]-I[1]);if(0!==l){var Z=i/l,s=e/l;if(Z>=0&&Z<=1&&s>=0&&s<=1)return!0}return!1},g=function(g,C){for(var A=0;A<g.length-1;A++)for(var i=0;i<C.length-1;i++)if(I(g[A],g[A+1],C[i],C[i+1]))return!0;return!1},C=function(I){for(var g,C=0,A=0,i=I.length,e=I[A];A<i-1;A++)C+=((g=I[A+1])[0]-e[0])*(g[1]+e[1]),e=g;return C>=0},A=function(I,C){var A=g(I,C),i=function(I,g){for(var C=!1,A=-1,i=I.length,e=i-1;++A<i;e=A)(I[A][1]<=g[1]&&g[1]<I[e][1]||I[e][1]<=g[1]&&g[1]<I[A][1])&&g[0]<(I[e][0]-I[A][0])*(g[1]-I[A][1])/(I[e][1]-I[A][1])+I[A][0]&&(C=!C);return C}(I,C[0]);return!(A||!i)},i=function I(i,e){var l={};if(i.features){l.type="FeatureCollection",l.features=[];for(var Z=0;Z<i.features.length;Z++)l.features.push(I(i.features[Z],e))}if("number"==typeof i.x&&"number"==typeof i.y&&(l.type="Point",l.coordinates=[i.x,i.y],"number"==typeof i.z&&l.coordinates.push(i.z)),i.points&&(l.type="MultiPoint",l.coordinates=i.points.slice(0)),i.paths&&(1===i.paths.length?(l.type="LineString",l.coordinates=i.paths[0].slice(0)):(l.type="MultiLineString",l.coordinates=i.paths.slice(0))),i.rings&&(l=function(I){for(var i,e,l,Z,s=[],o=[],d=0;d<I.length;d++){var t=(function(I,g){for(var C=0;C<I.length;C++)if(I[C]!==g[C])return!1;return!0}((Z=I[d].slice(0))[0],Z[Z.length-1])||Z.push(Z[0]),Z);if(!(t.length<4))if(C(t)){var a=[t.slice().reverse()];s.push(a)}else o.push(t.slice().reverse())}for(var m=[];o.length;){l=o.pop();var n=!1;for(i=s.length-1;i>=0;i--)if(e=s[i][0],A(e,l)){s[i].push(l),n=!0;break}n||m.push(l)}for(;m.length;){l=m.pop();var c=!1;for(i=s.length-1;i>=0;i--)if(e=s[i][0],g(e,l)){s[i].push(l),c=!0;break}c||s.push([l.reverse()])}return 1===s.length?{type:"Polygon",coordinates:s[0]}:{type:"MultiPolygon",coordinates:s}}(i.rings.slice(0))),"number"==typeof i.xmin&&"number"==typeof i.ymin&&"number"==typeof i.xmax&&"number"==typeof i.ymax&&(l.type="Polygon",l.coordinates=[[[i.xmax,i.ymax],[i.xmin,i.ymax],[i.xmin,i.ymin],[i.xmax,i.ymin],[i.xmax,i.ymax]]]),(i.geometry||i.attributes)&&(l.type="Feature",l.geometry=i.geometry?I(i.geometry):null,l.properties=i.attributes?function(I){var g={};for(var C in I)I.hasOwnProperty(C)&&(g[C]=I[C]);return g}(i.attributes):null,i.attributes))try{l.id=function(I,g){for(var C=g?[g,"OBJECTID","FID"]:["OBJECTID","FID"],A=0;A<C.length;A++){var i=C[A];if(i in I&&("string"==typeof I[i]||"number"==typeof I[i]))return I[i]}throw Error("No valid id attribute found")}(i.attributes,e)}catch(I){}return JSON.stringify(l.geometry)===JSON.stringify({})&&(l.geometry=null),i.spatialReference&&i.spatialReference.wkid&&4326!==i.spatialReference.wkid&&console.warn("Object converted in non-standard crs - "+JSON.stringify(i.spatialReference)),l},e=null;try{var l="undefined"!=typeof module&&"function"==typeof module.require&&module.require("worker_threads")||"function"==typeof __non_webpack_require__&&__non_webpack_require__("worker_threads")||"function"==typeof require&&require("worker_threads");e=l.Worker}catch(I){}function Z(I,g,C){var A=void 0===g?null:g,i=function(I,g){return Buffer.from(I,"base64").toString(g?"utf16":"utf8")}(I,void 0!==C&&C),l=i.indexOf("\n",10)+1,Z=i.substring(l)+(A?"//# sourceMappingURL="+A:"");return function(I){return new e(Z,Object.assign({},I,{eval:!0}))}}function s(I,g,C){var A=void 0===g?null:g,i=function(I,g){var C=atob(I);if(g){for(var A=new Uint8Array(C.length),i=0,e=C.length;i<e;++i)A[i]=C.charCodeAt(i);return String.fromCharCode.apply(null,new Uint16Array(A.buffer))}return C}(I,void 0!==C&&C),e=i.indexOf("\n",10)+1,l=i.substring(e)+(A?"//# sourceMappingURL="+A:""),Z=new Blob([l],{type:"application/javascript"});return URL.createObjectURL(Z)}var o="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);var d,t,a,m=(d="Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwp2YXIgd29ya2VyX2NvZGUgPSAoZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAndXNlIHN0cmljdCc7CgogIGNvbnN0IGVhcnRoQ2lyY3VtZmVyZW5jZSA9IDQwMDc1MDE2LjY4NTU3ODQ5OwogIC8qKgogICAgKiBDb252ZXJ0cyBhIHdlYm1lcmNhdG9yIHgseSB0byBXR1M4NCBsbmcsbGF0CiAgICAqIEBwYXJhbSB4CiAgICAqIEBwYXJhbSB5CiAgICAqIEByZXR1cm5zIExuZ0xuZ0xpa2UKICAgICovCiAgZnVuY3Rpb24gdG9XR1M4NCh4LCB5KSB7CiAgICAgIC8vIENvbnZlcnQgdGhlIGxhdCBsbmcKICAgICAgY29uc3Qgd2dzTG5nID0geCAqIDE4MCAvIChlYXJ0aENpcmN1bWZlcmVuY2UgLyAyKTsKICAgICAgLy8gdGhhbmtzIG1hZ2ljaGltIEAgZ2l0aHViIGZvciB0aGUgY29ycmVjdGlvbgogICAgICBjb25zdCB3Z3NMYXQgPSBNYXRoLmF0YW4oTWF0aC5leHAoeSAqIE1hdGguUEkgLyAoZWFydGhDaXJjdW1mZXJlbmNlIC8gMikpKSAqIDM2MCAvIE1hdGguUEkgLSA5MDsKICAgICAgcmV0dXJuIHsgbG5nOiB3Z3NMbmcsIGxhdDogd2dzTGF0IH07CiAgfQoKICBjb25zdCB3ZWJNZXJjYXRvckNvZGVzID0gWycxMDIxMDAnLCAnOTAwOTEzJywgJzM4NTcnLCAnMzU4NycsICc1NDAwNCcsICc0MTAwMScsICcxMDIxMTMnLCAnMzc4NSddOwogIGZ1bmN0aW9uIG1lcmdlUmluZ3MocmluZ3NYLCByaW5nc1ksIHNyaWQpIHsKICAgICAgY29uc3QgcmVwcm9qZWN0ID0gKHgsIHkpID0+IHsKICAgICAgICAgIGNvbnN0IHh5ID0gdG9XR1M4NCh4LCB5KTsKICAgICAgICAgIHJldHVybiBbeHkubG5nLCB4eS5sYXRdOwogICAgICB9OwogICAgICBpZiAod2ViTWVyY2F0b3JDb2Rlcy5pbmRleE9mKHNyaWQpID4gLTEpIHsKICAgICAgICAgIHJldHVybiByaW5nc1gubWFwKChyaW5nLCBpKSA9PiByaW5nLm1hcCgoeCwgaikgPT4gcmVwcm9qZWN0KHgsIHJpbmdzWVtpXVtqXSkpKTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIHJldHVybiByaW5nc1gubWFwKChyaW5nLCBpKSA9PiByaW5nLm1hcCgoeCwgaikgPT4gW3gsIHJpbmdzWVtpXVtqXV0pKTsKICAgICAgfQogIH0KICBmdW5jdGlvbiBkZVppZ1phZyh2YWx1ZXMsIHNwbGl0cywgc2NhbGUsIGluaXRpYWxPZmZzZXQsIHVwcGVyTGVmdE9yaWdpbikgewogICAgICByZXR1cm4gc3BsaXRzLm1hcCgoc3BsaXQsIGkpID0+IHsKICAgICAgICAgIGxldCBsYXN0VmFsdWUgPSAwOwogICAgICAgICAgcmV0dXJuIEFycmF5KHNwbGl0KS5maWxsKHVuZGVmaW5lZCkubWFwKChfLCBqKSA9PiB7CiAgICAgICAgICAgICAgY29uc3QgdmFsdWVPZmZzZXQgPSBzcGxpdHMucmVkdWNlKChhLCB2LCBpZHgpID0+IGEgKz0gKGlkeCA8IGkgPyB2IDogMCksIDApOwogICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gdmFsdWVzW3ZhbHVlT2Zmc2V0ICsgal07CiAgICAgICAgICAgICAgY29uc3Qgc2lnbiA9IHVwcGVyTGVmdE9yaWdpbiA/IC0xIDogMTsKICAgICAgICAgICAgICBsZXQgcmV0dXJuVmFsdWU7CiAgICAgICAgICAgICAgaWYgKGogPT09IDApIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuVmFsdWUgPSAodmFsdWUgKiBzaWduKSArIChpbml0aWFsT2Zmc2V0IC8gc2NhbGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuVmFsdWUgPSAodmFsdWUgKiBzaWduKSArIGxhc3RWYWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGFzdFZhbHVlID0gcmV0dXJuVmFsdWU7CiAgICAgICAgICAgICAgcmV0dXJuIHJldHVyblZhbHVlOwogICAgICAgICAgfSkubWFwKCh2KSA9PiB2ICogc2NhbGUpOwogICAgICB9KTsKICB9CiAgY2xhc3MgRGVaaWdaYWdKU09OIHsKICAgICAgY29uc3RydWN0b3IoZmVhdHVyZXMsIHRyYW5zZm9ybSwgZ2VvbWV0cnlUeXBlKSB7CiAgICAgICAgICB0aGlzLnNyaWQgPSAnMzg1Nyc7CiAgICAgICAgICB0aGlzLmZlYXR1cmVzID0gZmVhdHVyZXM7CiAgICAgICAgICB0aGlzLnRyYW5zZm9ybSA9IHRyYW5zZm9ybTsKICAgICAgICAgIHRoaXMuZ2VvbWV0cnlUeXBlID0gZ2VvbWV0cnlUeXBlOwogICAgICB9CiAgICAgIGFzeW5jIGNvbnZlcnQoKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5mZWF0dXJlcy5tYXAoZmVhdHVyZSA9PiB7CiAgICAgICAgICAgICAgZmVhdHVyZS5nZW9tZXRyeSA9IHRoaXMuY29udmVydEdlb21ldHJ5KGZlYXR1cmUuZ2VvbWV0cnkpOwogICAgICAgICAgICAgIHJldHVybiBmZWF0dXJlOwogICAgICAgICAgfSk7CiAgICAgIH0KICAgICAgY29udmVydEdlb21ldHJ5KGdlb21ldHJ5KSB7CiAgICAgICAgICBjb25zdCBjb3VudHMgPSBbXTsKICAgICAgICAgIGNvbnN0IHggPSBbXTsKICAgICAgICAgIGNvbnN0IHkgPSBbXTsKICAgICAgICAgIGlmICh0aGlzLmdlb21ldHJ5VHlwZSA9PT0gJ2VzcmlHZW9tZXRyeVBvaW50JykgewogICAgICAgICAgICAgIGNvdW50cy5wdXNoKDEpOwogICAgICAgICAgICAgIHgucHVzaChnZW9tZXRyeS54KTsKICAgICAgICAgICAgICB5LnB1c2goZ2VvbWV0cnkueSk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmICh0aGlzLmdlb21ldHJ5VHlwZSA9PT0gJ2VzcmlHZW9tZXRyeU11bHRpcG9pbnQnKSB7CiAgICAgICAgICAgICAgZ2VvbWV0cnkucG9pbnRzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgIGNvdW50cy5wdXNoKDEpOwogICAgICAgICAgICAgICAgICB4LnB1c2gocFswXSk7CiAgICAgICAgICAgICAgICAgIHkucHVzaChwWzFdKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYgKHRoaXMuZ2VvbWV0cnlUeXBlID09PSAnZXNyaUdlb21ldHJ5UG9seWxpbmUnKSB7CiAgICAgICAgICAgICAgZ2VvbWV0cnkucGF0aHMuZm9yRWFjaChsID0+IHsKICAgICAgICAgICAgICAgICAgY291bnRzLnB1c2gobC5sZW5ndGgpOwogICAgICAgICAgICAgICAgICBsLmZvckVhY2gocG9zaXRpb24gPT4gewogICAgICAgICAgICAgICAgICAgICAgeC5wdXNoKHBvc2l0aW9uWzBdKTsKICAgICAgICAgICAgICAgICAgICAgIHkucHVzaChwb3NpdGlvblsxXSk7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAodGhpcy5nZW9tZXRyeVR5cGUgPT09ICdlc3JpR2VvbWV0cnlQb2x5Z29uJykgewogICAgICAgICAgICAgIGdlb21ldHJ5LnJpbmdzLmZvckVhY2gocG9seSA9PiB7CiAgICAgICAgICAgICAgICAgIGNvdW50cy5wdXNoKHBvbHkubGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgcG9seS5mb3JFYWNoKHBvc2l0aW9uID0+IHsKICAgICAgICAgICAgICAgICAgICAgIHgucHVzaChwb3NpdGlvblswXSk7CiAgICAgICAgICAgICAgICAgICAgICB5LnB1c2gocG9zaXRpb25bMV0pOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIGRlemlnemFnIHRoZSByaW5ncywgYW5kIG1lcmdlICsgcmVwcm9qZWN0IHRoZW0KICAgICAgICAgIGNvbnN0IHJpbmdzWCA9IGRlWmlnWmFnKHgsIGNvdW50cywgdGhpcy50cmFuc2Zvcm0uc2NhbGVbMF0sIHRoaXMudHJhbnNmb3JtLnRyYW5zbGF0ZVswXSwgZmFsc2UpOwogICAgICAgICAgY29uc3QgcmluZ3NZID0gZGVaaWdaYWcoeSwgY291bnRzLCB0aGlzLnRyYW5zZm9ybS5zY2FsZVsxXSwgdGhpcy50cmFuc2Zvcm0udHJhbnNsYXRlWzFdLCB0aGlzLnRyYW5zZm9ybS5vcmlnaW5Qb3NpdGlvbiA9PT0gJ3VwcGVyTGVmdCcpOwogICAgICAgICAgLy8gTWVyZ2UgdGhlIHJpbmdzCiAgICAgICAgICBjb25zdCByaW5ncyA9IG1lcmdlUmluZ3MocmluZ3NYLCByaW5nc1ksIHRoaXMuc3JpZCk7CiAgICAgICAgICBsZXQgbmV3R2VvbWV0cnkgPSB7fTsKICAgICAgICAgIGlmICh0aGlzLmdlb21ldHJ5VHlwZSA9PT0gJ2VzcmlHZW9tZXRyeVBvaW50JykgewogICAgICAgICAgICAgIG5ld0dlb21ldHJ5ID0geyAneCc6IHJpbmdzWzBdWzBdWzBdLCAneSc6IHJpbmdzWzBdWzBdWzFdIH07CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmICh0aGlzLmdlb21ldHJ5VHlwZSA9PT0gJ2VzcmlHZW9tZXRyeU11bHRpcG9pbnQnKSB7CiAgICAgICAgICAgICAgbmV3R2VvbWV0cnkgPSB7ICdwb2ludHMnOiByaW5nc1swXSB9OwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAodGhpcy5nZW9tZXRyeVR5cGUgPT09ICdlc3JpR2VvbWV0cnlQb2x5bGluZScpIHsKICAgICAgICAgICAgICBuZXdHZW9tZXRyeSA9IHsgcGF0aHM6IHJpbmdzIH07CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmICh0aGlzLmdlb21ldHJ5VHlwZSA9PT0gJ2VzcmlHZW9tZXRyeVBvbHlnb24nKSB7CiAgICAgICAgICAgICAgbmV3R2VvbWV0cnkgPSB7IHJpbmdzOiByaW5ncyB9OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5ld0dlb21ldHJ5OwogICAgICB9CiAgfQoKICAvLyBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogIGZ1bmN0aW9uIHByb3RvICgpIHsKICAgICAgbGV0IEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlciA9IHt9OwogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIucmVhZCA9IGZ1bmN0aW9uIChwYmYsIGVuZCkgewogICAgICAgICAgcmV0dXJuIHBiZi5yZWFkRmllbGRzKEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5fcmVhZEZpZWxkLCB7IHZlcnNpb246ICIiLCBxdWVyeVJlc3VsdDogbnVsbCB9LCBlbmQpOwogICAgICB9OwogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuX3JlYWRGaWVsZCA9IGZ1bmN0aW9uICh0YWcsIG9iaiwgcGJmKSB7CiAgICAgICAgICBpZiAodGFnID09PSAxKQogICAgICAgICAgICAgIG9iai52ZXJzaW9uID0gcGJmLnJlYWRTdHJpbmcoKTsKICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gMikKICAgICAgICAgICAgICBvYmoucXVlcnlSZXN1bHQgPSBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuUXVlcnlSZXN1bHQucmVhZChwYmYsIHBiZi5yZWFkVmFyaW50KCkgKyBwYmYucG9zKTsKICAgICAgfTsKICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLndyaXRlID0gZnVuY3Rpb24gKG9iaiwgcGJmKSB7CiAgICAgICAgICBpZiAob2JqLnZlcnNpb24pCiAgICAgICAgICAgICAgcGJmLndyaXRlU3RyaW5nRmllbGQoMSwgb2JqLnZlcnNpb24pOwogICAgICAgICAgaWYgKG9iai5xdWVyeVJlc3VsdCkKICAgICAgICAgICAgICBwYmYud3JpdGVNZXNzYWdlKDIsIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5RdWVyeVJlc3VsdC53cml0ZSwgb2JqLnF1ZXJ5UmVzdWx0KTsKICAgICAgfTsKICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkdlb21ldHJ5VHlwZSA9IHsKICAgICAgICAgICJlc3JpR2VvbWV0cnlUeXBlUG9pbnQiOiB7CiAgICAgICAgICAgICAgInZhbHVlIjogMCwKICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgImVzcmlHZW9tZXRyeVR5cGVNdWx0aXBvaW50IjogewogICAgICAgICAgICAgICJ2YWx1ZSI6IDEsCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQogICAgICAgICAgfSwKICAgICAgICAgICJlc3JpR2VvbWV0cnlUeXBlUG9seWxpbmUiOiB7CiAgICAgICAgICAgICAgInZhbHVlIjogMiwKICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgImVzcmlHZW9tZXRyeVR5cGVQb2x5Z29uIjogewogICAgICAgICAgICAgICJ2YWx1ZSI6IDMsCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQogICAgICAgICAgfSwKICAgICAgICAgICJlc3JpR2VvbWV0cnlUeXBlTXVsdGlwYXRjaCI6IHsKICAgICAgICAgICAgICAidmFsdWUiOiA0LAogICAgICAgICAgICAgICJvcHRpb25zIjoge30KICAgICAgICAgIH0sCiAgICAgICAgICAiZXNyaUdlb21ldHJ5VHlwZU5vbmUiOiB7CiAgICAgICAgICAgICAgInZhbHVlIjogMTI3LAogICAgICAgICAgICAgICJvcHRpb25zIjoge30KICAgICAgICAgIH0KICAgICAgfTsKICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkZpZWxkVHlwZSA9IHsKICAgICAgICAgICJlc3JpRmllbGRUeXBlU21hbGxJbnRlZ2VyIjogewogICAgICAgICAgICAgICJ2YWx1ZSI6IDAsCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQogICAgICAgICAgfSwKICAgICAgICAgICJlc3JpRmllbGRUeXBlSW50ZWdlciI6IHsKICAgICAgICAgICAgICAidmFsdWUiOiAxLAogICAgICAgICAgICAgICJvcHRpb25zIjoge30KICAgICAgICAgIH0sCiAgICAgICAgICAiZXNyaUZpZWxkVHlwZVNpbmdsZSI6IHsKICAgICAgICAgICAgICAidmFsdWUiOiAyLAogICAgICAgICAgICAgICJvcHRpb25zIjoge30KICAgICAgICAgIH0sCiAgICAgICAgICAiZXNyaUZpZWxkVHlwZURvdWJsZSI6IHsKICAgICAgICAgICAgICAidmFsdWUiOiAzLAogICAgICAgICAgICAgICJvcHRpb25zIjoge30KICAgICAgICAgIH0sCiAgICAgICAgICAiZXNyaUZpZWxkVHlwZVN0cmluZyI6IHsKICAgICAgICAgICAgICAidmFsdWUiOiA0LAogICAgICAgICAgICAgICJvcHRpb25zIjoge30KICAgICAgICAgIH0sCiAgICAgICAgICAiZXNyaUZpZWxkVHlwZURhdGUiOiB7CiAgICAgICAgICAgICAgInZhbHVlIjogNSwKICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgImVzcmlGaWVsZFR5cGVPSUQiOiB7CiAgICAgICAgICAgICAgInZhbHVlIjogNiwKICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgImVzcmlGaWVsZFR5cGVHZW9tZXRyeSI6IHsKICAgICAgICAgICAgICAidmFsdWUiOiA3LAogICAgICAgICAgICAgICJvcHRpb25zIjoge30KICAgICAgICAgIH0sCiAgICAgICAgICAiZXNyaUZpZWxkVHlwZUJsb2IiOiB7CiAgICAgICAgICAgICAgInZhbHVlIjogOCwKICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgImVzcmlGaWVsZFR5cGVSYXN0ZXIiOiB7CiAgICAgICAgICAgICAgInZhbHVlIjogOSwKICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgImVzcmlGaWVsZFR5cGVHVUlEIjogewogICAgICAgICAgICAgICJ2YWx1ZSI6IDEwLAogICAgICAgICAgICAgICJvcHRpb25zIjoge30KICAgICAgICAgIH0sCiAgICAgICAgICAiZXNyaUZpZWxkVHlwZUdsb2JhbElEIjogewogICAgICAgICAgICAgICJ2YWx1ZSI6IDExLAogICAgICAgICAgICAgICJvcHRpb25zIjoge30KICAgICAgICAgIH0sCiAgICAgICAgICAiZXNyaUZpZWxkVHlwZVhNTCI6IHsKICAgICAgICAgICAgICAidmFsdWUiOiAxMiwKICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5TUUxUeXBlID0gewogICAgICAgICAgInNxbFR5cGVCaWdJbnQiOiB7CiAgICAgICAgICAgICAgInZhbHVlIjogMCwKICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgInNxbFR5cGVCaW5hcnkiOiB7CiAgICAgICAgICAgICAgInZhbHVlIjogMSwKICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgInNxbFR5cGVCaXQiOiB7CiAgICAgICAgICAgICAgInZhbHVlIjogMiwKICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgInNxbFR5cGVDaGFyIjogewogICAgICAgICAgICAgICJ2YWx1ZSI6IDMsCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQogICAgICAgICAgfSwKICAgICAgICAgICJzcWxUeXBlRGF0ZSI6IHsKICAgICAgICAgICAgICAidmFsdWUiOiA0LAogICAgICAgICAgICAgICJvcHRpb25zIjoge30KICAgICAgICAgIH0sCiAgICAgICAgICAic3FsVHlwZURlY2ltYWwiOiB7CiAgICAgICAgICAgICAgInZhbHVlIjogNSwKICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgInNxbFR5cGVEb3VibGUiOiB7CiAgICAgICAgICAgICAgInZhbHVlIjogNiwKICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgInNxbFR5cGVGbG9hdCI6IHsKICAgICAgICAgICAgICAidmFsdWUiOiA3LAogICAgICAgICAgICAgICJvcHRpb25zIjoge30KICAgICAgICAgIH0sCiAgICAgICAgICAic3FsVHlwZUdlb21ldHJ5IjogewogICAgICAgICAgICAgICJ2YWx1ZSI6IDgsCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQogICAgICAgICAgfSwKICAgICAgICAgICJzcWxUeXBlR1VJRCI6IHsKICAgICAgICAgICAgICAidmFsdWUiOiA5LAogICAgICAgICAgICAgICJvcHRpb25zIjoge30KICAgICAgICAgIH0sCiAgICAgICAgICAic3FsVHlwZUludGVnZXIiOiB7CiAgICAgICAgICAgICAgInZhbHVlIjogMTAsCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQogICAgICAgICAgfSwKICAgICAgICAgICJzcWxUeXBlTG9uZ05WYXJjaGFyIjogewogICAgICAgICAgICAgICJ2YWx1ZSI6IDExLAogICAgICAgICAgICAgICJvcHRpb25zIjoge30KICAgICAgICAgIH0sCiAgICAgICAgICAic3FsVHlwZUxvbmdWYXJiaW5hcnkiOiB7CiAgICAgICAgICAgICAgInZhbHVlIjogMTIsCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQogICAgICAgICAgfSwKICAgICAgICAgICJzcWxUeXBlTG9uZ1ZhcmNoYXIiOiB7CiAgICAgICAgICAgICAgInZhbHVlIjogMTMsCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQogICAgICAgICAgfSwKICAgICAgICAgICJzcWxUeXBlTkNoYXIiOiB7CiAgICAgICAgICAgICAgInZhbHVlIjogMTQsCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQogICAgICAgICAgfSwKICAgICAgICAgICJzcWxUeXBlTlZhcmNoYXIiOiB7CiAgICAgICAgICAgICAgInZhbHVlIjogMTUsCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQogICAgICAgICAgfSwKICAgICAgICAgICJzcWxUeXBlT3RoZXIiOiB7CiAgICAgICAgICAgICAgInZhbHVlIjogMTYsCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQogICAgICAgICAgfSwKICAgICAgICAgICJzcWxUeXBlUmVhbCI6IHsKICAgICAgICAgICAgICAidmFsdWUiOiAxNywKICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgInNxbFR5cGVTbWFsbEludCI6IHsKICAgICAgICAgICAgICAidmFsdWUiOiAxOCwKICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgInNxbFR5cGVTcWxYbWwiOiB7CiAgICAgICAgICAgICAgInZhbHVlIjogMTksCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQogICAgICAgICAgfSwKICAgICAgICAgICJzcWxUeXBlVGltZSI6IHsKICAgICAgICAgICAgICAidmFsdWUiOiAyMCwKICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgInNxbFR5cGVUaW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgInZhbHVlIjogMjEsCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQogICAgICAgICAgfSwKICAgICAgICAgICJzcWxUeXBlVGltZXN0YW1wMiI6IHsKICAgICAgICAgICAgICAidmFsdWUiOiAyMiwKICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgInNxbFR5cGVUaW55SW50IjogewogICAgICAgICAgICAgICJ2YWx1ZSI6IDIzLAogICAgICAgICAgICAgICJvcHRpb25zIjoge30KICAgICAgICAgIH0sCiAgICAgICAgICAic3FsVHlwZVZhcmJpbmFyeSI6IHsKICAgICAgICAgICAgICAidmFsdWUiOiAyNCwKICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgInNxbFR5cGVWYXJjaGFyIjogewogICAgICAgICAgICAgICJ2YWx1ZSI6IDI1LAogICAgICAgICAgICAgICJvcHRpb25zIjoge30KICAgICAgICAgIH0KICAgICAgfTsKICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlF1YW50aXplT3JpZ2luUG9zdGlvbiA9IHsKICAgICAgICAgICJ1cHBlckxlZnQiOiB7CiAgICAgICAgICAgICAgInZhbHVlIjogMCwKICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgImxvd2VyTGVmdCI6IHsKICAgICAgICAgICAgICAidmFsdWUiOiAxLAogICAgICAgICAgICAgICJvcHRpb25zIjoge30KICAgICAgICAgIH0KICAgICAgfTsKICAgICAgLy8gRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlNwYXRpYWxSZWZlcmVuY2UgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuU3BhdGlhbFJlZmVyZW5jZSA9IHt9OwogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuU3BhdGlhbFJlZmVyZW5jZS5yZWFkID0gZnVuY3Rpb24gKHBiZiwgZW5kKSB7CiAgICAgICAgICByZXR1cm4gcGJmLnJlYWRGaWVsZHMoRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlNwYXRpYWxSZWZlcmVuY2UuX3JlYWRGaWVsZCwgeyB3a2lkOiAwLCBsYXN0ZXN0V2tpZDogMCwgdmNzV2tpZDogMCwgbGF0ZXN0VmNzV2tpZDogMCwgd2t0OiAiIiB9LCBlbmQpOwogICAgICB9OwogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuU3BhdGlhbFJlZmVyZW5jZS5fcmVhZEZpZWxkID0gZnVuY3Rpb24gKHRhZywgb2JqLCBwYmYpIHsKICAgICAgICAgIGlmICh0YWcgPT09IDEpCiAgICAgICAgICAgICAgb2JqLndraWQgPSBwYmYucmVhZFZhcmludCgpOwogICAgICAgICAgZWxzZSBpZiAodGFnID09PSAyKQogICAgICAgICAgICAgIG9iai5sYXN0ZXN0V2tpZCA9IHBiZi5yZWFkVmFyaW50KCk7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDMpCiAgICAgICAgICAgICAgb2JqLnZjc1draWQgPSBwYmYucmVhZFZhcmludCgpOwogICAgICAgICAgZWxzZSBpZiAodGFnID09PSA0KQogICAgICAgICAgICAgIG9iai5sYXRlc3RWY3NXa2lkID0gcGJmLnJlYWRWYXJpbnQoKTsKICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gNSkKICAgICAgICAgICAgICBvYmoud2t0ID0gcGJmLnJlYWRTdHJpbmcoKTsKICAgICAgfTsKICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlNwYXRpYWxSZWZlcmVuY2Uud3JpdGUgPSBmdW5jdGlvbiAob2JqLCBwYmYpIHsKICAgICAgICAgIGlmIChvYmoud2tpZCkKICAgICAgICAgICAgICBwYmYud3JpdGVWYXJpbnRGaWVsZCgxLCBvYmoud2tpZCk7CiAgICAgICAgICBpZiAob2JqLmxhc3Rlc3RXa2lkKQogICAgICAgICAgICAgIHBiZi53cml0ZVZhcmludEZpZWxkKDIsIG9iai5sYXN0ZXN0V2tpZCk7CiAgICAgICAgICBpZiAob2JqLnZjc1draWQpCiAgICAgICAgICAgICAgcGJmLndyaXRlVmFyaW50RmllbGQoMywgb2JqLnZjc1draWQpOwogICAgICAgICAgaWYgKG9iai5sYXRlc3RWY3NXa2lkKQogICAgICAgICAgICAgIHBiZi53cml0ZVZhcmludEZpZWxkKDQsIG9iai5sYXRlc3RWY3NXa2lkKTsKICAgICAgICAgIGlmIChvYmoud2t0KQogICAgICAgICAgICAgIHBiZi53cml0ZVN0cmluZ0ZpZWxkKDUsIG9iai53a3QpOwogICAgICB9OwogICAgICAvLyBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuRmllbGQgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuRmllbGQgPSB7fTsKICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkZpZWxkLnJlYWQgPSBmdW5jdGlvbiAocGJmLCBlbmQpIHsKICAgICAgICAgIHJldHVybiBwYmYucmVhZEZpZWxkcyhGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuRmllbGQuX3JlYWRGaWVsZCwgeyBuYW1lOiAiIiwgZmllbGRUeXBlOiAwLCBhbGlhczogIiIsIHNxbFR5cGU6IDAsIGRvbWFpbjogIiIsIGRlZmF1bHRWYWx1ZTogIiIgfSwgZW5kKTsKICAgICAgfTsKICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkZpZWxkLl9yZWFkRmllbGQgPSBmdW5jdGlvbiAodGFnLCBvYmosIHBiZikgewogICAgICAgICAgaWYgKHRhZyA9PT0gMSkKICAgICAgICAgICAgICBvYmoubmFtZSA9IHBiZi5yZWFkU3RyaW5nKCk7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDIpCiAgICAgICAgICAgICAgb2JqLmZpZWxkVHlwZSA9IHBiZi5yZWFkVmFyaW50KCk7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDMpCiAgICAgICAgICAgICAgb2JqLmFsaWFzID0gcGJmLnJlYWRTdHJpbmcoKTsKICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gNCkKICAgICAgICAgICAgICBvYmouc3FsVHlwZSA9IHBiZi5yZWFkVmFyaW50KCk7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDUpCiAgICAgICAgICAgICAgb2JqLmRvbWFpbiA9IHBiZi5yZWFkU3RyaW5nKCk7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDYpCiAgICAgICAgICAgICAgb2JqLmRlZmF1bHRWYWx1ZSA9IHBiZi5yZWFkU3RyaW5nKCk7CiAgICAgIH07CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5GaWVsZC53cml0ZSA9IGZ1bmN0aW9uIChvYmosIHBiZikgewogICAgICAgICAgaWYgKG9iai5uYW1lKQogICAgICAgICAgICAgIHBiZi53cml0ZVN0cmluZ0ZpZWxkKDEsIG9iai5uYW1lKTsKICAgICAgICAgIGlmIChvYmouZmllbGRUeXBlKQogICAgICAgICAgICAgIHBiZi53cml0ZVZhcmludEZpZWxkKDIsIG9iai5maWVsZFR5cGUpOwogICAgICAgICAgaWYgKG9iai5hbGlhcykKICAgICAgICAgICAgICBwYmYud3JpdGVTdHJpbmdGaWVsZCgzLCBvYmouYWxpYXMpOwogICAgICAgICAgaWYgKG9iai5zcWxUeXBlKQogICAgICAgICAgICAgIHBiZi53cml0ZVZhcmludEZpZWxkKDQsIG9iai5zcWxUeXBlKTsKICAgICAgICAgIGlmIChvYmouZG9tYWluKQogICAgICAgICAgICAgIHBiZi53cml0ZVN0cmluZ0ZpZWxkKDUsIG9iai5kb21haW4pOwogICAgICAgICAgaWYgKG9iai5kZWZhdWx0VmFsdWUpCiAgICAgICAgICAgICAgcGJmLndyaXRlU3RyaW5nRmllbGQoNiwgb2JqLmRlZmF1bHRWYWx1ZSk7CiAgICAgIH07CiAgICAgIC8vIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5WYWx1ZSA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5WYWx1ZSA9IHt9OwogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVmFsdWUucmVhZCA9IGZ1bmN0aW9uIChwYmYsIGVuZCkgewogICAgICAgICAgcmV0dXJuIHBiZi5yZWFkRmllbGRzKEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5WYWx1ZS5fcmVhZEZpZWxkLCB7IHN0cmluZ192YWx1ZTogIiIsIHZhbHVlX3R5cGU6IG51bGwsIGZsb2F0X3ZhbHVlOiAwLCBkb3VibGVfdmFsdWU6IDAsIHNpbnRfdmFsdWU6IDAsIHVpbnRfdmFsdWU6IDAsIGludDY0X3ZhbHVlOiAwLCB1aW50NjRfdmFsdWU6IDAsIHNpbnQ2NF92YWx1ZTogMCwgYm9vbF92YWx1ZTogZmFsc2UgfSwgZW5kKTsKICAgICAgfTsKICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlZhbHVlLl9yZWFkRmllbGQgPSBmdW5jdGlvbiAodGFnLCBvYmosIHBiZikgewogICAgICAgICAgaWYgKHRhZyA9PT0gMSkKICAgICAgICAgICAgICBvYmouc3RyaW5nX3ZhbHVlID0gcGJmLnJlYWRTdHJpbmcoKSwgb2JqLnZhbHVlX3R5cGUgPSAic3RyaW5nX3ZhbHVlIjsKICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gMikKICAgICAgICAgICAgICBvYmouZmxvYXRfdmFsdWUgPSBwYmYucmVhZEZsb2F0KCksIG9iai52YWx1ZV90eXBlID0gImZsb2F0X3ZhbHVlIjsKICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gMykKICAgICAgICAgICAgICBvYmouZG91YmxlX3ZhbHVlID0gcGJmLnJlYWREb3VibGUoKSwgb2JqLnZhbHVlX3R5cGUgPSAiZG91YmxlX3ZhbHVlIjsKICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gNCkKICAgICAgICAgICAgICBvYmouc2ludF92YWx1ZSA9IHBiZi5yZWFkU1ZhcmludCgpLCBvYmoudmFsdWVfdHlwZSA9ICJzaW50X3ZhbHVlIjsKICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gNSkKICAgICAgICAgICAgICBvYmoudWludF92YWx1ZSA9IHBiZi5yZWFkVmFyaW50KCksIG9iai52YWx1ZV90eXBlID0gInVpbnRfdmFsdWUiOwogICAgICAgICAgZWxzZSBpZiAodGFnID09PSA2KQogICAgICAgICAgICAgIG9iai5pbnQ2NF92YWx1ZSA9IHBiZi5yZWFkVmFyaW50KHRydWUpLCBvYmoudmFsdWVfdHlwZSA9ICJpbnQ2NF92YWx1ZSI7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDcpCiAgICAgICAgICAgICAgb2JqLnVpbnQ2NF92YWx1ZSA9IHBiZi5yZWFkVmFyaW50KCksIG9iai52YWx1ZV90eXBlID0gInVpbnQ2NF92YWx1ZSI7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDgpCiAgICAgICAgICAgICAgb2JqLnNpbnQ2NF92YWx1ZSA9IHBiZi5yZWFkU1ZhcmludCgpLCBvYmoudmFsdWVfdHlwZSA9ICJzaW50NjRfdmFsdWUiOwogICAgICAgICAgZWxzZSBpZiAodGFnID09PSA5KQogICAgICAgICAgICAgIG9iai5ib29sX3ZhbHVlID0gcGJmLnJlYWRCb29sZWFuKCksIG9iai52YWx1ZV90eXBlID0gImJvb2xfdmFsdWUiOwogICAgICB9OwogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVmFsdWUud3JpdGUgPSBmdW5jdGlvbiAob2JqLCBwYmYpIHsKICAgICAgICAgIGlmIChvYmouc3RyaW5nX3ZhbHVlKQogICAgICAgICAgICAgIHBiZi53cml0ZVN0cmluZ0ZpZWxkKDEsIG9iai5zdHJpbmdfdmFsdWUpOwogICAgICAgICAgaWYgKG9iai5mbG9hdF92YWx1ZSkKICAgICAgICAgICAgICBwYmYud3JpdGVGbG9hdEZpZWxkKDIsIG9iai5mbG9hdF92YWx1ZSk7CiAgICAgICAgICBpZiAob2JqLmRvdWJsZV92YWx1ZSkKICAgICAgICAgICAgICBwYmYud3JpdGVEb3VibGVGaWVsZCgzLCBvYmouZG91YmxlX3ZhbHVlKTsKICAgICAgICAgIGlmIChvYmouc2ludF92YWx1ZSkKICAgICAgICAgICAgICBwYmYud3JpdGVTVmFyaW50RmllbGQoNCwgb2JqLnNpbnRfdmFsdWUpOwogICAgICAgICAgaWYgKG9iai51aW50X3ZhbHVlKQogICAgICAgICAgICAgIHBiZi53cml0ZVZhcmludEZpZWxkKDUsIG9iai51aW50X3ZhbHVlKTsKICAgICAgICAgIGlmIChvYmouaW50NjRfdmFsdWUpCiAgICAgICAgICAgICAgcGJmLndyaXRlVmFyaW50RmllbGQoNiwgb2JqLmludDY0X3ZhbHVlKTsKICAgICAgICAgIGlmIChvYmoudWludDY0X3ZhbHVlKQogICAgICAgICAgICAgIHBiZi53cml0ZVZhcmludEZpZWxkKDcsIG9iai51aW50NjRfdmFsdWUpOwogICAgICAgICAgaWYgKG9iai5zaW50NjRfdmFsdWUpCiAgICAgICAgICAgICAgcGJmLndyaXRlU1ZhcmludEZpZWxkKDgsIG9iai5zaW50NjRfdmFsdWUpOwogICAgICAgICAgaWYgKG9iai5ib29sX3ZhbHVlKQogICAgICAgICAgICAgIHBiZi53cml0ZUJvb2xlYW5GaWVsZCg5LCBvYmouYm9vbF92YWx1ZSk7CiAgICAgIH07CiAgICAgIC8vIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5HZW9tZXRyeSA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5HZW9tZXRyeSA9IHt9OwogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuR2VvbWV0cnkucmVhZCA9IGZ1bmN0aW9uIChwYmYsIGVuZCkgewogICAgICAgICAgcmV0dXJuIHBiZi5yZWFkRmllbGRzKEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5HZW9tZXRyeS5fcmVhZEZpZWxkLCB7IGxlbmd0aHM6IFtdLCBjb29yZHM6IFtdIH0sIGVuZCk7CiAgICAgIH07CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5HZW9tZXRyeS5fcmVhZEZpZWxkID0gZnVuY3Rpb24gKHRhZywgb2JqLCBwYmYpIHsKICAgICAgICAgIGlmICh0YWcgPT09IDIpCiAgICAgICAgICAgICAgcGJmLnJlYWRQYWNrZWRWYXJpbnQob2JqLmxlbmd0aHMpOwogICAgICAgICAgZWxzZSBpZiAodGFnID09PSAzKQogICAgICAgICAgICAgIHBiZi5yZWFkUGFja2VkU1ZhcmludChvYmouY29vcmRzKTsKICAgICAgfTsKICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkdlb21ldHJ5LndyaXRlID0gZnVuY3Rpb24gKG9iaiwgcGJmKSB7CiAgICAgICAgICBpZiAob2JqLmxlbmd0aHMpCiAgICAgICAgICAgICAgcGJmLndyaXRlUGFja2VkVmFyaW50KDIsIG9iai5sZW5ndGhzKTsKICAgICAgICAgIGlmIChvYmouY29vcmRzKQogICAgICAgICAgICAgIHBiZi53cml0ZVBhY2tlZFNWYXJpbnQoMywgb2JqLmNvb3Jkcyk7CiAgICAgIH07CiAgICAgIC8vIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5lc3JpU2hhcGVCdWZmZXIgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuZXNyaVNoYXBlQnVmZmVyID0ge307CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5lc3JpU2hhcGVCdWZmZXIucmVhZCA9IGZ1bmN0aW9uIChwYmYsIGVuZCkgewogICAgICAgICAgcmV0dXJuIHBiZi5yZWFkRmllbGRzKEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5lc3JpU2hhcGVCdWZmZXIuX3JlYWRGaWVsZCwgeyBieXRlczogbnVsbCB9LCBlbmQpOwogICAgICB9OwogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuZXNyaVNoYXBlQnVmZmVyLl9yZWFkRmllbGQgPSBmdW5jdGlvbiAodGFnLCBvYmosIHBiZikgewogICAgICAgICAgaWYgKHRhZyA9PT0gMSkKICAgICAgICAgICAgICBvYmouYnl0ZXMgPSBwYmYucmVhZEJ5dGVzKCk7CiAgICAgIH07CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5lc3JpU2hhcGVCdWZmZXIud3JpdGUgPSBmdW5jdGlvbiAob2JqLCBwYmYpIHsKICAgICAgICAgIGlmIChvYmouYnl0ZXMpCiAgICAgICAgICAgICAgcGJmLndyaXRlQnl0ZXNGaWVsZCgxLCBvYmouYnl0ZXMpOwogICAgICB9OwogICAgICAvLyBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuRmVhdHVyZSA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5GZWF0dXJlID0ge307CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5GZWF0dXJlLnJlYWQgPSBmdW5jdGlvbiAocGJmLCBlbmQpIHsKICAgICAgICAgIHJldHVybiBwYmYucmVhZEZpZWxkcyhGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuRmVhdHVyZS5fcmVhZEZpZWxkLCB7IGF0dHJpYnV0ZXM6IFtdLCBnZW9tZXRyeTogbnVsbCwgY29tcHJlc3NlZF9nZW9tZXRyeTogbnVsbCwgc2hhcGVCdWZmZXI6IG51bGwsIGNlbnRyb2lkOiBudWxsIH0sIGVuZCk7CiAgICAgIH07CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5GZWF0dXJlLl9yZWFkRmllbGQgPSBmdW5jdGlvbiAodGFnLCBvYmosIHBiZikgewogICAgICAgICAgaWYgKHRhZyA9PT0gMSkKICAgICAgICAgICAgICBvYmouYXR0cmlidXRlcy5wdXNoKEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5WYWx1ZS5yZWFkKHBiZiwgcGJmLnJlYWRWYXJpbnQoKSArIHBiZi5wb3MpKTsKICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gMikKICAgICAgICAgICAgICBvYmouZ2VvbWV0cnkgPSBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuR2VvbWV0cnkucmVhZChwYmYsIHBiZi5yZWFkVmFyaW50KCkgKyBwYmYucG9zKSwgb2JqLmNvbXByZXNzZWRfZ2VvbWV0cnkgPSAiZ2VvbWV0cnkiOwogICAgICAgICAgZWxzZSBpZiAodGFnID09PSAzKQogICAgICAgICAgICAgIG9iai5zaGFwZUJ1ZmZlciA9IEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5lc3JpU2hhcGVCdWZmZXIucmVhZChwYmYsIHBiZi5yZWFkVmFyaW50KCkgKyBwYmYucG9zKSwgb2JqLmNvbXByZXNzZWRfZ2VvbWV0cnkgPSAic2hhcGVCdWZmZXIiOwogICAgICAgICAgZWxzZSBpZiAodGFnID09PSA0KQogICAgICAgICAgICAgIG9iai5jZW50cm9pZCA9IEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5HZW9tZXRyeS5yZWFkKHBiZiwgcGJmLnJlYWRWYXJpbnQoKSArIHBiZi5wb3MpOwogICAgICB9OwogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuRmVhdHVyZS53cml0ZSA9IGZ1bmN0aW9uIChvYmosIHBiZikgewogICAgICAgICAgaWYgKG9iai5hdHRyaWJ1dGVzKQogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmF0dHJpYnV0ZXMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgIHBiZi53cml0ZU1lc3NhZ2UoMSwgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlZhbHVlLndyaXRlLCBvYmouYXR0cmlidXRlc1tpXSk7CiAgICAgICAgICBpZiAob2JqLmdlb21ldHJ5KQogICAgICAgICAgICAgIHBiZi53cml0ZU1lc3NhZ2UoMiwgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkdlb21ldHJ5LndyaXRlLCBvYmouZ2VvbWV0cnkpOwogICAgICAgICAgaWYgKG9iai5zaGFwZUJ1ZmZlcikKICAgICAgICAgICAgICBwYmYud3JpdGVNZXNzYWdlKDMsIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5lc3JpU2hhcGVCdWZmZXIud3JpdGUsIG9iai5zaGFwZUJ1ZmZlcik7CiAgICAgICAgICBpZiAob2JqLmNlbnRyb2lkKQogICAgICAgICAgICAgIHBiZi53cml0ZU1lc3NhZ2UoNCwgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkdlb21ldHJ5LndyaXRlLCBvYmouY2VudHJvaWQpOwogICAgICB9OwogICAgICAvLyBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVW5pcXVlSWRGaWVsZCA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5VbmlxdWVJZEZpZWxkID0ge307CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5VbmlxdWVJZEZpZWxkLnJlYWQgPSBmdW5jdGlvbiAocGJmLCBlbmQpIHsKICAgICAgICAgIHJldHVybiBwYmYucmVhZEZpZWxkcyhGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVW5pcXVlSWRGaWVsZC5fcmVhZEZpZWxkLCB7IG5hbWU6ICIiLCBpc1N5c3RlbU1haW50YWluZWQ6IGZhbHNlIH0sIGVuZCk7CiAgICAgIH07CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5VbmlxdWVJZEZpZWxkLl9yZWFkRmllbGQgPSBmdW5jdGlvbiAodGFnLCBvYmosIHBiZikgewogICAgICAgICAgaWYgKHRhZyA9PT0gMSkKICAgICAgICAgICAgICBvYmoubmFtZSA9IHBiZi5yZWFkU3RyaW5nKCk7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDIpCiAgICAgICAgICAgICAgb2JqLmlzU3lzdGVtTWFpbnRhaW5lZCA9IHBiZi5yZWFkQm9vbGVhbigpOwogICAgICB9OwogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVW5pcXVlSWRGaWVsZC53cml0ZSA9IGZ1bmN0aW9uIChvYmosIHBiZikgewogICAgICAgICAgaWYgKG9iai5uYW1lKQogICAgICAgICAgICAgIHBiZi53cml0ZVN0cmluZ0ZpZWxkKDEsIG9iai5uYW1lKTsKICAgICAgICAgIGlmIChvYmouaXNTeXN0ZW1NYWludGFpbmVkKQogICAgICAgICAgICAgIHBiZi53cml0ZUJvb2xlYW5GaWVsZCgyLCBvYmouaXNTeXN0ZW1NYWludGFpbmVkKTsKICAgICAgfTsKICAgICAgLy8gRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkdlb21ldHJ5UHJvcGVydGllcyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5HZW9tZXRyeVByb3BlcnRpZXMgPSB7fTsKICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkdlb21ldHJ5UHJvcGVydGllcy5yZWFkID0gZnVuY3Rpb24gKHBiZiwgZW5kKSB7CiAgICAgICAgICByZXR1cm4gcGJmLnJlYWRGaWVsZHMoRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkdlb21ldHJ5UHJvcGVydGllcy5fcmVhZEZpZWxkLCB7IHNoYXBlQXJlYUZpZWxkTmFtZTogIiIsIHNoYXBlTGVuZ3RoRmllbGROYW1lOiAiIiwgdW5pdHM6ICIiIH0sIGVuZCk7CiAgICAgIH07CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5HZW9tZXRyeVByb3BlcnRpZXMuX3JlYWRGaWVsZCA9IGZ1bmN0aW9uICh0YWcsIG9iaiwgcGJmKSB7CiAgICAgICAgICBpZiAodGFnID09PSAxKQogICAgICAgICAgICAgIG9iai5zaGFwZUFyZWFGaWVsZE5hbWUgPSBwYmYucmVhZFN0cmluZygpOwogICAgICAgICAgZWxzZSBpZiAodGFnID09PSAyKQogICAgICAgICAgICAgIG9iai5zaGFwZUxlbmd0aEZpZWxkTmFtZSA9IHBiZi5yZWFkU3RyaW5nKCk7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDMpCiAgICAgICAgICAgICAgb2JqLnVuaXRzID0gcGJmLnJlYWRTdHJpbmcoKTsKICAgICAgfTsKICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkdlb21ldHJ5UHJvcGVydGllcy53cml0ZSA9IGZ1bmN0aW9uIChvYmosIHBiZikgewogICAgICAgICAgaWYgKG9iai5zaGFwZUFyZWFGaWVsZE5hbWUpCiAgICAgICAgICAgICAgcGJmLndyaXRlU3RyaW5nRmllbGQoMSwgb2JqLnNoYXBlQXJlYUZpZWxkTmFtZSk7CiAgICAgICAgICBpZiAob2JqLnNoYXBlTGVuZ3RoRmllbGROYW1lKQogICAgICAgICAgICAgIHBiZi53cml0ZVN0cmluZ0ZpZWxkKDIsIG9iai5zaGFwZUxlbmd0aEZpZWxkTmFtZSk7CiAgICAgICAgICBpZiAob2JqLnVuaXRzKQogICAgICAgICAgICAgIHBiZi53cml0ZVN0cmluZ0ZpZWxkKDMsIG9iai51bml0cyk7CiAgICAgIH07CiAgICAgIC8vIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5TZXJ2ZXJHZW5zID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlNlcnZlckdlbnMgPSB7fTsKICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlNlcnZlckdlbnMucmVhZCA9IGZ1bmN0aW9uIChwYmYsIGVuZCkgewogICAgICAgICAgcmV0dXJuIHBiZi5yZWFkRmllbGRzKEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5TZXJ2ZXJHZW5zLl9yZWFkRmllbGQsIHsgbWluU2VydmVyR2VuOiAwLCBzZXJ2ZXJHZW46IDAgfSwgZW5kKTsKICAgICAgfTsKICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlNlcnZlckdlbnMuX3JlYWRGaWVsZCA9IGZ1bmN0aW9uICh0YWcsIG9iaiwgcGJmKSB7CiAgICAgICAgICBpZiAodGFnID09PSAxKQogICAgICAgICAgICAgIG9iai5taW5TZXJ2ZXJHZW4gPSBwYmYucmVhZFZhcmludCgpOwogICAgICAgICAgZWxzZSBpZiAodGFnID09PSAyKQogICAgICAgICAgICAgIG9iai5zZXJ2ZXJHZW4gPSBwYmYucmVhZFZhcmludCgpOwogICAgICB9OwogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuU2VydmVyR2Vucy53cml0ZSA9IGZ1bmN0aW9uIChvYmosIHBiZikgewogICAgICAgICAgaWYgKG9iai5taW5TZXJ2ZXJHZW4pCiAgICAgICAgICAgICAgcGJmLndyaXRlVmFyaW50RmllbGQoMSwgb2JqLm1pblNlcnZlckdlbik7CiAgICAgICAgICBpZiAob2JqLnNlcnZlckdlbikKICAgICAgICAgICAgICBwYmYud3JpdGVWYXJpbnRGaWVsZCgyLCBvYmouc2VydmVyR2VuKTsKICAgICAgfTsKICAgICAgLy8gRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlNjYWxlID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlNjYWxlID0ge307CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5TY2FsZS5yZWFkID0gZnVuY3Rpb24gKHBiZiwgZW5kKSB7CiAgICAgICAgICByZXR1cm4gcGJmLnJlYWRGaWVsZHMoRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlNjYWxlLl9yZWFkRmllbGQsIHsgeFNjYWxlOiAwLCB5U2NhbGU6IDAsIG1TY2FsZTogMCwgelNjYWxlOiAwIH0sIGVuZCk7CiAgICAgIH07CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5TY2FsZS5fcmVhZEZpZWxkID0gZnVuY3Rpb24gKHRhZywgb2JqLCBwYmYpIHsKICAgICAgICAgIGlmICh0YWcgPT09IDEpCiAgICAgICAgICAgICAgb2JqLnhTY2FsZSA9IHBiZi5yZWFkRG91YmxlKCk7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDIpCiAgICAgICAgICAgICAgb2JqLnlTY2FsZSA9IHBiZi5yZWFkRG91YmxlKCk7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDMpCiAgICAgICAgICAgICAgb2JqLm1TY2FsZSA9IHBiZi5yZWFkRG91YmxlKCk7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDQpCiAgICAgICAgICAgICAgb2JqLnpTY2FsZSA9IHBiZi5yZWFkRG91YmxlKCk7CiAgICAgIH07CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5TY2FsZS53cml0ZSA9IGZ1bmN0aW9uIChvYmosIHBiZikgewogICAgICAgICAgaWYgKG9iai54U2NhbGUpCiAgICAgICAgICAgICAgcGJmLndyaXRlRG91YmxlRmllbGQoMSwgb2JqLnhTY2FsZSk7CiAgICAgICAgICBpZiAob2JqLnlTY2FsZSkKICAgICAgICAgICAgICBwYmYud3JpdGVEb3VibGVGaWVsZCgyLCBvYmoueVNjYWxlKTsKICAgICAgICAgIGlmIChvYmoubVNjYWxlKQogICAgICAgICAgICAgIHBiZi53cml0ZURvdWJsZUZpZWxkKDMsIG9iai5tU2NhbGUpOwogICAgICAgICAgaWYgKG9iai56U2NhbGUpCiAgICAgICAgICAgICAgcGJmLndyaXRlRG91YmxlRmllbGQoNCwgb2JqLnpTY2FsZSk7CiAgICAgIH07CiAgICAgIC8vIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5UcmFuc2xhdGUgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVHJhbnNsYXRlID0ge307CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5UcmFuc2xhdGUucmVhZCA9IGZ1bmN0aW9uIChwYmYsIGVuZCkgewogICAgICAgICAgcmV0dXJuIHBiZi5yZWFkRmllbGRzKEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5UcmFuc2xhdGUuX3JlYWRGaWVsZCwgeyB4VHJhbnNsYXRlOiAwLCB5VHJhbnNsYXRlOiAwLCBtVHJhbnNsYXRlOiAwLCB6VHJhbnNsYXRlOiAwIH0sIGVuZCk7CiAgICAgIH07CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5UcmFuc2xhdGUuX3JlYWRGaWVsZCA9IGZ1bmN0aW9uICh0YWcsIG9iaiwgcGJmKSB7CiAgICAgICAgICBpZiAodGFnID09PSAxKQogICAgICAgICAgICAgIG9iai54VHJhbnNsYXRlID0gcGJmLnJlYWREb3VibGUoKTsKICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gMikKICAgICAgICAgICAgICBvYmoueVRyYW5zbGF0ZSA9IHBiZi5yZWFkRG91YmxlKCk7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDMpCiAgICAgICAgICAgICAgb2JqLm1UcmFuc2xhdGUgPSBwYmYucmVhZERvdWJsZSgpOwogICAgICAgICAgZWxzZSBpZiAodGFnID09PSA0KQogICAgICAgICAgICAgIG9iai56VHJhbnNsYXRlID0gcGJmLnJlYWREb3VibGUoKTsKICAgICAgfTsKICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlRyYW5zbGF0ZS53cml0ZSA9IGZ1bmN0aW9uIChvYmosIHBiZikgewogICAgICAgICAgaWYgKG9iai54VHJhbnNsYXRlKQogICAgICAgICAgICAgIHBiZi53cml0ZURvdWJsZUZpZWxkKDEsIG9iai54VHJhbnNsYXRlKTsKICAgICAgICAgIGlmIChvYmoueVRyYW5zbGF0ZSkKICAgICAgICAgICAgICBwYmYud3JpdGVEb3VibGVGaWVsZCgyLCBvYmoueVRyYW5zbGF0ZSk7CiAgICAgICAgICBpZiAob2JqLm1UcmFuc2xhdGUpCiAgICAgICAgICAgICAgcGJmLndyaXRlRG91YmxlRmllbGQoMywgb2JqLm1UcmFuc2xhdGUpOwogICAgICAgICAgaWYgKG9iai56VHJhbnNsYXRlKQogICAgICAgICAgICAgIHBiZi53cml0ZURvdWJsZUZpZWxkKDQsIG9iai56VHJhbnNsYXRlKTsKICAgICAgfTsKICAgICAgLy8gRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlRyYW5zZm9ybSA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5UcmFuc2Zvcm0gPSB7fTsKICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlRyYW5zZm9ybS5yZWFkID0gZnVuY3Rpb24gKHBiZiwgZW5kKSB7CiAgICAgICAgICByZXR1cm4gcGJmLnJlYWRGaWVsZHMoRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlRyYW5zZm9ybS5fcmVhZEZpZWxkLCB7IHF1YW50aXplT3JpZ2luUG9zdGlvbjogMCwgc2NhbGU6IG51bGwsIHRyYW5zbGF0ZTogbnVsbCB9LCBlbmQpOwogICAgICB9OwogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVHJhbnNmb3JtLl9yZWFkRmllbGQgPSBmdW5jdGlvbiAodGFnLCBvYmosIHBiZikgewogICAgICAgICAgaWYgKHRhZyA9PT0gMSkKICAgICAgICAgICAgICBvYmoucXVhbnRpemVPcmlnaW5Qb3N0aW9uID0gcGJmLnJlYWRWYXJpbnQoKTsKICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gMikKICAgICAgICAgICAgICBvYmouc2NhbGUgPSBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuU2NhbGUucmVhZChwYmYsIHBiZi5yZWFkVmFyaW50KCkgKyBwYmYucG9zKTsKICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gMykKICAgICAgICAgICAgICBvYmoudHJhbnNsYXRlID0gRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlRyYW5zbGF0ZS5yZWFkKHBiZiwgcGJmLnJlYWRWYXJpbnQoKSArIHBiZi5wb3MpOwogICAgICB9OwogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVHJhbnNmb3JtLndyaXRlID0gZnVuY3Rpb24gKG9iaiwgcGJmKSB7CiAgICAgICAgICBpZiAob2JqLnF1YW50aXplT3JpZ2luUG9zdGlvbikKICAgICAgICAgICAgICBwYmYud3JpdGVWYXJpbnRGaWVsZCgxLCBvYmoucXVhbnRpemVPcmlnaW5Qb3N0aW9uKTsKICAgICAgICAgIGlmIChvYmouc2NhbGUpCiAgICAgICAgICAgICAgcGJmLndyaXRlTWVzc2FnZSgyLCBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuU2NhbGUud3JpdGUsIG9iai5zY2FsZSk7CiAgICAgICAgICBpZiAob2JqLnRyYW5zbGF0ZSkKICAgICAgICAgICAgICBwYmYud3JpdGVNZXNzYWdlKDMsIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5UcmFuc2xhdGUud3JpdGUsIG9iai50cmFuc2xhdGUpOwogICAgICB9OwogICAgICAvLyBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuRmVhdHVyZVJlc3VsdCA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5GZWF0dXJlUmVzdWx0ID0ge307CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5GZWF0dXJlUmVzdWx0LnJlYWQgPSBmdW5jdGlvbiAocGJmLCBlbmQpIHsKICAgICAgICAgIHJldHVybiBwYmYucmVhZEZpZWxkcyhGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuRmVhdHVyZVJlc3VsdC5fcmVhZEZpZWxkLCB7IG9iamVjdElkRmllbGROYW1lOiAiIiwgdW5pcXVlSWRGaWVsZDogbnVsbCwgZ2xvYmFsSWRGaWVsZE5hbWU6ICIiLCBnZW9oYXNoRmllbGROYW1lOiAiIiwgZ2VvbWV0cnlQcm9wZXJ0aWVzOiBudWxsLCBzZXJ2ZXJHZW5zOiBudWxsLCBnZW9tZXRyeVR5cGU6IDAsIHNwYXRpYWxSZWZlcmVuY2U6IG51bGwsIGV4Y2VlZGVkVHJhbnNmZXJMaW1pdDogZmFsc2UsIGhhc1o6IGZhbHNlLCBoYXNNOiBmYWxzZSwgdHJhbnNmb3JtOiBudWxsLCBmaWVsZHM6IFtdLCB2YWx1ZXM6IFtdLCBmZWF0dXJlczogW10gfSwgZW5kKTsKICAgICAgfTsKICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkZlYXR1cmVSZXN1bHQuX3JlYWRGaWVsZCA9IGZ1bmN0aW9uICh0YWcsIG9iaiwgcGJmKSB7CiAgICAgICAgICBpZiAodGFnID09PSAxKQogICAgICAgICAgICAgIG9iai5vYmplY3RJZEZpZWxkTmFtZSA9IHBiZi5yZWFkU3RyaW5nKCk7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDIpCiAgICAgICAgICAgICAgb2JqLnVuaXF1ZUlkRmllbGQgPSBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVW5pcXVlSWRGaWVsZC5yZWFkKHBiZiwgcGJmLnJlYWRWYXJpbnQoKSArIHBiZi5wb3MpOwogICAgICAgICAgZWxzZSBpZiAodGFnID09PSAzKQogICAgICAgICAgICAgIG9iai5nbG9iYWxJZEZpZWxkTmFtZSA9IHBiZi5yZWFkU3RyaW5nKCk7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDQpCiAgICAgICAgICAgICAgb2JqLmdlb2hhc2hGaWVsZE5hbWUgPSBwYmYucmVhZFN0cmluZygpOwogICAgICAgICAgZWxzZSBpZiAodGFnID09PSA1KQogICAgICAgICAgICAgIG9iai5nZW9tZXRyeVByb3BlcnRpZXMgPSBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuR2VvbWV0cnlQcm9wZXJ0aWVzLnJlYWQocGJmLCBwYmYucmVhZFZhcmludCgpICsgcGJmLnBvcyk7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDYpCiAgICAgICAgICAgICAgb2JqLnNlcnZlckdlbnMgPSBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuU2VydmVyR2Vucy5yZWFkKHBiZiwgcGJmLnJlYWRWYXJpbnQoKSArIHBiZi5wb3MpOwogICAgICAgICAgZWxzZSBpZiAodGFnID09PSA3KQogICAgICAgICAgICAgIG9iai5nZW9tZXRyeVR5cGUgPSBwYmYucmVhZFZhcmludCgpOwogICAgICAgICAgZWxzZSBpZiAodGFnID09PSA4KQogICAgICAgICAgICAgIG9iai5zcGF0aWFsUmVmZXJlbmNlID0gRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlNwYXRpYWxSZWZlcmVuY2UucmVhZChwYmYsIHBiZi5yZWFkVmFyaW50KCkgKyBwYmYucG9zKTsKICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gOSkKICAgICAgICAgICAgICBvYmouZXhjZWVkZWRUcmFuc2ZlckxpbWl0ID0gcGJmLnJlYWRCb29sZWFuKCk7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDEwKQogICAgICAgICAgICAgIG9iai5oYXNaID0gcGJmLnJlYWRCb29sZWFuKCk7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDExKQogICAgICAgICAgICAgIG9iai5oYXNNID0gcGJmLnJlYWRCb29sZWFuKCk7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDEyKQogICAgICAgICAgICAgIG9iai50cmFuc2Zvcm0gPSBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVHJhbnNmb3JtLnJlYWQocGJmLCBwYmYucmVhZFZhcmludCgpICsgcGJmLnBvcyk7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDEzKQogICAgICAgICAgICAgIG9iai5maWVsZHMucHVzaChGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuRmllbGQucmVhZChwYmYsIHBiZi5yZWFkVmFyaW50KCkgKyBwYmYucG9zKSk7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDE0KQogICAgICAgICAgICAgIG9iai52YWx1ZXMucHVzaChGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVmFsdWUucmVhZChwYmYsIHBiZi5yZWFkVmFyaW50KCkgKyBwYmYucG9zKSk7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDE1KQogICAgICAgICAgICAgIG9iai5mZWF0dXJlcy5wdXNoKEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5GZWF0dXJlLnJlYWQocGJmLCBwYmYucmVhZFZhcmludCgpICsgcGJmLnBvcykpOwogICAgICB9OwogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuRmVhdHVyZVJlc3VsdC53cml0ZSA9IGZ1bmN0aW9uIChvYmosIHBiZikgewogICAgICAgICAgaWYgKG9iai5vYmplY3RJZEZpZWxkTmFtZSkKICAgICAgICAgICAgICBwYmYud3JpdGVTdHJpbmdGaWVsZCgxLCBvYmoub2JqZWN0SWRGaWVsZE5hbWUpOwogICAgICAgICAgaWYgKG9iai51bmlxdWVJZEZpZWxkKQogICAgICAgICAgICAgIHBiZi53cml0ZU1lc3NhZ2UoMiwgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlVuaXF1ZUlkRmllbGQud3JpdGUsIG9iai51bmlxdWVJZEZpZWxkKTsKICAgICAgICAgIGlmIChvYmouZ2xvYmFsSWRGaWVsZE5hbWUpCiAgICAgICAgICAgICAgcGJmLndyaXRlU3RyaW5nRmllbGQoMywgb2JqLmdsb2JhbElkRmllbGROYW1lKTsKICAgICAgICAgIGlmIChvYmouZ2VvaGFzaEZpZWxkTmFtZSkKICAgICAgICAgICAgICBwYmYud3JpdGVTdHJpbmdGaWVsZCg0LCBvYmouZ2VvaGFzaEZpZWxkTmFtZSk7CiAgICAgICAgICBpZiAob2JqLmdlb21ldHJ5UHJvcGVydGllcykKICAgICAgICAgICAgICBwYmYud3JpdGVNZXNzYWdlKDUsIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5HZW9tZXRyeVByb3BlcnRpZXMud3JpdGUsIG9iai5nZW9tZXRyeVByb3BlcnRpZXMpOwogICAgICAgICAgaWYgKG9iai5zZXJ2ZXJHZW5zKQogICAgICAgICAgICAgIHBiZi53cml0ZU1lc3NhZ2UoNiwgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlNlcnZlckdlbnMud3JpdGUsIG9iai5zZXJ2ZXJHZW5zKTsKICAgICAgICAgIGlmIChvYmouZ2VvbWV0cnlUeXBlKQogICAgICAgICAgICAgIHBiZi53cml0ZVZhcmludEZpZWxkKDcsIG9iai5nZW9tZXRyeVR5cGUpOwogICAgICAgICAgaWYgKG9iai5zcGF0aWFsUmVmZXJlbmNlKQogICAgICAgICAgICAgIHBiZi53cml0ZU1lc3NhZ2UoOCwgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlNwYXRpYWxSZWZlcmVuY2Uud3JpdGUsIG9iai5zcGF0aWFsUmVmZXJlbmNlKTsKICAgICAgICAgIGlmIChvYmouZXhjZWVkZWRUcmFuc2ZlckxpbWl0KQogICAgICAgICAgICAgIHBiZi53cml0ZUJvb2xlYW5GaWVsZCg5LCBvYmouZXhjZWVkZWRUcmFuc2ZlckxpbWl0KTsKICAgICAgICAgIGlmIChvYmouaGFzWikKICAgICAgICAgICAgICBwYmYud3JpdGVCb29sZWFuRmllbGQoMTAsIG9iai5oYXNaKTsKICAgICAgICAgIGlmIChvYmouaGFzTSkKICAgICAgICAgICAgICBwYmYud3JpdGVCb29sZWFuRmllbGQoMTEsIG9iai5oYXNNKTsKICAgICAgICAgIGlmIChvYmoudHJhbnNmb3JtKQogICAgICAgICAgICAgIHBiZi53cml0ZU1lc3NhZ2UoMTIsIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5UcmFuc2Zvcm0ud3JpdGUsIG9iai50cmFuc2Zvcm0pOwogICAgICAgICAgaWYgKG9iai5maWVsZHMpCiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmouZmllbGRzLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgICBwYmYud3JpdGVNZXNzYWdlKDEzLCBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuRmllbGQud3JpdGUsIG9iai5maWVsZHNbaV0pOwogICAgICAgICAgaWYgKG9iai52YWx1ZXMpCiAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG9iai52YWx1ZXMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgIHBiZi53cml0ZU1lc3NhZ2UoMTQsIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5WYWx1ZS53cml0ZSwgb2JqLnZhbHVlc1tpXSk7CiAgICAgICAgICBpZiAob2JqLmZlYXR1cmVzKQogICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBvYmouZmVhdHVyZXMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgIHBiZi53cml0ZU1lc3NhZ2UoMTUsIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5GZWF0dXJlLndyaXRlLCBvYmouZmVhdHVyZXNbaV0pOwogICAgICB9OwogICAgICAvLyBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuQ291bnRSZXN1bHQgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuQ291bnRSZXN1bHQgPSB7fTsKICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkNvdW50UmVzdWx0LnJlYWQgPSBmdW5jdGlvbiAocGJmLCBlbmQpIHsKICAgICAgICAgIHJldHVybiBwYmYucmVhZEZpZWxkcyhGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuQ291bnRSZXN1bHQuX3JlYWRGaWVsZCwgeyBjb3VudDogMCB9LCBlbmQpOwogICAgICB9OwogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuQ291bnRSZXN1bHQuX3JlYWRGaWVsZCA9IGZ1bmN0aW9uICh0YWcsIG9iaiwgcGJmKSB7CiAgICAgICAgICBpZiAodGFnID09PSAxKQogICAgICAgICAgICAgIG9iai5jb3VudCA9IHBiZi5yZWFkVmFyaW50KCk7CiAgICAgIH07CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5Db3VudFJlc3VsdC53cml0ZSA9IGZ1bmN0aW9uIChvYmosIHBiZikgewogICAgICAgICAgaWYgKG9iai5jb3VudCkKICAgICAgICAgICAgICBwYmYud3JpdGVWYXJpbnRGaWVsZCgxLCBvYmouY291bnQpOwogICAgICB9OwogICAgICAvLyBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuT2JqZWN0SWRzUmVzdWx0ID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLk9iamVjdElkc1Jlc3VsdCA9IHt9OwogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuT2JqZWN0SWRzUmVzdWx0LnJlYWQgPSBmdW5jdGlvbiAocGJmLCBlbmQpIHsKICAgICAgICAgIHJldHVybiBwYmYucmVhZEZpZWxkcyhGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuT2JqZWN0SWRzUmVzdWx0Ll9yZWFkRmllbGQsIHsgb2JqZWN0SWRGaWVsZE5hbWU6ICIiLCBzZXJ2ZXJHZW5zOiBudWxsLCBvYmplY3RJZHM6IFtdIH0sIGVuZCk7CiAgICAgIH07CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5PYmplY3RJZHNSZXN1bHQuX3JlYWRGaWVsZCA9IGZ1bmN0aW9uICh0YWcsIG9iaiwgcGJmKSB7CiAgICAgICAgICBpZiAodGFnID09PSAxKQogICAgICAgICAgICAgIG9iai5vYmplY3RJZEZpZWxkTmFtZSA9IHBiZi5yZWFkU3RyaW5nKCk7CiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDIpCiAgICAgICAgICAgICAgb2JqLnNlcnZlckdlbnMgPSBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuU2VydmVyR2Vucy5yZWFkKHBiZiwgcGJmLnJlYWRWYXJpbnQoKSArIHBiZi5wb3MpOwogICAgICAgICAgZWxzZSBpZiAodGFnID09PSAzKQogICAgICAgICAgICAgIHBiZi5yZWFkUGFja2VkVmFyaW50KG9iai5vYmplY3RJZHMpOwogICAgICB9OwogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuT2JqZWN0SWRzUmVzdWx0LndyaXRlID0gZnVuY3Rpb24gKG9iaiwgcGJmKSB7CiAgICAgICAgICBpZiAob2JqLm9iamVjdElkRmllbGROYW1lKQogICAgICAgICAgICAgIHBiZi53cml0ZVN0cmluZ0ZpZWxkKDEsIG9iai5vYmplY3RJZEZpZWxkTmFtZSk7CiAgICAgICAgICBpZiAob2JqLnNlcnZlckdlbnMpCiAgICAgICAgICAgICAgcGJmLndyaXRlTWVzc2FnZSgyLCBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuU2VydmVyR2Vucy53cml0ZSwgb2JqLnNlcnZlckdlbnMpOwogICAgICAgICAgaWYgKG9iai5vYmplY3RJZHMpCiAgICAgICAgICAgICAgcGJmLndyaXRlUGFja2VkVmFyaW50KDMsIG9iai5vYmplY3RJZHMpOwogICAgICB9OwogICAgICAvLyBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuUXVlcnlSZXN1bHQgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuUXVlcnlSZXN1bHQgPSB7fTsKICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlF1ZXJ5UmVzdWx0LnJlYWQgPSBmdW5jdGlvbiAocGJmLCBlbmQpIHsKICAgICAgICAgIHJldHVybiBwYmYucmVhZEZpZWxkcyhGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuUXVlcnlSZXN1bHQuX3JlYWRGaWVsZCwgeyBmZWF0dXJlUmVzdWx0OiBudWxsLCBSZXN1bHRzOiBudWxsLCBjb3VudFJlc3VsdDogbnVsbCwgaWRzUmVzdWx0OiBudWxsIH0sIGVuZCk7CiAgICAgIH07CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5RdWVyeVJlc3VsdC5fcmVhZEZpZWxkID0gZnVuY3Rpb24gKHRhZywgb2JqLCBwYmYpIHsKICAgICAgICAgIGlmICh0YWcgPT09IDEpCiAgICAgICAgICAgICAgb2JqLmZlYXR1cmVSZXN1bHQgPSBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuRmVhdHVyZVJlc3VsdC5yZWFkKHBiZiwgcGJmLnJlYWRWYXJpbnQoKSArIHBiZi5wb3MpLCBvYmouUmVzdWx0cyA9ICJmZWF0dXJlUmVzdWx0IjsKICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gMikKICAgICAgICAgICAgICBvYmouY291bnRSZXN1bHQgPSBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuQ291bnRSZXN1bHQucmVhZChwYmYsIHBiZi5yZWFkVmFyaW50KCkgKyBwYmYucG9zKSwgb2JqLlJlc3VsdHMgPSAiY291bnRSZXN1bHQiOwogICAgICAgICAgZWxzZSBpZiAodGFnID09PSAzKQogICAgICAgICAgICAgIG9iai5pZHNSZXN1bHQgPSBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuT2JqZWN0SWRzUmVzdWx0LnJlYWQocGJmLCBwYmYucmVhZFZhcmludCgpICsgcGJmLnBvcyksIG9iai5SZXN1bHRzID0gImlkc1Jlc3VsdCI7CiAgICAgIH07CiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5RdWVyeVJlc3VsdC53cml0ZSA9IGZ1bmN0aW9uIChvYmosIHBiZikgewogICAgICAgICAgaWYgKG9iai5mZWF0dXJlUmVzdWx0KQogICAgICAgICAgICAgIHBiZi53cml0ZU1lc3NhZ2UoMSwgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkZlYXR1cmVSZXN1bHQud3JpdGUsIG9iai5mZWF0dXJlUmVzdWx0KTsKICAgICAgICAgIGlmIChvYmouY291bnRSZXN1bHQpCiAgICAgICAgICAgICAgcGJmLndyaXRlTWVzc2FnZSgyLCBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuQ291bnRSZXN1bHQud3JpdGUsIG9iai5jb3VudFJlc3VsdCk7CiAgICAgICAgICBpZiAob2JqLmlkc1Jlc3VsdCkKICAgICAgICAgICAgICBwYmYud3JpdGVNZXNzYWdlKDMsIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5PYmplY3RJZHNSZXN1bHQud3JpdGUsIG9iai5pZHNSZXN1bHQpOwogICAgICB9OwogICAgICByZXR1cm4gRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyOwogIH0KCiAgZnVuY3Rpb24gZ2V0RGVmYXVsdEV4cG9ydEZyb21DanMgKHgpIHsKICAJcmV0dXJuIHggJiYgeC5fX2VzTW9kdWxlICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh4LCAnZGVmYXVsdCcpID8geFsnZGVmYXVsdCddIDogeDsKICB9CgogIHZhciBpZWVlNzU0JDEgPSB7fTsKCiAgLyohIGllZWU3NTQuIEJTRC0zLUNsYXVzZSBMaWNlbnNlLiBGZXJvc3MgQWJvdWtoYWRpamVoIDxodHRwczovL2Zlcm9zcy5vcmcvb3BlbnNvdXJjZT4gKi8KCiAgaWVlZTc1NCQxLnJlYWQgPSBmdW5jdGlvbiAoYnVmZmVyLCBvZmZzZXQsIGlzTEUsIG1MZW4sIG5CeXRlcykgewogICAgdmFyIGUsIG07CiAgICB2YXIgZUxlbiA9IChuQnl0ZXMgKiA4KSAtIG1MZW4gLSAxOwogICAgdmFyIGVNYXggPSAoMSA8PCBlTGVuKSAtIDE7CiAgICB2YXIgZUJpYXMgPSBlTWF4ID4+IDE7CiAgICB2YXIgbkJpdHMgPSAtNzsKICAgIHZhciBpID0gaXNMRSA/IChuQnl0ZXMgLSAxKSA6IDA7CiAgICB2YXIgZCA9IGlzTEUgPyAtMSA6IDE7CiAgICB2YXIgcyA9IGJ1ZmZlcltvZmZzZXQgKyBpXTsKCiAgICBpICs9IGQ7CgogICAgZSA9IHMgJiAoKDEgPDwgKC1uQml0cykpIC0gMSk7CiAgICBzID4+PSAoLW5CaXRzKTsKICAgIG5CaXRzICs9IGVMZW47CiAgICBmb3IgKDsgbkJpdHMgPiAwOyBlID0gKGUgKiAyNTYpICsgYnVmZmVyW29mZnNldCArIGldLCBpICs9IGQsIG5CaXRzIC09IDgpIHt9CgogICAgbSA9IGUgJiAoKDEgPDwgKC1uQml0cykpIC0gMSk7CiAgICBlID4+PSAoLW5CaXRzKTsKICAgIG5CaXRzICs9IG1MZW47CiAgICBmb3IgKDsgbkJpdHMgPiAwOyBtID0gKG0gKiAyNTYpICsgYnVmZmVyW29mZnNldCArIGldLCBpICs9IGQsIG5CaXRzIC09IDgpIHt9CgogICAgaWYgKGUgPT09IDApIHsKICAgICAgZSA9IDEgLSBlQmlhczsKICAgIH0gZWxzZSBpZiAoZSA9PT0gZU1heCkgewogICAgICByZXR1cm4gbSA/IE5hTiA6ICgocyA/IC0xIDogMSkgKiBJbmZpbml0eSkKICAgIH0gZWxzZSB7CiAgICAgIG0gPSBtICsgTWF0aC5wb3coMiwgbUxlbik7CiAgICAgIGUgPSBlIC0gZUJpYXM7CiAgICB9CiAgICByZXR1cm4gKHMgPyAtMSA6IDEpICogbSAqIE1hdGgucG93KDIsIGUgLSBtTGVuKQogIH07CgogIGllZWU3NTQkMS53cml0ZSA9IGZ1bmN0aW9uIChidWZmZXIsIHZhbHVlLCBvZmZzZXQsIGlzTEUsIG1MZW4sIG5CeXRlcykgewogICAgdmFyIGUsIG0sIGM7CiAgICB2YXIgZUxlbiA9IChuQnl0ZXMgKiA4KSAtIG1MZW4gLSAxOwogICAgdmFyIGVNYXggPSAoMSA8PCBlTGVuKSAtIDE7CiAgICB2YXIgZUJpYXMgPSBlTWF4ID4+IDE7CiAgICB2YXIgcnQgPSAobUxlbiA9PT0gMjMgPyBNYXRoLnBvdygyLCAtMjQpIC0gTWF0aC5wb3coMiwgLTc3KSA6IDApOwogICAgdmFyIGkgPSBpc0xFID8gMCA6IChuQnl0ZXMgLSAxKTsKICAgIHZhciBkID0gaXNMRSA/IDEgOiAtMTsKICAgIHZhciBzID0gdmFsdWUgPCAwIHx8ICh2YWx1ZSA9PT0gMCAmJiAxIC8gdmFsdWUgPCAwKSA/IDEgOiAwOwoKICAgIHZhbHVlID0gTWF0aC5hYnModmFsdWUpOwoKICAgIGlmIChpc05hTih2YWx1ZSkgfHwgdmFsdWUgPT09IEluZmluaXR5KSB7CiAgICAgIG0gPSBpc05hTih2YWx1ZSkgPyAxIDogMDsKICAgICAgZSA9IGVNYXg7CiAgICB9IGVsc2UgewogICAgICBlID0gTWF0aC5mbG9vcihNYXRoLmxvZyh2YWx1ZSkgLyBNYXRoLkxOMik7CiAgICAgIGlmICh2YWx1ZSAqIChjID0gTWF0aC5wb3coMiwgLWUpKSA8IDEpIHsKICAgICAgICBlLS07CiAgICAgICAgYyAqPSAyOwogICAgICB9CiAgICAgIGlmIChlICsgZUJpYXMgPj0gMSkgewogICAgICAgIHZhbHVlICs9IHJ0IC8gYzsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YWx1ZSArPSBydCAqIE1hdGgucG93KDIsIDEgLSBlQmlhcyk7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlICogYyA+PSAyKSB7CiAgICAgICAgZSsrOwogICAgICAgIGMgLz0gMjsKICAgICAgfQoKICAgICAgaWYgKGUgKyBlQmlhcyA+PSBlTWF4KSB7CiAgICAgICAgbSA9IDA7CiAgICAgICAgZSA9IGVNYXg7CiAgICAgIH0gZWxzZSBpZiAoZSArIGVCaWFzID49IDEpIHsKICAgICAgICBtID0gKCh2YWx1ZSAqIGMpIC0gMSkgKiBNYXRoLnBvdygyLCBtTGVuKTsKICAgICAgICBlID0gZSArIGVCaWFzOwogICAgICB9IGVsc2UgewogICAgICAgIG0gPSB2YWx1ZSAqIE1hdGgucG93KDIsIGVCaWFzIC0gMSkgKiBNYXRoLnBvdygyLCBtTGVuKTsKICAgICAgICBlID0gMDsKICAgICAgfQogICAgfQoKICAgIGZvciAoOyBtTGVuID49IDg7IGJ1ZmZlcltvZmZzZXQgKyBpXSA9IG0gJiAweGZmLCBpICs9IGQsIG0gLz0gMjU2LCBtTGVuIC09IDgpIHt9CgogICAgZSA9IChlIDw8IG1MZW4pIHwgbTsKICAgIGVMZW4gKz0gbUxlbjsKICAgIGZvciAoOyBlTGVuID4gMDsgYnVmZmVyW29mZnNldCArIGldID0gZSAmIDB4ZmYsIGkgKz0gZCwgZSAvPSAyNTYsIGVMZW4gLT0gOCkge30KCiAgICBidWZmZXJbb2Zmc2V0ICsgaSAtIGRdIHw9IHMgKiAxMjg7CiAgfTsKCiAgdmFyIHBiZiA9IFBiZjsKCiAgdmFyIGllZWU3NTQgPSBpZWVlNzU0JDE7CgogIGZ1bmN0aW9uIFBiZihidWYpIHsKICAgICAgdGhpcy5idWYgPSBBcnJheUJ1ZmZlci5pc1ZpZXcgJiYgQXJyYXlCdWZmZXIuaXNWaWV3KGJ1ZikgPyBidWYgOiBuZXcgVWludDhBcnJheShidWYgfHwgMCk7CiAgICAgIHRoaXMucG9zID0gMDsKICAgICAgdGhpcy50eXBlID0gMDsKICAgICAgdGhpcy5sZW5ndGggPSB0aGlzLmJ1Zi5sZW5ndGg7CiAgfQoKICBQYmYuVmFyaW50ICA9IDA7IC8vIHZhcmludDogaW50MzIsIGludDY0LCB1aW50MzIsIHVpbnQ2NCwgc2ludDMyLCBzaW50NjQsIGJvb2wsIGVudW0KICBQYmYuRml4ZWQ2NCA9IDE7IC8vIDY0LWJpdDogZG91YmxlLCBmaXhlZDY0LCBzZml4ZWQ2NAogIFBiZi5CeXRlcyAgID0gMjsgLy8gbGVuZ3RoLWRlbGltaXRlZDogc3RyaW5nLCBieXRlcywgZW1iZWRkZWQgbWVzc2FnZXMsIHBhY2tlZCByZXBlYXRlZCBmaWVsZHMKICBQYmYuRml4ZWQzMiA9IDU7IC8vIDMyLWJpdDogZmxvYXQsIGZpeGVkMzIsIHNmaXhlZDMyCgogIHZhciBTSElGVF9MRUZUXzMyID0gKDEgPDwgMTYpICogKDEgPDwgMTYpLAogICAgICBTSElGVF9SSUdIVF8zMiA9IDEgLyBTSElGVF9MRUZUXzMyOwoKICAvLyBUaHJlc2hvbGQgY2hvc2VuIGJhc2VkIG9uIGJvdGggYmVuY2htYXJraW5nIGFuZCBrbm93bGVkZ2UgYWJvdXQgYnJvd3NlciBzdHJpbmcKICAvLyBkYXRhIHN0cnVjdHVyZXMgKHdoaWNoIGN1cnJlbnRseSBzd2l0Y2ggc3RydWN0dXJlIHR5cGVzIGF0IDEyIGJ5dGVzIG9yIG1vcmUpCiAgdmFyIFRFWFRfREVDT0RFUl9NSU5fTEVOR1RIID0gMTI7CiAgdmFyIHV0ZjhUZXh0RGVjb2RlciA9IHR5cGVvZiBUZXh0RGVjb2RlciA9PT0gJ3VuZGVmaW5lZCcgPyBudWxsIDogbmV3IFRleHREZWNvZGVyKCd1dGY4Jyk7CgogIFBiZi5wcm90b3R5cGUgPSB7CgogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgIHRoaXMuYnVmID0gbnVsbDsKICAgICAgfSwKCiAgICAgIC8vID09PSBSRUFESU5HID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgogICAgICByZWFkRmllbGRzOiBmdW5jdGlvbihyZWFkRmllbGQsIHJlc3VsdCwgZW5kKSB7CiAgICAgICAgICBlbmQgPSBlbmQgfHwgdGhpcy5sZW5ndGg7CgogICAgICAgICAgd2hpbGUgKHRoaXMucG9zIDwgZW5kKSB7CiAgICAgICAgICAgICAgdmFyIHZhbCA9IHRoaXMucmVhZFZhcmludCgpLAogICAgICAgICAgICAgICAgICB0YWcgPSB2YWwgPj4gMywKICAgICAgICAgICAgICAgICAgc3RhcnRQb3MgPSB0aGlzLnBvczsKCiAgICAgICAgICAgICAgdGhpcy50eXBlID0gdmFsICYgMHg3OwogICAgICAgICAgICAgIHJlYWRGaWVsZCh0YWcsIHJlc3VsdCwgdGhpcyk7CgogICAgICAgICAgICAgIGlmICh0aGlzLnBvcyA9PT0gc3RhcnRQb3MpIHRoaXMuc2tpcCh2YWwpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfSwKCiAgICAgIHJlYWRNZXNzYWdlOiBmdW5jdGlvbihyZWFkRmllbGQsIHJlc3VsdCkgewogICAgICAgICAgcmV0dXJuIHRoaXMucmVhZEZpZWxkcyhyZWFkRmllbGQsIHJlc3VsdCwgdGhpcy5yZWFkVmFyaW50KCkgKyB0aGlzLnBvcyk7CiAgICAgIH0sCgogICAgICByZWFkRml4ZWQzMjogZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgdmFsID0gcmVhZFVJbnQzMih0aGlzLmJ1ZiwgdGhpcy5wb3MpOwogICAgICAgICAgdGhpcy5wb3MgKz0gNDsKICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgIH0sCgogICAgICByZWFkU0ZpeGVkMzI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHZhbCA9IHJlYWRJbnQzMih0aGlzLmJ1ZiwgdGhpcy5wb3MpOwogICAgICAgICAgdGhpcy5wb3MgKz0gNDsKICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgIH0sCgogICAgICAvLyA2NC1iaXQgaW50IGhhbmRsaW5nIGlzIGJhc2VkIG9uIGdpdGh1Yi5jb20vZHB3L25vZGUtYnVmZmVyLW1vcmUtaW50cyAoTUlULWxpY2Vuc2VkKQoKICAgICAgcmVhZEZpeGVkNjQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHZhbCA9IHJlYWRVSW50MzIodGhpcy5idWYsIHRoaXMucG9zKSArIHJlYWRVSW50MzIodGhpcy5idWYsIHRoaXMucG9zICsgNCkgKiBTSElGVF9MRUZUXzMyOwogICAgICAgICAgdGhpcy5wb3MgKz0gODsKICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgIH0sCgogICAgICByZWFkU0ZpeGVkNjQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHZhbCA9IHJlYWRVSW50MzIodGhpcy5idWYsIHRoaXMucG9zKSArIHJlYWRJbnQzMih0aGlzLmJ1ZiwgdGhpcy5wb3MgKyA0KSAqIFNISUZUX0xFRlRfMzI7CiAgICAgICAgICB0aGlzLnBvcyArPSA4OwogICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgfSwKCiAgICAgIHJlYWRGbG9hdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgdmFsID0gaWVlZTc1NC5yZWFkKHRoaXMuYnVmLCB0aGlzLnBvcywgdHJ1ZSwgMjMsIDQpOwogICAgICAgICAgdGhpcy5wb3MgKz0gNDsKICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgIH0sCgogICAgICByZWFkRG91YmxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciB2YWwgPSBpZWVlNzU0LnJlYWQodGhpcy5idWYsIHRoaXMucG9zLCB0cnVlLCA1MiwgOCk7CiAgICAgICAgICB0aGlzLnBvcyArPSA4OwogICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgfSwKCiAgICAgIHJlYWRWYXJpbnQ6IGZ1bmN0aW9uKGlzU2lnbmVkKSB7CiAgICAgICAgICB2YXIgYnVmID0gdGhpcy5idWYsCiAgICAgICAgICAgICAgdmFsLCBiOwoKICAgICAgICAgIGIgPSBidWZbdGhpcy5wb3MrK107IHZhbCAgPSAgYiAmIDB4N2Y7ICAgICAgICBpZiAoYiA8IDB4ODApIHJldHVybiB2YWw7CiAgICAgICAgICBiID0gYnVmW3RoaXMucG9zKytdOyB2YWwgfD0gKGIgJiAweDdmKSA8PCA3OyAgaWYgKGIgPCAweDgwKSByZXR1cm4gdmFsOwogICAgICAgICAgYiA9IGJ1Zlt0aGlzLnBvcysrXTsgdmFsIHw9IChiICYgMHg3ZikgPDwgMTQ7IGlmIChiIDwgMHg4MCkgcmV0dXJuIHZhbDsKICAgICAgICAgIGIgPSBidWZbdGhpcy5wb3MrK107IHZhbCB8PSAoYiAmIDB4N2YpIDw8IDIxOyBpZiAoYiA8IDB4ODApIHJldHVybiB2YWw7CiAgICAgICAgICBiID0gYnVmW3RoaXMucG9zXTsgICB2YWwgfD0gKGIgJiAweDBmKSA8PCAyODsKCiAgICAgICAgICByZXR1cm4gcmVhZFZhcmludFJlbWFpbmRlcih2YWwsIGlzU2lnbmVkLCB0aGlzKTsKICAgICAgfSwKCiAgICAgIHJlYWRWYXJpbnQ2NDogZnVuY3Rpb24oKSB7IC8vIGZvciBjb21wYXRpYmlsaXR5IHdpdGggdjIuMC4xCiAgICAgICAgICByZXR1cm4gdGhpcy5yZWFkVmFyaW50KHRydWUpOwogICAgICB9LAoKICAgICAgcmVhZFNWYXJpbnQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIG51bSA9IHRoaXMucmVhZFZhcmludCgpOwogICAgICAgICAgcmV0dXJuIG51bSAlIDIgPT09IDEgPyAobnVtICsgMSkgLyAtMiA6IG51bSAvIDI7IC8vIHppZ3phZyBlbmNvZGluZwogICAgICB9LAoKICAgICAgcmVhZEJvb2xlYW46IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIEJvb2xlYW4odGhpcy5yZWFkVmFyaW50KCkpOwogICAgICB9LAoKICAgICAgcmVhZFN0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgZW5kID0gdGhpcy5yZWFkVmFyaW50KCkgKyB0aGlzLnBvczsKICAgICAgICAgIHZhciBwb3MgPSB0aGlzLnBvczsKICAgICAgICAgIHRoaXMucG9zID0gZW5kOwoKICAgICAgICAgIGlmIChlbmQgLSBwb3MgPj0gVEVYVF9ERUNPREVSX01JTl9MRU5HVEggJiYgdXRmOFRleHREZWNvZGVyKSB7CiAgICAgICAgICAgICAgLy8gbG9uZ2VyIHN0cmluZ3MgYXJlIGZhc3Qgd2l0aCB0aGUgYnVpbHQtaW4gYnJvd3NlciBUZXh0RGVjb2RlciBBUEkKICAgICAgICAgICAgICByZXR1cm4gcmVhZFV0ZjhUZXh0RGVjb2Rlcih0aGlzLmJ1ZiwgcG9zLCBlbmQpOwogICAgICAgICAgfQogICAgICAgICAgLy8gc2hvcnQgc3RyaW5ncyBhcmUgZmFzdCB3aXRoIG91ciBjdXN0b20gaW1wbGVtZW50YXRpb24KICAgICAgICAgIHJldHVybiByZWFkVXRmOCh0aGlzLmJ1ZiwgcG9zLCBlbmQpOwogICAgICB9LAoKICAgICAgcmVhZEJ5dGVzOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBlbmQgPSB0aGlzLnJlYWRWYXJpbnQoKSArIHRoaXMucG9zLAogICAgICAgICAgICAgIGJ1ZmZlciA9IHRoaXMuYnVmLnN1YmFycmF5KHRoaXMucG9zLCBlbmQpOwogICAgICAgICAgdGhpcy5wb3MgPSBlbmQ7CiAgICAgICAgICByZXR1cm4gYnVmZmVyOwogICAgICB9LAoKICAgICAgLy8gdmVyYm9zZSBmb3IgcGVyZm9ybWFuY2UgcmVhc29uczsgZG9lc24ndCBhZmZlY3QgZ3ppcHBlZCBzaXplCgogICAgICByZWFkUGFja2VkVmFyaW50OiBmdW5jdGlvbihhcnIsIGlzU2lnbmVkKSB7CiAgICAgICAgICBpZiAodGhpcy50eXBlICE9PSBQYmYuQnl0ZXMpIHJldHVybiBhcnIucHVzaCh0aGlzLnJlYWRWYXJpbnQoaXNTaWduZWQpKTsKICAgICAgICAgIHZhciBlbmQgPSByZWFkUGFja2VkRW5kKHRoaXMpOwogICAgICAgICAgYXJyID0gYXJyIHx8IFtdOwogICAgICAgICAgd2hpbGUgKHRoaXMucG9zIDwgZW5kKSBhcnIucHVzaCh0aGlzLnJlYWRWYXJpbnQoaXNTaWduZWQpKTsKICAgICAgICAgIHJldHVybiBhcnI7CiAgICAgIH0sCiAgICAgIHJlYWRQYWNrZWRTVmFyaW50OiBmdW5jdGlvbihhcnIpIHsKICAgICAgICAgIGlmICh0aGlzLnR5cGUgIT09IFBiZi5CeXRlcykgcmV0dXJuIGFyci5wdXNoKHRoaXMucmVhZFNWYXJpbnQoKSk7CiAgICAgICAgICB2YXIgZW5kID0gcmVhZFBhY2tlZEVuZCh0aGlzKTsKICAgICAgICAgIGFyciA9IGFyciB8fCBbXTsKICAgICAgICAgIHdoaWxlICh0aGlzLnBvcyA8IGVuZCkgYXJyLnB1c2godGhpcy5yZWFkU1ZhcmludCgpKTsKICAgICAgICAgIHJldHVybiBhcnI7CiAgICAgIH0sCiAgICAgIHJlYWRQYWNrZWRCb29sZWFuOiBmdW5jdGlvbihhcnIpIHsKICAgICAgICAgIGlmICh0aGlzLnR5cGUgIT09IFBiZi5CeXRlcykgcmV0dXJuIGFyci5wdXNoKHRoaXMucmVhZEJvb2xlYW4oKSk7CiAgICAgICAgICB2YXIgZW5kID0gcmVhZFBhY2tlZEVuZCh0aGlzKTsKICAgICAgICAgIGFyciA9IGFyciB8fCBbXTsKICAgICAgICAgIHdoaWxlICh0aGlzLnBvcyA8IGVuZCkgYXJyLnB1c2godGhpcy5yZWFkQm9vbGVhbigpKTsKICAgICAgICAgIHJldHVybiBhcnI7CiAgICAgIH0sCiAgICAgIHJlYWRQYWNrZWRGbG9hdDogZnVuY3Rpb24oYXJyKSB7CiAgICAgICAgICBpZiAodGhpcy50eXBlICE9PSBQYmYuQnl0ZXMpIHJldHVybiBhcnIucHVzaCh0aGlzLnJlYWRGbG9hdCgpKTsKICAgICAgICAgIHZhciBlbmQgPSByZWFkUGFja2VkRW5kKHRoaXMpOwogICAgICAgICAgYXJyID0gYXJyIHx8IFtdOwogICAgICAgICAgd2hpbGUgKHRoaXMucG9zIDwgZW5kKSBhcnIucHVzaCh0aGlzLnJlYWRGbG9hdCgpKTsKICAgICAgICAgIHJldHVybiBhcnI7CiAgICAgIH0sCiAgICAgIHJlYWRQYWNrZWREb3VibGU6IGZ1bmN0aW9uKGFycikgewogICAgICAgICAgaWYgKHRoaXMudHlwZSAhPT0gUGJmLkJ5dGVzKSByZXR1cm4gYXJyLnB1c2godGhpcy5yZWFkRG91YmxlKCkpOwogICAgICAgICAgdmFyIGVuZCA9IHJlYWRQYWNrZWRFbmQodGhpcyk7CiAgICAgICAgICBhcnIgPSBhcnIgfHwgW107CiAgICAgICAgICB3aGlsZSAodGhpcy5wb3MgPCBlbmQpIGFyci5wdXNoKHRoaXMucmVhZERvdWJsZSgpKTsKICAgICAgICAgIHJldHVybiBhcnI7CiAgICAgIH0sCiAgICAgIHJlYWRQYWNrZWRGaXhlZDMyOiBmdW5jdGlvbihhcnIpIHsKICAgICAgICAgIGlmICh0aGlzLnR5cGUgIT09IFBiZi5CeXRlcykgcmV0dXJuIGFyci5wdXNoKHRoaXMucmVhZEZpeGVkMzIoKSk7CiAgICAgICAgICB2YXIgZW5kID0gcmVhZFBhY2tlZEVuZCh0aGlzKTsKICAgICAgICAgIGFyciA9IGFyciB8fCBbXTsKICAgICAgICAgIHdoaWxlICh0aGlzLnBvcyA8IGVuZCkgYXJyLnB1c2godGhpcy5yZWFkRml4ZWQzMigpKTsKICAgICAgICAgIHJldHVybiBhcnI7CiAgICAgIH0sCiAgICAgIHJlYWRQYWNrZWRTRml4ZWQzMjogZnVuY3Rpb24oYXJyKSB7CiAgICAgICAgICBpZiAodGhpcy50eXBlICE9PSBQYmYuQnl0ZXMpIHJldHVybiBhcnIucHVzaCh0aGlzLnJlYWRTRml4ZWQzMigpKTsKICAgICAgICAgIHZhciBlbmQgPSByZWFkUGFja2VkRW5kKHRoaXMpOwogICAgICAgICAgYXJyID0gYXJyIHx8IFtdOwogICAgICAgICAgd2hpbGUgKHRoaXMucG9zIDwgZW5kKSBhcnIucHVzaCh0aGlzLnJlYWRTRml4ZWQzMigpKTsKICAgICAgICAgIHJldHVybiBhcnI7CiAgICAgIH0sCiAgICAgIHJlYWRQYWNrZWRGaXhlZDY0OiBmdW5jdGlvbihhcnIpIHsKICAgICAgICAgIGlmICh0aGlzLnR5cGUgIT09IFBiZi5CeXRlcykgcmV0dXJuIGFyci5wdXNoKHRoaXMucmVhZEZpeGVkNjQoKSk7CiAgICAgICAgICB2YXIgZW5kID0gcmVhZFBhY2tlZEVuZCh0aGlzKTsKICAgICAgICAgIGFyciA9IGFyciB8fCBbXTsKICAgICAgICAgIHdoaWxlICh0aGlzLnBvcyA8IGVuZCkgYXJyLnB1c2godGhpcy5yZWFkRml4ZWQ2NCgpKTsKICAgICAgICAgIHJldHVybiBhcnI7CiAgICAgIH0sCiAgICAgIHJlYWRQYWNrZWRTRml4ZWQ2NDogZnVuY3Rpb24oYXJyKSB7CiAgICAgICAgICBpZiAodGhpcy50eXBlICE9PSBQYmYuQnl0ZXMpIHJldHVybiBhcnIucHVzaCh0aGlzLnJlYWRTRml4ZWQ2NCgpKTsKICAgICAgICAgIHZhciBlbmQgPSByZWFkUGFja2VkRW5kKHRoaXMpOwogICAgICAgICAgYXJyID0gYXJyIHx8IFtdOwogICAgICAgICAgd2hpbGUgKHRoaXMucG9zIDwgZW5kKSBhcnIucHVzaCh0aGlzLnJlYWRTRml4ZWQ2NCgpKTsKICAgICAgICAgIHJldHVybiBhcnI7CiAgICAgIH0sCgogICAgICBza2lwOiBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgIHZhciB0eXBlID0gdmFsICYgMHg3OwogICAgICAgICAgaWYgKHR5cGUgPT09IFBiZi5WYXJpbnQpIHdoaWxlICh0aGlzLmJ1Zlt0aGlzLnBvcysrXSA+IDB4N2YpIHt9CiAgICAgICAgICBlbHNlIGlmICh0eXBlID09PSBQYmYuQnl0ZXMpIHRoaXMucG9zID0gdGhpcy5yZWFkVmFyaW50KCkgKyB0aGlzLnBvczsKICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09IFBiZi5GaXhlZDMyKSB0aGlzLnBvcyArPSA0OwogICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gUGJmLkZpeGVkNjQpIHRoaXMucG9zICs9IDg7CiAgICAgICAgICBlbHNlIHRocm93IG5ldyBFcnJvcignVW5pbXBsZW1lbnRlZCB0eXBlOiAnICsgdHlwZSk7CiAgICAgIH0sCgogICAgICAvLyA9PT0gV1JJVElORyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQoKICAgICAgd3JpdGVUYWc6IGZ1bmN0aW9uKHRhZywgdHlwZSkgewogICAgICAgICAgdGhpcy53cml0ZVZhcmludCgodGFnIDw8IDMpIHwgdHlwZSk7CiAgICAgIH0sCgogICAgICByZWFsbG9jOiBmdW5jdGlvbihtaW4pIHsKICAgICAgICAgIHZhciBsZW5ndGggPSB0aGlzLmxlbmd0aCB8fCAxNjsKCiAgICAgICAgICB3aGlsZSAobGVuZ3RoIDwgdGhpcy5wb3MgKyBtaW4pIGxlbmd0aCAqPSAyOwoKICAgICAgICAgIGlmIChsZW5ndGggIT09IHRoaXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgdmFyIGJ1ZiA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCk7CiAgICAgICAgICAgICAgYnVmLnNldCh0aGlzLmJ1Zik7CiAgICAgICAgICAgICAgdGhpcy5idWYgPSBidWY7CiAgICAgICAgICAgICAgdGhpcy5sZW5ndGggPSBsZW5ndGg7CiAgICAgICAgICB9CiAgICAgIH0sCgogICAgICBmaW5pc2g6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhpcy5sZW5ndGggPSB0aGlzLnBvczsKICAgICAgICAgIHRoaXMucG9zID0gMDsKICAgICAgICAgIHJldHVybiB0aGlzLmJ1Zi5zdWJhcnJheSgwLCB0aGlzLmxlbmd0aCk7CiAgICAgIH0sCgogICAgICB3cml0ZUZpeGVkMzI6IGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgdGhpcy5yZWFsbG9jKDQpOwogICAgICAgICAgd3JpdGVJbnQzMih0aGlzLmJ1ZiwgdmFsLCB0aGlzLnBvcyk7CiAgICAgICAgICB0aGlzLnBvcyArPSA0OwogICAgICB9LAoKICAgICAgd3JpdGVTRml4ZWQzMjogZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICB0aGlzLnJlYWxsb2MoNCk7CiAgICAgICAgICB3cml0ZUludDMyKHRoaXMuYnVmLCB2YWwsIHRoaXMucG9zKTsKICAgICAgICAgIHRoaXMucG9zICs9IDQ7CiAgICAgIH0sCgogICAgICB3cml0ZUZpeGVkNjQ6IGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgdGhpcy5yZWFsbG9jKDgpOwogICAgICAgICAgd3JpdGVJbnQzMih0aGlzLmJ1ZiwgdmFsICYgLTEsIHRoaXMucG9zKTsKICAgICAgICAgIHdyaXRlSW50MzIodGhpcy5idWYsIE1hdGguZmxvb3IodmFsICogU0hJRlRfUklHSFRfMzIpLCB0aGlzLnBvcyArIDQpOwogICAgICAgICAgdGhpcy5wb3MgKz0gODsKICAgICAgfSwKCiAgICAgIHdyaXRlU0ZpeGVkNjQ6IGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgdGhpcy5yZWFsbG9jKDgpOwogICAgICAgICAgd3JpdGVJbnQzMih0aGlzLmJ1ZiwgdmFsICYgLTEsIHRoaXMucG9zKTsKICAgICAgICAgIHdyaXRlSW50MzIodGhpcy5idWYsIE1hdGguZmxvb3IodmFsICogU0hJRlRfUklHSFRfMzIpLCB0aGlzLnBvcyArIDQpOwogICAgICAgICAgdGhpcy5wb3MgKz0gODsKICAgICAgfSwKCiAgICAgIHdyaXRlVmFyaW50OiBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgIHZhbCA9ICt2YWwgfHwgMDsKCiAgICAgICAgICBpZiAodmFsID4gMHhmZmZmZmZmIHx8IHZhbCA8IDApIHsKICAgICAgICAgICAgICB3cml0ZUJpZ1ZhcmludCh2YWwsIHRoaXMpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLnJlYWxsb2MoNCk7CgogICAgICAgICAgdGhpcy5idWZbdGhpcy5wb3MrK10gPSAgICAgICAgICAgdmFsICYgMHg3ZiAgfCAodmFsID4gMHg3ZiA/IDB4ODAgOiAwKTsgaWYgKHZhbCA8PSAweDdmKSByZXR1cm47CiAgICAgICAgICB0aGlzLmJ1Zlt0aGlzLnBvcysrXSA9ICgodmFsID4+Pj0gNykgJiAweDdmKSB8ICh2YWwgPiAweDdmID8gMHg4MCA6IDApOyBpZiAodmFsIDw9IDB4N2YpIHJldHVybjsKICAgICAgICAgIHRoaXMuYnVmW3RoaXMucG9zKytdID0gKCh2YWwgPj4+PSA3KSAmIDB4N2YpIHwgKHZhbCA+IDB4N2YgPyAweDgwIDogMCk7IGlmICh2YWwgPD0gMHg3ZikgcmV0dXJuOwogICAgICAgICAgdGhpcy5idWZbdGhpcy5wb3MrK10gPSAgICh2YWwgPj4+IDcpICYgMHg3ZjsKICAgICAgfSwKCiAgICAgIHdyaXRlU1ZhcmludDogZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICB0aGlzLndyaXRlVmFyaW50KHZhbCA8IDAgPyAtdmFsICogMiAtIDEgOiB2YWwgKiAyKTsKICAgICAgfSwKCiAgICAgIHdyaXRlQm9vbGVhbjogZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICB0aGlzLndyaXRlVmFyaW50KEJvb2xlYW4odmFsKSk7CiAgICAgIH0sCgogICAgICB3cml0ZVN0cmluZzogZnVuY3Rpb24oc3RyKSB7CiAgICAgICAgICBzdHIgPSBTdHJpbmcoc3RyKTsKICAgICAgICAgIHRoaXMucmVhbGxvYyhzdHIubGVuZ3RoICogNCk7CgogICAgICAgICAgdGhpcy5wb3MrKzsgLy8gcmVzZXJ2ZSAxIGJ5dGUgZm9yIHNob3J0IHN0cmluZyBsZW5ndGgKCiAgICAgICAgICB2YXIgc3RhcnRQb3MgPSB0aGlzLnBvczsKICAgICAgICAgIC8vIHdyaXRlIHRoZSBzdHJpbmcgZGlyZWN0bHkgdG8gdGhlIGJ1ZmZlciBhbmQgc2VlIGhvdyBtdWNoIHdhcyB3cml0dGVuCiAgICAgICAgICB0aGlzLnBvcyA9IHdyaXRlVXRmOCh0aGlzLmJ1Ziwgc3RyLCB0aGlzLnBvcyk7CiAgICAgICAgICB2YXIgbGVuID0gdGhpcy5wb3MgLSBzdGFydFBvczsKCiAgICAgICAgICBpZiAobGVuID49IDB4ODApIG1ha2VSb29tRm9yRXh0cmFMZW5ndGgoc3RhcnRQb3MsIGxlbiwgdGhpcyk7CgogICAgICAgICAgLy8gZmluYWxseSwgd3JpdGUgdGhlIG1lc3NhZ2UgbGVuZ3RoIGluIHRoZSByZXNlcnZlZCBwbGFjZSBhbmQgcmVzdG9yZSB0aGUgcG9zaXRpb24KICAgICAgICAgIHRoaXMucG9zID0gc3RhcnRQb3MgLSAxOwogICAgICAgICAgdGhpcy53cml0ZVZhcmludChsZW4pOwogICAgICAgICAgdGhpcy5wb3MgKz0gbGVuOwogICAgICB9LAoKICAgICAgd3JpdGVGbG9hdDogZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICB0aGlzLnJlYWxsb2MoNCk7CiAgICAgICAgICBpZWVlNzU0LndyaXRlKHRoaXMuYnVmLCB2YWwsIHRoaXMucG9zLCB0cnVlLCAyMywgNCk7CiAgICAgICAgICB0aGlzLnBvcyArPSA0OwogICAgICB9LAoKICAgICAgd3JpdGVEb3VibGU6IGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgdGhpcy5yZWFsbG9jKDgpOwogICAgICAgICAgaWVlZTc1NC53cml0ZSh0aGlzLmJ1ZiwgdmFsLCB0aGlzLnBvcywgdHJ1ZSwgNTIsIDgpOwogICAgICAgICAgdGhpcy5wb3MgKz0gODsKICAgICAgfSwKCiAgICAgIHdyaXRlQnl0ZXM6IGZ1bmN0aW9uKGJ1ZmZlcikgewogICAgICAgICAgdmFyIGxlbiA9IGJ1ZmZlci5sZW5ndGg7CiAgICAgICAgICB0aGlzLndyaXRlVmFyaW50KGxlbik7CiAgICAgICAgICB0aGlzLnJlYWxsb2MobGVuKTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHRoaXMuYnVmW3RoaXMucG9zKytdID0gYnVmZmVyW2ldOwogICAgICB9LAoKICAgICAgd3JpdGVSYXdNZXNzYWdlOiBmdW5jdGlvbihmbiwgb2JqKSB7CiAgICAgICAgICB0aGlzLnBvcysrOyAvLyByZXNlcnZlIDEgYnl0ZSBmb3Igc2hvcnQgbWVzc2FnZSBsZW5ndGgKCiAgICAgICAgICAvLyB3cml0ZSB0aGUgbWVzc2FnZSBkaXJlY3RseSB0byB0aGUgYnVmZmVyIGFuZCBzZWUgaG93IG11Y2ggd2FzIHdyaXR0ZW4KICAgICAgICAgIHZhciBzdGFydFBvcyA9IHRoaXMucG9zOwogICAgICAgICAgZm4ob2JqLCB0aGlzKTsKICAgICAgICAgIHZhciBsZW4gPSB0aGlzLnBvcyAtIHN0YXJ0UG9zOwoKICAgICAgICAgIGlmIChsZW4gPj0gMHg4MCkgbWFrZVJvb21Gb3JFeHRyYUxlbmd0aChzdGFydFBvcywgbGVuLCB0aGlzKTsKCiAgICAgICAgICAvLyBmaW5hbGx5LCB3cml0ZSB0aGUgbWVzc2FnZSBsZW5ndGggaW4gdGhlIHJlc2VydmVkIHBsYWNlIGFuZCByZXN0b3JlIHRoZSBwb3NpdGlvbgogICAgICAgICAgdGhpcy5wb3MgPSBzdGFydFBvcyAtIDE7CiAgICAgICAgICB0aGlzLndyaXRlVmFyaW50KGxlbik7CiAgICAgICAgICB0aGlzLnBvcyArPSBsZW47CiAgICAgIH0sCgogICAgICB3cml0ZU1lc3NhZ2U6IGZ1bmN0aW9uKHRhZywgZm4sIG9iaikgewogICAgICAgICAgdGhpcy53cml0ZVRhZyh0YWcsIFBiZi5CeXRlcyk7CiAgICAgICAgICB0aGlzLndyaXRlUmF3TWVzc2FnZShmbiwgb2JqKTsKICAgICAgfSwKCiAgICAgIHdyaXRlUGFja2VkVmFyaW50OiAgIGZ1bmN0aW9uKHRhZywgYXJyKSB7IGlmIChhcnIubGVuZ3RoKSB0aGlzLndyaXRlTWVzc2FnZSh0YWcsIHdyaXRlUGFja2VkVmFyaW50LCBhcnIpOyAgIH0sCiAgICAgIHdyaXRlUGFja2VkU1ZhcmludDogIGZ1bmN0aW9uKHRhZywgYXJyKSB7IGlmIChhcnIubGVuZ3RoKSB0aGlzLndyaXRlTWVzc2FnZSh0YWcsIHdyaXRlUGFja2VkU1ZhcmludCwgYXJyKTsgIH0sCiAgICAgIHdyaXRlUGFja2VkQm9vbGVhbjogIGZ1bmN0aW9uKHRhZywgYXJyKSB7IGlmIChhcnIubGVuZ3RoKSB0aGlzLndyaXRlTWVzc2FnZSh0YWcsIHdyaXRlUGFja2VkQm9vbGVhbiwgYXJyKTsgIH0sCiAgICAgIHdyaXRlUGFja2VkRmxvYXQ6ICAgIGZ1bmN0aW9uKHRhZywgYXJyKSB7IGlmIChhcnIubGVuZ3RoKSB0aGlzLndyaXRlTWVzc2FnZSh0YWcsIHdyaXRlUGFja2VkRmxvYXQsIGFycik7ICAgIH0sCiAgICAgIHdyaXRlUGFja2VkRG91YmxlOiAgIGZ1bmN0aW9uKHRhZywgYXJyKSB7IGlmIChhcnIubGVuZ3RoKSB0aGlzLndyaXRlTWVzc2FnZSh0YWcsIHdyaXRlUGFja2VkRG91YmxlLCBhcnIpOyAgIH0sCiAgICAgIHdyaXRlUGFja2VkRml4ZWQzMjogIGZ1bmN0aW9uKHRhZywgYXJyKSB7IGlmIChhcnIubGVuZ3RoKSB0aGlzLndyaXRlTWVzc2FnZSh0YWcsIHdyaXRlUGFja2VkRml4ZWQzMiwgYXJyKTsgIH0sCiAgICAgIHdyaXRlUGFja2VkU0ZpeGVkMzI6IGZ1bmN0aW9uKHRhZywgYXJyKSB7IGlmIChhcnIubGVuZ3RoKSB0aGlzLndyaXRlTWVzc2FnZSh0YWcsIHdyaXRlUGFja2VkU0ZpeGVkMzIsIGFycik7IH0sCiAgICAgIHdyaXRlUGFja2VkRml4ZWQ2NDogIGZ1bmN0aW9uKHRhZywgYXJyKSB7IGlmIChhcnIubGVuZ3RoKSB0aGlzLndyaXRlTWVzc2FnZSh0YWcsIHdyaXRlUGFja2VkRml4ZWQ2NCwgYXJyKTsgIH0sCiAgICAgIHdyaXRlUGFja2VkU0ZpeGVkNjQ6IGZ1bmN0aW9uKHRhZywgYXJyKSB7IGlmIChhcnIubGVuZ3RoKSB0aGlzLndyaXRlTWVzc2FnZSh0YWcsIHdyaXRlUGFja2VkU0ZpeGVkNjQsIGFycik7IH0sCgogICAgICB3cml0ZUJ5dGVzRmllbGQ6IGZ1bmN0aW9uKHRhZywgYnVmZmVyKSB7CiAgICAgICAgICB0aGlzLndyaXRlVGFnKHRhZywgUGJmLkJ5dGVzKTsKICAgICAgICAgIHRoaXMud3JpdGVCeXRlcyhidWZmZXIpOwogICAgICB9LAogICAgICB3cml0ZUZpeGVkMzJGaWVsZDogZnVuY3Rpb24odGFnLCB2YWwpIHsKICAgICAgICAgIHRoaXMud3JpdGVUYWcodGFnLCBQYmYuRml4ZWQzMik7CiAgICAgICAgICB0aGlzLndyaXRlRml4ZWQzMih2YWwpOwogICAgICB9LAogICAgICB3cml0ZVNGaXhlZDMyRmllbGQ6IGZ1bmN0aW9uKHRhZywgdmFsKSB7CiAgICAgICAgICB0aGlzLndyaXRlVGFnKHRhZywgUGJmLkZpeGVkMzIpOwogICAgICAgICAgdGhpcy53cml0ZVNGaXhlZDMyKHZhbCk7CiAgICAgIH0sCiAgICAgIHdyaXRlRml4ZWQ2NEZpZWxkOiBmdW5jdGlvbih0YWcsIHZhbCkgewogICAgICAgICAgdGhpcy53cml0ZVRhZyh0YWcsIFBiZi5GaXhlZDY0KTsKICAgICAgICAgIHRoaXMud3JpdGVGaXhlZDY0KHZhbCk7CiAgICAgIH0sCiAgICAgIHdyaXRlU0ZpeGVkNjRGaWVsZDogZnVuY3Rpb24odGFnLCB2YWwpIHsKICAgICAgICAgIHRoaXMud3JpdGVUYWcodGFnLCBQYmYuRml4ZWQ2NCk7CiAgICAgICAgICB0aGlzLndyaXRlU0ZpeGVkNjQodmFsKTsKICAgICAgfSwKICAgICAgd3JpdGVWYXJpbnRGaWVsZDogZnVuY3Rpb24odGFnLCB2YWwpIHsKICAgICAgICAgIHRoaXMud3JpdGVUYWcodGFnLCBQYmYuVmFyaW50KTsKICAgICAgICAgIHRoaXMud3JpdGVWYXJpbnQodmFsKTsKICAgICAgfSwKICAgICAgd3JpdGVTVmFyaW50RmllbGQ6IGZ1bmN0aW9uKHRhZywgdmFsKSB7CiAgICAgICAgICB0aGlzLndyaXRlVGFnKHRhZywgUGJmLlZhcmludCk7CiAgICAgICAgICB0aGlzLndyaXRlU1ZhcmludCh2YWwpOwogICAgICB9LAogICAgICB3cml0ZVN0cmluZ0ZpZWxkOiBmdW5jdGlvbih0YWcsIHN0cikgewogICAgICAgICAgdGhpcy53cml0ZVRhZyh0YWcsIFBiZi5CeXRlcyk7CiAgICAgICAgICB0aGlzLndyaXRlU3RyaW5nKHN0cik7CiAgICAgIH0sCiAgICAgIHdyaXRlRmxvYXRGaWVsZDogZnVuY3Rpb24odGFnLCB2YWwpIHsKICAgICAgICAgIHRoaXMud3JpdGVUYWcodGFnLCBQYmYuRml4ZWQzMik7CiAgICAgICAgICB0aGlzLndyaXRlRmxvYXQodmFsKTsKICAgICAgfSwKICAgICAgd3JpdGVEb3VibGVGaWVsZDogZnVuY3Rpb24odGFnLCB2YWwpIHsKICAgICAgICAgIHRoaXMud3JpdGVUYWcodGFnLCBQYmYuRml4ZWQ2NCk7CiAgICAgICAgICB0aGlzLndyaXRlRG91YmxlKHZhbCk7CiAgICAgIH0sCiAgICAgIHdyaXRlQm9vbGVhbkZpZWxkOiBmdW5jdGlvbih0YWcsIHZhbCkgewogICAgICAgICAgdGhpcy53cml0ZVZhcmludEZpZWxkKHRhZywgQm9vbGVhbih2YWwpKTsKICAgICAgfQogIH07CgogIGZ1bmN0aW9uIHJlYWRWYXJpbnRSZW1haW5kZXIobCwgcywgcCkgewogICAgICB2YXIgYnVmID0gcC5idWYsCiAgICAgICAgICBoLCBiOwoKICAgICAgYiA9IGJ1ZltwLnBvcysrXTsgaCAgPSAoYiAmIDB4NzApID4+IDQ7ICBpZiAoYiA8IDB4ODApIHJldHVybiB0b051bShsLCBoLCBzKTsKICAgICAgYiA9IGJ1ZltwLnBvcysrXTsgaCB8PSAoYiAmIDB4N2YpIDw8IDM7ICBpZiAoYiA8IDB4ODApIHJldHVybiB0b051bShsLCBoLCBzKTsKICAgICAgYiA9IGJ1ZltwLnBvcysrXTsgaCB8PSAoYiAmIDB4N2YpIDw8IDEwOyBpZiAoYiA8IDB4ODApIHJldHVybiB0b051bShsLCBoLCBzKTsKICAgICAgYiA9IGJ1ZltwLnBvcysrXTsgaCB8PSAoYiAmIDB4N2YpIDw8IDE3OyBpZiAoYiA8IDB4ODApIHJldHVybiB0b051bShsLCBoLCBzKTsKICAgICAgYiA9IGJ1ZltwLnBvcysrXTsgaCB8PSAoYiAmIDB4N2YpIDw8IDI0OyBpZiAoYiA8IDB4ODApIHJldHVybiB0b051bShsLCBoLCBzKTsKICAgICAgYiA9IGJ1ZltwLnBvcysrXTsgaCB8PSAoYiAmIDB4MDEpIDw8IDMxOyBpZiAoYiA8IDB4ODApIHJldHVybiB0b051bShsLCBoLCBzKTsKCiAgICAgIHRocm93IG5ldyBFcnJvcignRXhwZWN0ZWQgdmFyaW50IG5vdCBtb3JlIHRoYW4gMTAgYnl0ZXMnKTsKICB9CgogIGZ1bmN0aW9uIHJlYWRQYWNrZWRFbmQocGJmKSB7CiAgICAgIHJldHVybiBwYmYudHlwZSA9PT0gUGJmLkJ5dGVzID8KICAgICAgICAgIHBiZi5yZWFkVmFyaW50KCkgKyBwYmYucG9zIDogcGJmLnBvcyArIDE7CiAgfQoKICBmdW5jdGlvbiB0b051bShsb3csIGhpZ2gsIGlzU2lnbmVkKSB7CiAgICAgIGlmIChpc1NpZ25lZCkgewogICAgICAgICAgcmV0dXJuIGhpZ2ggKiAweDEwMDAwMDAwMCArIChsb3cgPj4+IDApOwogICAgICB9CgogICAgICByZXR1cm4gKChoaWdoID4+PiAwKSAqIDB4MTAwMDAwMDAwKSArIChsb3cgPj4+IDApOwogIH0KCiAgZnVuY3Rpb24gd3JpdGVCaWdWYXJpbnQodmFsLCBwYmYpIHsKICAgICAgdmFyIGxvdywgaGlnaDsKCiAgICAgIGlmICh2YWwgPj0gMCkgewogICAgICAgICAgbG93ICA9ICh2YWwgJSAweDEwMDAwMDAwMCkgfCAwOwogICAgICAgICAgaGlnaCA9ICh2YWwgLyAweDEwMDAwMDAwMCkgfCAwOwogICAgICB9IGVsc2UgewogICAgICAgICAgbG93ICA9IH4oLXZhbCAlIDB4MTAwMDAwMDAwKTsKICAgICAgICAgIGhpZ2ggPSB+KC12YWwgLyAweDEwMDAwMDAwMCk7CgogICAgICAgICAgaWYgKGxvdyBeIDB4ZmZmZmZmZmYpIHsKICAgICAgICAgICAgICBsb3cgPSAobG93ICsgMSkgfCAwOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsb3cgPSAwOwogICAgICAgICAgICAgIGhpZ2ggPSAoaGlnaCArIDEpIHwgMDsKICAgICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHZhbCA+PSAweDEwMDAwMDAwMDAwMDAwMDAwIHx8IHZhbCA8IC0weDEwMDAwMDAwMDAwMDAwMDAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0dpdmVuIHZhcmludCBkb2VzblwndCBmaXQgaW50byAxMCBieXRlcycpOwogICAgICB9CgogICAgICBwYmYucmVhbGxvYygxMCk7CgogICAgICB3cml0ZUJpZ1ZhcmludExvdyhsb3csIGhpZ2gsIHBiZik7CiAgICAgIHdyaXRlQmlnVmFyaW50SGlnaChoaWdoLCBwYmYpOwogIH0KCiAgZnVuY3Rpb24gd3JpdGVCaWdWYXJpbnRMb3cobG93LCBoaWdoLCBwYmYpIHsKICAgICAgcGJmLmJ1ZltwYmYucG9zKytdID0gbG93ICYgMHg3ZiB8IDB4ODA7IGxvdyA+Pj49IDc7CiAgICAgIHBiZi5idWZbcGJmLnBvcysrXSA9IGxvdyAmIDB4N2YgfCAweDgwOyBsb3cgPj4+PSA3OwogICAgICBwYmYuYnVmW3BiZi5wb3MrK10gPSBsb3cgJiAweDdmIHwgMHg4MDsgbG93ID4+Pj0gNzsKICAgICAgcGJmLmJ1ZltwYmYucG9zKytdID0gbG93ICYgMHg3ZiB8IDB4ODA7IGxvdyA+Pj49IDc7CiAgICAgIHBiZi5idWZbcGJmLnBvc10gICA9IGxvdyAmIDB4N2Y7CiAgfQoKICBmdW5jdGlvbiB3cml0ZUJpZ1ZhcmludEhpZ2goaGlnaCwgcGJmKSB7CiAgICAgIHZhciBsc2IgPSAoaGlnaCAmIDB4MDcpIDw8IDQ7CgogICAgICBwYmYuYnVmW3BiZi5wb3MrK10gfD0gbHNiICAgICAgICAgfCAoKGhpZ2ggPj4+PSAzKSA/IDB4ODAgOiAwKTsgaWYgKCFoaWdoKSByZXR1cm47CiAgICAgIHBiZi5idWZbcGJmLnBvcysrXSAgPSBoaWdoICYgMHg3ZiB8ICgoaGlnaCA+Pj49IDcpID8gMHg4MCA6IDApOyBpZiAoIWhpZ2gpIHJldHVybjsKICAgICAgcGJmLmJ1ZltwYmYucG9zKytdICA9IGhpZ2ggJiAweDdmIHwgKChoaWdoID4+Pj0gNykgPyAweDgwIDogMCk7IGlmICghaGlnaCkgcmV0dXJuOwogICAgICBwYmYuYnVmW3BiZi5wb3MrK10gID0gaGlnaCAmIDB4N2YgfCAoKGhpZ2ggPj4+PSA3KSA/IDB4ODAgOiAwKTsgaWYgKCFoaWdoKSByZXR1cm47CiAgICAgIHBiZi5idWZbcGJmLnBvcysrXSAgPSBoaWdoICYgMHg3ZiB8ICgoaGlnaCA+Pj49IDcpID8gMHg4MCA6IDApOyBpZiAoIWhpZ2gpIHJldHVybjsKICAgICAgcGJmLmJ1ZltwYmYucG9zKytdICA9IGhpZ2ggJiAweDdmOwogIH0KCiAgZnVuY3Rpb24gbWFrZVJvb21Gb3JFeHRyYUxlbmd0aChzdGFydFBvcywgbGVuLCBwYmYpIHsKICAgICAgdmFyIGV4dHJhTGVuID0KICAgICAgICAgIGxlbiA8PSAweDNmZmYgPyAxIDoKICAgICAgICAgIGxlbiA8PSAweDFmZmZmZiA/IDIgOgogICAgICAgICAgbGVuIDw9IDB4ZmZmZmZmZiA/IDMgOiBNYXRoLmZsb29yKE1hdGgubG9nKGxlbikgLyAoTWF0aC5MTjIgKiA3KSk7CgogICAgICAvLyBpZiAxIGJ5dGUgaXNuJ3QgZW5vdWdoIGZvciBlbmNvZGluZyBtZXNzYWdlIGxlbmd0aCwgc2hpZnQgdGhlIGRhdGEgdG8gdGhlIHJpZ2h0CiAgICAgIHBiZi5yZWFsbG9jKGV4dHJhTGVuKTsKICAgICAgZm9yICh2YXIgaSA9IHBiZi5wb3MgLSAxOyBpID49IHN0YXJ0UG9zOyBpLS0pIHBiZi5idWZbaSArIGV4dHJhTGVuXSA9IHBiZi5idWZbaV07CiAgfQoKICBmdW5jdGlvbiB3cml0ZVBhY2tlZFZhcmludChhcnIsIHBiZikgICB7IGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSBwYmYud3JpdGVWYXJpbnQoYXJyW2ldKTsgICB9CiAgZnVuY3Rpb24gd3JpdGVQYWNrZWRTVmFyaW50KGFyciwgcGJmKSAgeyBmb3IgKHZhciBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgcGJmLndyaXRlU1ZhcmludChhcnJbaV0pOyAgfQogIGZ1bmN0aW9uIHdyaXRlUGFja2VkRmxvYXQoYXJyLCBwYmYpICAgIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHBiZi53cml0ZUZsb2F0KGFycltpXSk7ICAgIH0KICBmdW5jdGlvbiB3cml0ZVBhY2tlZERvdWJsZShhcnIsIHBiZikgICB7IGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSBwYmYud3JpdGVEb3VibGUoYXJyW2ldKTsgICB9CiAgZnVuY3Rpb24gd3JpdGVQYWNrZWRCb29sZWFuKGFyciwgcGJmKSAgeyBmb3IgKHZhciBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgcGJmLndyaXRlQm9vbGVhbihhcnJbaV0pOyAgfQogIGZ1bmN0aW9uIHdyaXRlUGFja2VkRml4ZWQzMihhcnIsIHBiZikgIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHBiZi53cml0ZUZpeGVkMzIoYXJyW2ldKTsgIH0KICBmdW5jdGlvbiB3cml0ZVBhY2tlZFNGaXhlZDMyKGFyciwgcGJmKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSBwYmYud3JpdGVTRml4ZWQzMihhcnJbaV0pOyB9CiAgZnVuY3Rpb24gd3JpdGVQYWNrZWRGaXhlZDY0KGFyciwgcGJmKSAgeyBmb3IgKHZhciBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgcGJmLndyaXRlRml4ZWQ2NChhcnJbaV0pOyAgfQogIGZ1bmN0aW9uIHdyaXRlUGFja2VkU0ZpeGVkNjQoYXJyLCBwYmYpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHBiZi53cml0ZVNGaXhlZDY0KGFycltpXSk7IH0KCiAgLy8gQnVmZmVyIGNvZGUgYmVsb3cgZnJvbSBodHRwczovL2dpdGh1Yi5jb20vZmVyb3NzL2J1ZmZlciwgTUlULWxpY2Vuc2VkCgogIGZ1bmN0aW9uIHJlYWRVSW50MzIoYnVmLCBwb3MpIHsKICAgICAgcmV0dXJuICgoYnVmW3Bvc10pIHwKICAgICAgICAgIChidWZbcG9zICsgMV0gPDwgOCkgfAogICAgICAgICAgKGJ1Zltwb3MgKyAyXSA8PCAxNikpICsKICAgICAgICAgIChidWZbcG9zICsgM10gKiAweDEwMDAwMDApOwogIH0KCiAgZnVuY3Rpb24gd3JpdGVJbnQzMihidWYsIHZhbCwgcG9zKSB7CiAgICAgIGJ1Zltwb3NdID0gdmFsOwogICAgICBidWZbcG9zICsgMV0gPSAodmFsID4+PiA4KTsKICAgICAgYnVmW3BvcyArIDJdID0gKHZhbCA+Pj4gMTYpOwogICAgICBidWZbcG9zICsgM10gPSAodmFsID4+PiAyNCk7CiAgfQoKICBmdW5jdGlvbiByZWFkSW50MzIoYnVmLCBwb3MpIHsKICAgICAgcmV0dXJuICgoYnVmW3Bvc10pIHwKICAgICAgICAgIChidWZbcG9zICsgMV0gPDwgOCkgfAogICAgICAgICAgKGJ1Zltwb3MgKyAyXSA8PCAxNikpICsKICAgICAgICAgIChidWZbcG9zICsgM10gPDwgMjQpOwogIH0KCiAgZnVuY3Rpb24gcmVhZFV0ZjgoYnVmLCBwb3MsIGVuZCkgewogICAgICB2YXIgc3RyID0gJyc7CiAgICAgIHZhciBpID0gcG9zOwoKICAgICAgd2hpbGUgKGkgPCBlbmQpIHsKICAgICAgICAgIHZhciBiMCA9IGJ1ZltpXTsKICAgICAgICAgIHZhciBjID0gbnVsbDsgLy8gY29kZXBvaW50CiAgICAgICAgICB2YXIgYnl0ZXNQZXJTZXF1ZW5jZSA9CiAgICAgICAgICAgICAgYjAgPiAweEVGID8gNCA6CiAgICAgICAgICAgICAgYjAgPiAweERGID8gMyA6CiAgICAgICAgICAgICAgYjAgPiAweEJGID8gMiA6IDE7CgogICAgICAgICAgaWYgKGkgKyBieXRlc1BlclNlcXVlbmNlID4gZW5kKSBicmVhazsKCiAgICAgICAgICB2YXIgYjEsIGIyLCBiMzsKCiAgICAgICAgICBpZiAoYnl0ZXNQZXJTZXF1ZW5jZSA9PT0gMSkgewogICAgICAgICAgICAgIGlmIChiMCA8IDB4ODApIHsKICAgICAgICAgICAgICAgICAgYyA9IGIwOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoYnl0ZXNQZXJTZXF1ZW5jZSA9PT0gMikgewogICAgICAgICAgICAgIGIxID0gYnVmW2kgKyAxXTsKICAgICAgICAgICAgICBpZiAoKGIxICYgMHhDMCkgPT09IDB4ODApIHsKICAgICAgICAgICAgICAgICAgYyA9IChiMCAmIDB4MUYpIDw8IDB4NiB8IChiMSAmIDB4M0YpOwogICAgICAgICAgICAgICAgICBpZiAoYyA8PSAweDdGKSB7CiAgICAgICAgICAgICAgICAgICAgICBjID0gbnVsbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoYnl0ZXNQZXJTZXF1ZW5jZSA9PT0gMykgewogICAgICAgICAgICAgIGIxID0gYnVmW2kgKyAxXTsKICAgICAgICAgICAgICBiMiA9IGJ1ZltpICsgMl07CiAgICAgICAgICAgICAgaWYgKChiMSAmIDB4QzApID09PSAweDgwICYmIChiMiAmIDB4QzApID09PSAweDgwKSB7CiAgICAgICAgICAgICAgICAgIGMgPSAoYjAgJiAweEYpIDw8IDB4QyB8IChiMSAmIDB4M0YpIDw8IDB4NiB8IChiMiAmIDB4M0YpOwogICAgICAgICAgICAgICAgICBpZiAoYyA8PSAweDdGRiB8fCAoYyA+PSAweEQ4MDAgJiYgYyA8PSAweERGRkYpKSB7CiAgICAgICAgICAgICAgICAgICAgICBjID0gbnVsbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoYnl0ZXNQZXJTZXF1ZW5jZSA9PT0gNCkgewogICAgICAgICAgICAgIGIxID0gYnVmW2kgKyAxXTsKICAgICAgICAgICAgICBiMiA9IGJ1ZltpICsgMl07CiAgICAgICAgICAgICAgYjMgPSBidWZbaSArIDNdOwogICAgICAgICAgICAgIGlmICgoYjEgJiAweEMwKSA9PT0gMHg4MCAmJiAoYjIgJiAweEMwKSA9PT0gMHg4MCAmJiAoYjMgJiAweEMwKSA9PT0gMHg4MCkgewogICAgICAgICAgICAgICAgICBjID0gKGIwICYgMHhGKSA8PCAweDEyIHwgKGIxICYgMHgzRikgPDwgMHhDIHwgKGIyICYgMHgzRikgPDwgMHg2IHwgKGIzICYgMHgzRik7CiAgICAgICAgICAgICAgICAgIGlmIChjIDw9IDB4RkZGRiB8fCBjID49IDB4MTEwMDAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBjID0gbnVsbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoYyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGMgPSAweEZGRkQ7CiAgICAgICAgICAgICAgYnl0ZXNQZXJTZXF1ZW5jZSA9IDE7CgogICAgICAgICAgfSBlbHNlIGlmIChjID4gMHhGRkZGKSB7CiAgICAgICAgICAgICAgYyAtPSAweDEwMDAwOwogICAgICAgICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGMgPj4+IDEwICYgMHgzRkYgfCAweEQ4MDApOwogICAgICAgICAgICAgIGMgPSAweERDMDAgfCBjICYgMHgzRkY7CiAgICAgICAgICB9CgogICAgICAgICAgc3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYyk7CiAgICAgICAgICBpICs9IGJ5dGVzUGVyU2VxdWVuY2U7CiAgICAgIH0KCiAgICAgIHJldHVybiBzdHI7CiAgfQoKICBmdW5jdGlvbiByZWFkVXRmOFRleHREZWNvZGVyKGJ1ZiwgcG9zLCBlbmQpIHsKICAgICAgcmV0dXJuIHV0ZjhUZXh0RGVjb2Rlci5kZWNvZGUoYnVmLnN1YmFycmF5KHBvcywgZW5kKSk7CiAgfQoKICBmdW5jdGlvbiB3cml0ZVV0ZjgoYnVmLCBzdHIsIHBvcykgewogICAgICBmb3IgKHZhciBpID0gMCwgYywgbGVhZDsgaSA8IHN0ci5sZW5ndGg7IGkrKykgewogICAgICAgICAgYyA9IHN0ci5jaGFyQ29kZUF0KGkpOyAvLyBjb2RlIHBvaW50CgogICAgICAgICAgaWYgKGMgPiAweEQ3RkYgJiYgYyA8IDB4RTAwMCkgewogICAgICAgICAgICAgIGlmIChsZWFkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChjIDwgMHhEQzAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBidWZbcG9zKytdID0gMHhFRjsKICAgICAgICAgICAgICAgICAgICAgIGJ1Zltwb3MrK10gPSAweEJGOwogICAgICAgICAgICAgICAgICAgICAgYnVmW3BvcysrXSA9IDB4QkQ7CiAgICAgICAgICAgICAgICAgICAgICBsZWFkID0gYzsKICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgYyA9IGxlYWQgLSAweEQ4MDAgPDwgMTAgfCBjIC0gMHhEQzAwIHwgMHgxMDAwMDsKICAgICAgICAgICAgICAgICAgICAgIGxlYWQgPSBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgaWYgKGMgPiAweERCRkYgfHwgKGkgKyAxID09PSBzdHIubGVuZ3RoKSkgewogICAgICAgICAgICAgICAgICAgICAgYnVmW3BvcysrXSA9IDB4RUY7CiAgICAgICAgICAgICAgICAgICAgICBidWZbcG9zKytdID0gMHhCRjsKICAgICAgICAgICAgICAgICAgICAgIGJ1Zltwb3MrK10gPSAweEJEOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgbGVhZCA9IGM7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChsZWFkKSB7CiAgICAgICAgICAgICAgYnVmW3BvcysrXSA9IDB4RUY7CiAgICAgICAgICAgICAgYnVmW3BvcysrXSA9IDB4QkY7CiAgICAgICAgICAgICAgYnVmW3BvcysrXSA9IDB4QkQ7CiAgICAgICAgICAgICAgbGVhZCA9IG51bGw7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGMgPCAweDgwKSB7CiAgICAgICAgICAgICAgYnVmW3BvcysrXSA9IGM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChjIDwgMHg4MDApIHsKICAgICAgICAgICAgICAgICAgYnVmW3BvcysrXSA9IGMgPj4gMHg2IHwgMHhDMDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAoYyA8IDB4MTAwMDApIHsKICAgICAgICAgICAgICAgICAgICAgIGJ1Zltwb3MrK10gPSBjID4+IDB4QyB8IDB4RTA7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBidWZbcG9zKytdID0gYyA+PiAweDEyIHwgMHhGMDsKICAgICAgICAgICAgICAgICAgICAgIGJ1Zltwb3MrK10gPSBjID4+IDB4QyAmIDB4M0YgfCAweDgwOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJ1Zltwb3MrK10gPSBjID4+IDB4NiAmIDB4M0YgfCAweDgwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWZbcG9zKytdID0gYyAmIDB4M0YgfCAweDgwOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBwb3M7CiAgfQoKICB2YXIgUGJmJDEgPSAvKkBfX1BVUkVfXyovZ2V0RGVmYXVsdEV4cG9ydEZyb21DanMocGJmKTsKCiAgLy90eXBlIEFyY2dpc1Jlc3RTb3VyY2VTcGVjaWZpY2F0aW9uID0gYW55OwogIHZhciBlc3JpUGJmR2VvbWV0cnlUeXBlRW51bTsKICAoZnVuY3Rpb24gKGVzcmlQYmZHZW9tZXRyeVR5cGVFbnVtKSB7CiAgICAgIGVzcmlQYmZHZW9tZXRyeVR5cGVFbnVtW2VzcmlQYmZHZW9tZXRyeVR5cGVFbnVtWyJlc3JpR2VvbWV0cnlUeXBlUG9pbnQiXSA9IDBdID0gImVzcmlHZW9tZXRyeVR5cGVQb2ludCI7CiAgICAgIGVzcmlQYmZHZW9tZXRyeVR5cGVFbnVtW2VzcmlQYmZHZW9tZXRyeVR5cGVFbnVtWyJlc3JpR2VvbWV0cnlUeXBlTXVsdGlwb2ludCJdID0gMV0gPSAiZXNyaUdlb21ldHJ5VHlwZU11bHRpcG9pbnQiOwogICAgICBlc3JpUGJmR2VvbWV0cnlUeXBlRW51bVtlc3JpUGJmR2VvbWV0cnlUeXBlRW51bVsiZXNyaUdlb21ldHJ5VHlwZVBvbHlsaW5lIl0gPSAyXSA9ICJlc3JpR2VvbWV0cnlUeXBlUG9seWxpbmUiOwogICAgICBlc3JpUGJmR2VvbWV0cnlUeXBlRW51bVtlc3JpUGJmR2VvbWV0cnlUeXBlRW51bVsiZXNyaUdlb21ldHJ5VHlwZVBvbHlnb24iXSA9IDNdID0gImVzcmlHZW9tZXRyeVR5cGVQb2x5Z29uIjsKICAgICAgZXNyaVBiZkdlb21ldHJ5VHlwZUVudW1bZXNyaVBiZkdlb21ldHJ5VHlwZUVudW1bImVzcmlHZW9tZXRyeVR5cGVNdWx0aXBhdGNoIl0gPSA0XSA9ICJlc3JpR2VvbWV0cnlUeXBlTXVsdGlwYXRjaCI7CiAgICAgIGVzcmlQYmZHZW9tZXRyeVR5cGVFbnVtW2VzcmlQYmZHZW9tZXRyeVR5cGVFbnVtWyJlc3JpR2VvbWV0cnlUeXBlTm9uZSJdID0gMTI3XSA9ICJlc3JpR2VvbWV0cnlUeXBlTm9uZSI7CiAgfSkoZXNyaVBiZkdlb21ldHJ5VHlwZUVudW0gfHwgKGVzcmlQYmZHZW9tZXRyeVR5cGVFbnVtID0ge30pKTsKCiAgY2xhc3MgQ29udmVydFBiZiB7CiAgICAgIGNvbnN0cnVjdG9yKHBiZkRhdGEpIHsKICAgICAgICAgIHRoaXMuZGF0YSA9IHBiZkRhdGE7CiAgICAgIH0KICAgICAgYXN5bmMgY29udmVydCgpIHsKICAgICAgICAgIHZhciBfYTsKICAgICAgICAgIGNvbnN0IHBiZiA9IG5ldyBQYmYkMSh0aGlzLmRhdGEpOwogICAgICAgICAgY29uc3QgcGJmSnNvbiA9IHByb3RvKCkucmVhZChwYmYpOwogICAgICAgICAgLy8gR2V0IHRoZSBGZWF0dXJlUmVzdWx0CiAgICAgICAgICBpZiAocGJmSnNvbi5xdWVyeVJlc3VsdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIC8vY29uc29sZS53YXJuKCdpc3N1ZSB3aXRoIHRoZSByZXN1bHQnLCBwYmZKc29uKTsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fYnVpbGRSZXNwb25zZSh7CiAgICAgICAgICAgICAgICAgICdleGNlZWRlZFRyYW5zZmVyTGltaXQnOiB0cnVlLAogICAgICAgICAgICAgIH0sIFtdKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGZlYXR1cmVSZXN1bHQgPSBwYmZKc29uLnF1ZXJ5UmVzdWx0LmZlYXR1cmVSZXN1bHQ7CiAgICAgICAgICAvLyBHZXQgdGhlIGZpZWxkIG5hbWVzCiAgICAgICAgICBjb25zdCBmaWVsZHMgPSBmZWF0dXJlUmVzdWx0LmZpZWxkcy5tYXAoKGZpZWxkKSA9PiBmaWVsZC5uYW1lKTsKICAgICAgICAgIC8vIEdldCB0aGUgdHJhbnNsYXRpb24gaW5mbwogICAgICAgICAgY29uc3QgdHJhbnNsYXRpb24gPSBmZWF0dXJlUmVzdWx0LnRyYW5zZm9ybS50cmFuc2xhdGU7CiAgICAgICAgICBjb25zdCBzY2FsZSA9IGZlYXR1cmVSZXN1bHQudHJhbnNmb3JtLnNjYWxlOwogICAgICAgICAgY29uc3QgZ2VvbWV0cnlUeXBlID0gZmVhdHVyZVJlc3VsdC5nZW9tZXRyeVR5cGU7CiAgICAgICAgICBjb25zdCBxdWFudGl6ZU9yaWdpblBvc3Rpb24gPSBmZWF0dXJlUmVzdWx0LnRyYW5zZm9ybS5xdWFudGl6ZU9yaWdpblBvc3Rpb247CiAgICAgICAgICBjb25zdCBzcmlkID0gKF9hID0gZmVhdHVyZVJlc3VsdC5zcGF0aWFsUmVmZXJlbmNlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Eud2tpZC50b1N0cmluZygpOwogICAgICAgICAgY29uc3QgZmVhdHVyZXMgPSBmZWF0dXJlUmVzdWx0LmZlYXR1cmVzLm1hcCgoZmVhdHVyZSkgPT4gewogICAgICAgICAgICAgIC8vIFBhcnNlIGVhY2ggYXR0cmlidXRlCiAgICAgICAgICAgICAgbGV0IGF0dHJpYnV0ZXMgPSBmZWF0dXJlLmF0dHJpYnV0ZXMKICAgICAgICAgICAgICAgICAgLm1hcCgoYXR0cmlidXRlLCBpbmRleCkgPT4gKHsgJ2tleSc6IGZpZWxkc1tpbmRleF0sICd2YWx1ZSc6IGF0dHJpYnV0ZVthdHRyaWJ1dGVbJ3ZhbHVlX3R5cGUnXV0gfSkpCiAgICAgICAgICAgICAgICAgIC5yZWR1Y2UoKGEsIGMpID0+IHsKICAgICAgICAgICAgICAgICAgY29uc3QgbmV3T2JqID0ge307CiAgICAgICAgICAgICAgICAgIG5ld09ialtjLmtleV0gPSBjLnZhbHVlOwogICAgICAgICAgICAgICAgICByZXR1cm4geyAuLi5hLCAuLi5uZXdPYmogfTsKICAgICAgICAgICAgICB9LCB7fSk7CiAgICAgICAgICAgICAgLy8gUGFyc2UgdGhlIGdlb21ldHJpZXMgYW5kIGNsZWFuIHVwIHRoZSBxdWFudGl6YXRpb24KICAgICAgICAgICAgICBsZXQgcmluZ3MgPSBbW1tdXV07CiAgICAgICAgICAgICAgaWYgKChmZWF0dXJlLmdlb21ldHJ5ICE9PSBudWxsKSkgewogICAgICAgICAgICAgICAgICBsZXQgY291bnRzID0gZ2VvbWV0cnlUeXBlID09PSBlc3JpUGJmR2VvbWV0cnlUeXBlRW51bS5lc3JpR2VvbWV0cnlUeXBlUG9pbnQgPyBbMV0gOiAoZmVhdHVyZS5nZW9tZXRyeS5sZW5ndGhzKTsKICAgICAgICAgICAgICAgICAgLy8gQnJlYWsgaW50byBYIGFuZCBZIHJpbmdzCiAgICAgICAgICAgICAgICAgIGxldCB4ID0gW107CiAgICAgICAgICAgICAgICAgIGxldCB5ID0gW107CiAgICAgICAgICAgICAgICAgIGZlYXR1cmUuZ2VvbWV0cnkuY29vcmRzLmZvckVhY2goKGNvb3JkLCBpZHgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChpZHggJSAyID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgeC5wdXNoKGNvb3JkKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIHkucHVzaChjb29yZCk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAvL2xldCB4ID0gZmVhdHVyZS5nZW9tZXRyeS5jb29yZHMuZmlsdGVyKChfOiBudW1iZXIsIGlkeDogbnVtYmVyKSA9PiBpZHggJSAyID09PSAwKTsKICAgICAgICAgICAgICAgICAgLy9sZXQgeSA9IGZlYXR1cmUuZ2VvbWV0cnkuY29vcmRzLmZpbHRlcigoXzogbnVtYmVyLCBpZHg6IG51bWJlcikgPT4gaWR4ICUgMiA9PT0gMSk7CiAgICAgICAgICAgICAgICAgIC8vIGRlemlnemFnIHRoZSByaW5ncywgYW5kIG1lcmdlICsgcmVwcm9qZWN0IHRoZW0KICAgICAgICAgICAgICAgICAgbGV0IHJpbmdzWCA9IGRlWmlnWmFnKHgsIGNvdW50cywgc2NhbGUueFNjYWxlLCB0cmFuc2xhdGlvbi54VHJhbnNsYXRlLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgIGxldCByaW5nc1kgPSBkZVppZ1phZyh5LCBjb3VudHMsIHNjYWxlLnlTY2FsZSwgdHJhbnNsYXRpb24ueVRyYW5zbGF0ZSwgcXVhbnRpemVPcmlnaW5Qb3N0aW9uID09PSAwKTsKICAgICAgICAgICAgICAgICAgLy8gTWVyZ2UgdGhlIHJpbmdzCiAgICAgICAgICAgICAgICAgIHJpbmdzID0gbWVyZ2VSaW5ncyhyaW5nc1gsIHJpbmdzWSwgc3JpZCk7CiAgICAgICAgICAgICAgICAgIC8vcmluZ3MgPSByaW5nc1gubWFwKChyaW5nLCBpKSA9PiByaW5nLm1hcCgoeCwgaikgPT4gW3gsIHJpbmdzWVtpXVtqXV0pKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGV0IGdlb21ldHJ5ID0ge307CiAgICAgICAgICAgICAgaWYgKGVzcmlQYmZHZW9tZXRyeVR5cGVFbnVtW2dlb21ldHJ5VHlwZV0gPT09ICdlc3JpR2VvbWV0cnlUeXBlUG9pbnQnKSB7CiAgICAgICAgICAgICAgICAgIGdlb21ldHJ5ID0geyAneCc6IHJpbmdzWzBdWzBdWzBdLCAneSc6IHJpbmdzWzBdWzBdWzFdIH07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKGVzcmlQYmZHZW9tZXRyeVR5cGVFbnVtW2dlb21ldHJ5VHlwZV0gPT09ICdlc3JpR2VvbWV0cnlUeXBlTXVsdGlQb2ludCcpIHsKICAgICAgICAgICAgICAgICAgZ2VvbWV0cnkgPSB7ICdwb2ludHMnOiByaW5nc1swXSB9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIGlmIChlc3JpUGJmR2VvbWV0cnlUeXBlRW51bVtnZW9tZXRyeVR5cGVdID09PSAnZXNyaUdlb21ldHJ5VHlwZVBvbHlsaW5lJykgewogICAgICAgICAgICAgICAgICBnZW9tZXRyeSA9IHsgcGF0aHM6IHJpbmdzIH07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKGVzcmlQYmZHZW9tZXRyeVR5cGVFbnVtW2dlb21ldHJ5VHlwZV0gPT09ICdlc3JpR2VvbWV0cnlUeXBlUG9seWdvbicpIHsKICAgICAgICAgICAgICAgICAgZ2VvbWV0cnkgPSB7IHJpbmdzOiByaW5ncyB9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAnZ2VvbWV0cnknOiBnZW9tZXRyeSwKICAgICAgICAgICAgICAgICAgJ2F0dHJpYnV0ZXMnOiBhdHRyaWJ1dGVzLAogICAgICAgICAgICAgIH07CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiB0aGlzLl9idWlsZFJlc3BvbnNlKGZlYXR1cmVSZXN1bHQsIGZlYXR1cmVzKTsKICAgICAgfQogICAgICBfYnVpbGRSZXNwb25zZShmZWF0dXJlUmVzdWx0LCBmZWF0dXJlcykgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAnZmVhdHVyZXMnOiBmZWF0dXJlcywKICAgICAgICAgICAgICAnZXhjZWVkZWRUcmFuc2ZlckxpbWl0JzogZmVhdHVyZVJlc3VsdC5leGNlZWRlZFRyYW5zZmVyTGltaXQsCiAgICAgICAgICAgICAgJ3NwYXRpYWxSZWZlcmVuY2UnOiB7ICd3a2lkJzogNDMyNiwgJ2xhdGVzdFdraWQnOiA0MzI2IH0sCiAgICAgICAgICAgICAgJ2dlb21ldHJ5VHlwZSc6IGVzcmlQYmZHZW9tZXRyeVR5cGVFbnVtW2ZlYXR1cmVSZXN1bHQuZ2VvbWV0cnlUeXBlIHx8IDEyN10ucmVwbGFjZSgnVHlwZScsICcnKSwKICAgICAgICAgICAgICAnaGFzTSc6IGZlYXR1cmVSZXN1bHQuaGFzTSwKICAgICAgICAgICAgICAnaGFzWic6IGZlYXR1cmVSZXN1bHQuaGFzWiwKICAgICAgICAgICAgICAnZ2xvYmFsSWRGaWVsZE5hbWUnOiBmZWF0dXJlUmVzdWx0Lmdsb2JhbElkRmllbGROYW1lCiAgICAgICAgICB9OwogICAgICB9CiAgfQoKICBjbGFzcyBHZW9tZXRyaWVzQXRab29tIHsKICAgICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgICAvLyBLZWVwcyB0cmFjayBvZiB0aGUgZ2VvbWV0cmllcyB0aGF0IGhhdmUgYWxyZWFkeSBiZWVuIGxvYWRlZAogICAgICAgICAgdGhpcy5fZ2VvbWV0cmllc0F0Wm9vbSA9IG5ldyBBcnJheSgyNCk7CiAgICAgICAgICB0aGlzLl9tYXhHZW9tZXRyeVpvb20gPSAwOwogICAgICB9CiAgICAgIGFzeW5jIGdldEtleXNBdFpvb20oem9vbSwgbWF4Wm9vbSkgewogICAgICAgICAgLy8gRGV0ZXJtaW5lIHRoZSBtYXggem9vbSBiYXNlZCBvbiB0aGUgdXNlciBpbnB1dCwgdGhlIG1hcCdzIG1heHpvb20sIG9yIHRoZSBtYXh6b29tIHdlIGhhdmUgY2FjaGVkCiAgICAgICAgICBtYXhab29tID0gbWF4Wm9vbSAhPT0gdW5kZWZpbmVkID8gbWF4Wm9vbSA6IHRoaXMuX21heEdlb21ldHJ5Wm9vbTsKICAgICAgICAgIGNvbnN0IGdlb21ldHJ5R3JvdXBzID0gW107CiAgICAgICAgICBmb3IgKGxldCB6ID0gKE1hdGgubWluKG1heFpvb20sIHRoaXMuX21heEdlb21ldHJ5Wm9vbSkpOyB6ID49IHpvb207IHotLSkgewogICAgICAgICAgICAgIGlmICh0aGlzLl9nZW9tZXRyaWVzQXRab29tW3pdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgZ2VvbWV0cnlHcm91cHMucHVzaChbLi4udGhpcy5fZ2VvbWV0cmllc0F0Wm9vbVt6XS5rZXlzKCldKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZ2VvbWV0cnlHcm91cHMuZmxhdCgpOwogICAgICB9CiAgICAgIHVwZGF0ZUtleUF0Wm9vbSh6b29tLCBwcmltYXJ5S2V5KSB7CiAgICAgICAgICBsZXQgcmV0dXJuVmFsdWUgPSAnYWRkZWQnOwogICAgICAgICAgaWYgKHRoaXMuX2dlb21ldHJpZXNBdFpvb21bem9vbV0gPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICB0aGlzLl9nZW9tZXRyaWVzQXRab29tW3pvb21dID0gbmV3IE1hcCgpOwogICAgICAgICAgdGhpcy5fbWF4R2VvbWV0cnlab29tID0gTWF0aC5tYXgodGhpcy5fbWF4R2VvbWV0cnlab29tLCB6b29tKTsKICAgICAgICAgIGZvciAobGV0IHogPSAwOyB6IDwgem9vbTsgeisrKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMuX2dlb21ldHJpZXNBdFpvb21bel0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICB0aGlzLl9nZW9tZXRyaWVzQXRab29tW3pdLmRlbGV0ZShwcmltYXJ5S2V5KTsKICAgICAgICAgICAgICAgICAgcmV0dXJuVmFsdWUgPSAndXBkYXRlZCc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhpcy5fZ2VvbWV0cmllc0F0Wm9vbVt6b29tXS5zZXQocHJpbWFyeUtleSwgdHJ1ZSk7CiAgICAgICAgICByZXR1cm4gcmV0dXJuVmFsdWU7CiAgICAgIH0KICAgICAgYXN5bmMgdXBkYXRlS2V5c0F0Wm9vbSh6b29tLCBwcmltYXJ5S2V5cykgewogICAgICAgICAgcmV0dXJuIHByaW1hcnlLZXlzLm1hcChwcmltYXJ5S2V5ID0+IHRoaXMudXBkYXRlS2V5QXRab29tKHpvb20sIHByaW1hcnlLZXkpKTsKICAgICAgfQogIH0KCiAgY29uc3QgbGlicmFyaWVzID0gewogICAgICAnQ29udmVydFBiZic6IENvbnZlcnRQYmYsCiAgICAgICdHZW9tZXRyaWVzQXRab29tJzogR2VvbWV0cmllc0F0Wm9vbSwKICAgICAgJ0RlWmlnWmFnSlNPTic6IERlWmlnWmFnSlNPTgogIH07CiAgbGV0IHN1YkNsYXNzOwogIHNlbGYuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGUgPT4gewogICAgICBjb25zdCBkYXRhID0gKGUuZGF0YSB8fCBlKTsKICAgICAgY29uc3QgcG9zdCA9IChpZCwgZXJyLCByZXMsIHR5cGUpID0+IHsKICAgICAgICAgIHBvc3RNZXNzYWdlKHsKICAgICAgICAgICAgICB0eXBlOiB0eXBlID8gdHlwZSA6IChlcnIgPyAnZXJyb3InIDogJ3Jlc3BvbnNlJyksCiAgICAgICAgICAgICAgaWQ6IGlkLAogICAgICAgICAgICAgIG1lc3NhZ2U6IHJlcywKICAgICAgICAgICAgICBlcnJvcjogZXJyCiAgICAgICAgICB9KTsKICAgICAgfTsKICAgICAgY29uc3QgY29tbWFuZHMgPSB7CiAgICAgICAgICAnaW5pdCc6IChtc2cpID0+IHsKICAgICAgICAgICAgICBjb25zdCB7IGlkLCBjb21tYW5kLCBtZXNzYWdlIH0gPSBtc2c7CiAgICAgICAgICAgICAgc3ViQ2xhc3MgPSBuZXcgbGlicmFyaWVzW2NvbW1hbmRdKC4uLm1lc3NhZ2UpOwogICAgICAgICAgICAgIC8vIHJldHVybiB0aGUgY2xhc3MnIG1ldGhvZHMKICAgICAgICAgICAgICBjb25zdCBmbnMgPSBbCiAgICAgICAgICAgICAgICAgIC4uLk9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKGxpYnJhcmllc1tjb21tYW5kXS5wcm90b3R5cGUpLAogICAgICAgICAgICAgICAgICAuLi5PYmplY3Qua2V5cyhzdWJDbGFzcykKICAgICAgICAgICAgICBdLm1hcChrZXkgPT4gW2tleSwgdHlwZW9mIGxpYnJhcmllc1tjb21tYW5kXS5wcm90b3R5cGVba2V5XV0pCiAgICAgICAgICAgICAgICAgIC5yZWR1Y2UoKGEsIGMpID0+ICh7IC4uLmEsIC4uLnsgW2NbMF1dOiBjWzFdIH0gfSksIHt9KTsKICAgICAgICAgICAgICBwb3N0KGlkLCB1bmRlZmluZWQsIGZucywgJ2luaXRfcmVzcG9uc2UnKTsKICAgICAgICAgIH0sCiAgICAgICAgICAnZ2V0JzogZnVuY3Rpb24gKG1zZykgewogICAgICAgICAgICAgIGNvbnN0IHsgaWQsIGNvbW1hbmQgfSA9IG1zZzsKICAgICAgICAgICAgICBpZiAoc3ViQ2xhc3MgJiYgc3ViQ2xhc3NbY29tbWFuZF0pIHsKICAgICAgICAgICAgICAgICAgcG9zdChpZCwgdW5kZWZpbmVkLCBzdWJDbGFzc1tjb21tYW5kXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICBwb3N0KGlkLCB1bmRlZmluZWQsIHVuZGVmaW5lZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgICdleGVjJzogZnVuY3Rpb24gKG1zZykgewogICAgICAgICAgICAgIGNvbnN0IHsgaWQsIGNvbW1hbmQsIG1lc3NhZ2UgfSA9IG1zZzsKICAgICAgICAgICAgICBpZiAoc3ViQ2xhc3MgJiYgc3ViQ2xhc3NbY29tbWFuZF0gJiYgdHlwZW9mIHN1YkNsYXNzW2NvbW1hbmRdID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGNtZCA9IHN1YkNsYXNzW2NvbW1hbmRdCiAgICAgICAgICAgICAgICAgICAgICAuYXBwbHkoc3ViQ2xhc3MsIG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICBpZiAoISFjbWQgJiYgdHlwZW9mIGNtZC50aGVuID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyBJdCdzIGEgcHJvbWlzZSwgc28gd2FpdCBmb3IgaXQKICAgICAgICAgICAgICAgICAgICAgIGNtZAogICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKHJlcyA9PiBwb3N0KGlkLCB1bmRlZmluZWQsIHJlcykpCiAgICAgICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGUgPT4gcG9zdChpZCwgZSkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgLy8gTm90IGEgcHJvbWlzZSwganVzdCByZXR1cm4gaXQKICAgICAgICAgICAgICAgICAgICAgIHBvc3QoaWQsIHVuZGVmaW5lZCwgY21kKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgLy8gRXJyb3IKICAgICAgICAgICAgICAgICAgcG9zdChpZCwgbmV3IEVycm9yKGBjb21tYW5kICIke2NvbW1hbmR9IiBub3QgZm91bmRgKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9OwogICAgICBpZiAoY29tbWFuZHNbZGF0YS50eXBlXSkgewogICAgICAgICAgY29tbWFuZHNbZGF0YS50eXBlXShkYXRhKTsKICAgICAgfQogIH0pOwoKICBleHBvcnRzLmxpYnJhcmllcyA9IGxpYnJhcmllczsKCiAgcmV0dXJuIGV4cG9ydHM7Cgp9KSh7fSk7Ci8vIyBzb3VyY2VNYXBwaW5nVVJMPXdvcmtlci5qcy5tYXAKCg==",t=null,a=!1,o?Z(d,t,a):function(I,g,C){var A;return function(i){return A=A||s(I,g,C),new Worker(A,i)}}(d,t,a));const n=40075016.68557849;function c(I,g){const C=I*(n/2)/180;let A=Math.log(Math.tan((90+g)*Math.PI/360))/(Math.PI/180);return A=A*(n/2)/180,{x:C,y:A}}function G(I,g=256){return n/(g*(1<<I))}const r=["102100","900913","3857","3587","54004","41001","102113","3785"];function W(I){const g=[Math.min(I[0],I[2]),Math.min(I[1],I[3])],C=[Math.max(I[0],I[2]),Math.max(I[1],I[3])];let A=c(g[0],g[1]),i=c(C[0],C[1]);return{type:"extent",xmin:A.x,ymin:A.y,xmax:i.x,ymax:i.y,spatialReferece:{latestWkid:102100,wkid:3857}}}function b(I,g,C){const A=(I,g)=>{const C=function(I,g){return{lng:180*I/(n/2),lat:360*Math.atan(Math.exp(g*Math.PI/(n/2)))/Math.PI-90}}(I,g);return[C.lng,C.lat]};return r.indexOf(C)>-1?I.map(((I,C)=>I.map(((I,i)=>A(I,g[C][i]))))):I.map(((I,C)=>I.map(((I,A)=>[I,g[C][A]]))))}function V(I,g,C,A,i){return g.map(((e,l)=>{let Z=0;return Array(e).fill(void 0).map(((e,s)=>{const o=g.reduce(((I,g,C)=>I+(C<l?g:0)),0),d=I[o+s],t=i?-1:1;let a;return a=0===s?d*t+A/C:d*t+Z,Z=a,a})).map((I=>I*C))}))}function u(I){return I&&I.__esModule&&Object.prototype.hasOwnProperty.call(I,"default")?I.default:I}var y={
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
read:function(I,g,C,A,i){var e,l,Z=8*i-A-1,s=(1<<Z)-1,o=s>>1,d=-7,t=C?i-1:0,a=C?-1:1,m=I[g+t];for(t+=a,e=m&(1<<-d)-1,m>>=-d,d+=Z;d>0;e=256*e+I[g+t],t+=a,d-=8);for(l=e&(1<<-d)-1,e>>=-d,d+=A;d>0;l=256*l+I[g+t],t+=a,d-=8);if(0===e)e=1-o;else{if(e===s)return l?NaN:1/0*(m?-1:1);l+=Math.pow(2,A),e-=o}return(m?-1:1)*l*Math.pow(2,e-A)},write:function(I,g,C,A,i,e){var l,Z,s,o=8*e-i-1,d=(1<<o)-1,t=d>>1,a=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,m=A?0:e-1,n=A?1:-1,c=g<0||0===g&&1/g<0?1:0;for(g=Math.abs(g),isNaN(g)||g===1/0?(Z=isNaN(g)?1:0,l=d):(l=Math.floor(Math.log(g)/Math.LN2),g*(s=Math.pow(2,-l))<1&&(l--,s*=2),(g+=l+t>=1?a/s:a*Math.pow(2,1-t))*s>=2&&(l++,s/=2),l+t>=d?(Z=0,l=d):l+t>=1?(Z=(g*s-1)*Math.pow(2,i),l+=t):(Z=g*Math.pow(2,t-1)*Math.pow(2,i),l=0));i>=8;I[C+m]=255&Z,m+=n,Z/=256,i-=8);for(l=l<<i|Z,o+=i;o>0;I[C+m]=255&l,m+=n,l/=256,o-=8);I[C+m-n]|=128*c}},B=h,p=y;function h(I){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(I)?I:new Uint8Array(I||0),this.pos=0,this.type=0,this.length=this.buf.length}h.Varint=0,h.Fixed64=1,h.Bytes=2,h.Fixed32=5;var Y=4294967296,H=1/Y,w="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function R(I){return I.type===h.Bytes?I.readVarint()+I.pos:I.pos+1}function K(I,g,C){return C?4294967296*g+(I>>>0):4294967296*(g>>>0)+(I>>>0)}function X(I,g,C){var A=g<=16383?1:g<=2097151?2:g<=268435455?3:Math.floor(Math.log(g)/(7*Math.LN2));C.realloc(A);for(var i=C.pos-1;i>=I;i--)C.buf[i+A]=C.buf[i]}function J(I,g){for(var C=0;C<I.length;C++)g.writeVarint(I[C])}function F(I,g){for(var C=0;C<I.length;C++)g.writeSVarint(I[C])}function S(I,g){for(var C=0;C<I.length;C++)g.writeFloat(I[C])}function T(I,g){for(var C=0;C<I.length;C++)g.writeDouble(I[C])}function v(I,g){for(var C=0;C<I.length;C++)g.writeBoolean(I[C])}function k(I,g){for(var C=0;C<I.length;C++)g.writeFixed32(I[C])}function N(I,g){for(var C=0;C<I.length;C++)g.writeSFixed32(I[C])}function D(I,g){for(var C=0;C<I.length;C++)g.writeFixed64(I[C])}function P(I,g){for(var C=0;C<I.length;C++)g.writeSFixed64(I[C])}function f(I,g){return(I[g]|I[g+1]<<8|I[g+2]<<16)+16777216*I[g+3]}function L(I,g,C){I[C]=g,I[C+1]=g>>>8,I[C+2]=g>>>16,I[C+3]=g>>>24}function M(I,g){return(I[g]|I[g+1]<<8|I[g+2]<<16)+(I[g+3]<<24)}h.prototype={destroy:function(){this.buf=null},readFields:function(I,g,C){for(C=C||this.length;this.pos<C;){var A=this.readVarint(),i=A>>3,e=this.pos;this.type=7&A,I(i,g,this),this.pos===e&&this.skip(A)}return g},readMessage:function(I,g){return this.readFields(I,g,this.readVarint()+this.pos)},readFixed32:function(){var I=f(this.buf,this.pos);return this.pos+=4,I},readSFixed32:function(){var I=M(this.buf,this.pos);return this.pos+=4,I},readFixed64:function(){var I=f(this.buf,this.pos)+f(this.buf,this.pos+4)*Y;return this.pos+=8,I},readSFixed64:function(){var I=f(this.buf,this.pos)+M(this.buf,this.pos+4)*Y;return this.pos+=8,I},readFloat:function(){var I=p.read(this.buf,this.pos,!0,23,4);return this.pos+=4,I},readDouble:function(){var I=p.read(this.buf,this.pos,!0,52,8);return this.pos+=8,I},readVarint:function(I){var g,C,A=this.buf;return g=127&(C=A[this.pos++]),C<128?g:(g|=(127&(C=A[this.pos++]))<<7,C<128?g:(g|=(127&(C=A[this.pos++]))<<14,C<128?g:(g|=(127&(C=A[this.pos++]))<<21,C<128?g:function(I,g,C){var A,i,e=C.buf;if(i=e[C.pos++],A=(112&i)>>4,i<128)return K(I,A,g);if(i=e[C.pos++],A|=(127&i)<<3,i<128)return K(I,A,g);if(i=e[C.pos++],A|=(127&i)<<10,i<128)return K(I,A,g);if(i=e[C.pos++],A|=(127&i)<<17,i<128)return K(I,A,g);if(i=e[C.pos++],A|=(127&i)<<24,i<128)return K(I,A,g);if(i=e[C.pos++],A|=(1&i)<<31,i<128)return K(I,A,g);throw new Error("Expected varint not more than 10 bytes")}(g|=(15&(C=A[this.pos]))<<28,I,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var I=this.readVarint();return I%2==1?(I+1)/-2:I/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var I=this.readVarint()+this.pos,g=this.pos;return this.pos=I,I-g>=12&&w?function(I,g,C){return w.decode(I.subarray(g,C))}(this.buf,g,I):function(I,g,C){var A="",i=g;for(;i<C;){var e,l,Z,s=I[i],o=null,d=s>239?4:s>223?3:s>191?2:1;if(i+d>C)break;1===d?s<128&&(o=s):2===d?128==(192&(e=I[i+1]))&&(o=(31&s)<<6|63&e)<=127&&(o=null):3===d?(e=I[i+1],l=I[i+2],128==(192&e)&&128==(192&l)&&((o=(15&s)<<12|(63&e)<<6|63&l)<=2047||o>=55296&&o<=57343)&&(o=null)):4===d&&(e=I[i+1],l=I[i+2],Z=I[i+3],128==(192&e)&&128==(192&l)&&128==(192&Z)&&((o=(15&s)<<18|(63&e)<<12|(63&l)<<6|63&Z)<=65535||o>=1114112)&&(o=null)),null===o?(o=65533,d=1):o>65535&&(o-=65536,A+=String.fromCharCode(o>>>10&1023|55296),o=56320|1023&o),A+=String.fromCharCode(o),i+=d}return A}(this.buf,g,I)},readBytes:function(){var I=this.readVarint()+this.pos,g=this.buf.subarray(this.pos,I);return this.pos=I,g},readPackedVarint:function(I,g){if(this.type!==h.Bytes)return I.push(this.readVarint(g));var C=R(this);for(I=I||[];this.pos<C;)I.push(this.readVarint(g));return I},readPackedSVarint:function(I){if(this.type!==h.Bytes)return I.push(this.readSVarint());var g=R(this);for(I=I||[];this.pos<g;)I.push(this.readSVarint());return I},readPackedBoolean:function(I){if(this.type!==h.Bytes)return I.push(this.readBoolean());var g=R(this);for(I=I||[];this.pos<g;)I.push(this.readBoolean());return I},readPackedFloat:function(I){if(this.type!==h.Bytes)return I.push(this.readFloat());var g=R(this);for(I=I||[];this.pos<g;)I.push(this.readFloat());return I},readPackedDouble:function(I){if(this.type!==h.Bytes)return I.push(this.readDouble());var g=R(this);for(I=I||[];this.pos<g;)I.push(this.readDouble());return I},readPackedFixed32:function(I){if(this.type!==h.Bytes)return I.push(this.readFixed32());var g=R(this);for(I=I||[];this.pos<g;)I.push(this.readFixed32());return I},readPackedSFixed32:function(I){if(this.type!==h.Bytes)return I.push(this.readSFixed32());var g=R(this);for(I=I||[];this.pos<g;)I.push(this.readSFixed32());return I},readPackedFixed64:function(I){if(this.type!==h.Bytes)return I.push(this.readFixed64());var g=R(this);for(I=I||[];this.pos<g;)I.push(this.readFixed64());return I},readPackedSFixed64:function(I){if(this.type!==h.Bytes)return I.push(this.readSFixed64());var g=R(this);for(I=I||[];this.pos<g;)I.push(this.readSFixed64());return I},skip:function(I){var g=7&I;if(g===h.Varint)for(;this.buf[this.pos++]>127;);else if(g===h.Bytes)this.pos=this.readVarint()+this.pos;else if(g===h.Fixed32)this.pos+=4;else{if(g!==h.Fixed64)throw new Error("Unimplemented type: "+g);this.pos+=8}},writeTag:function(I,g){this.writeVarint(I<<3|g)},realloc:function(I){for(var g=this.length||16;g<this.pos+I;)g*=2;if(g!==this.length){var C=new Uint8Array(g);C.set(this.buf),this.buf=C,this.length=g}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(I){this.realloc(4),L(this.buf,I,this.pos),this.pos+=4},writeSFixed32:function(I){this.realloc(4),L(this.buf,I,this.pos),this.pos+=4},writeFixed64:function(I){this.realloc(8),L(this.buf,-1&I,this.pos),L(this.buf,Math.floor(I*H),this.pos+4),this.pos+=8},writeSFixed64:function(I){this.realloc(8),L(this.buf,-1&I,this.pos),L(this.buf,Math.floor(I*H),this.pos+4),this.pos+=8},writeVarint:function(I){(I=+I||0)>268435455||I<0?function(I,g){var C,A;I>=0?(C=I%4294967296|0,A=I/4294967296|0):(A=~(-I/4294967296),4294967295^(C=~(-I%4294967296))?C=C+1|0:(C=0,A=A+1|0));if(I>=0x10000000000000000||I<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");g.realloc(10),function(I,g,C){C.buf[C.pos++]=127&I|128,I>>>=7,C.buf[C.pos++]=127&I|128,I>>>=7,C.buf[C.pos++]=127&I|128,I>>>=7,C.buf[C.pos++]=127&I|128,I>>>=7,C.buf[C.pos]=127&I}(C,0,g),function(I,g){var C=(7&I)<<4;if(g.buf[g.pos++]|=C|((I>>>=3)?128:0),!I)return;if(g.buf[g.pos++]=127&I|((I>>>=7)?128:0),!I)return;if(g.buf[g.pos++]=127&I|((I>>>=7)?128:0),!I)return;if(g.buf[g.pos++]=127&I|((I>>>=7)?128:0),!I)return;if(g.buf[g.pos++]=127&I|((I>>>=7)?128:0),!I)return;g.buf[g.pos++]=127&I}(A,g)}(I,this):(this.realloc(4),this.buf[this.pos++]=127&I|(I>127?128:0),I<=127||(this.buf[this.pos++]=127&(I>>>=7)|(I>127?128:0),I<=127||(this.buf[this.pos++]=127&(I>>>=7)|(I>127?128:0),I<=127||(this.buf[this.pos++]=I>>>7&127))))},writeSVarint:function(I){this.writeVarint(I<0?2*-I-1:2*I)},writeBoolean:function(I){this.writeVarint(Boolean(I))},writeString:function(I){I=String(I),this.realloc(4*I.length),this.pos++;var g=this.pos;this.pos=function(I,g,C){for(var A,i,e=0;e<g.length;e++){if((A=g.charCodeAt(e))>55295&&A<57344){if(!i){A>56319||e+1===g.length?(I[C++]=239,I[C++]=191,I[C++]=189):i=A;continue}if(A<56320){I[C++]=239,I[C++]=191,I[C++]=189,i=A;continue}A=i-55296<<10|A-56320|65536,i=null}else i&&(I[C++]=239,I[C++]=191,I[C++]=189,i=null);A<128?I[C++]=A:(A<2048?I[C++]=A>>6|192:(A<65536?I[C++]=A>>12|224:(I[C++]=A>>18|240,I[C++]=A>>12&63|128),I[C++]=A>>6&63|128),I[C++]=63&A|128)}return C}(this.buf,I,this.pos);var C=this.pos-g;C>=128&&X(g,C,this),this.pos=g-1,this.writeVarint(C),this.pos+=C},writeFloat:function(I){this.realloc(4),p.write(this.buf,I,this.pos,!0,23,4),this.pos+=4},writeDouble:function(I){this.realloc(8),p.write(this.buf,I,this.pos,!0,52,8),this.pos+=8},writeBytes:function(I){var g=I.length;this.writeVarint(g),this.realloc(g);for(var C=0;C<g;C++)this.buf[this.pos++]=I[C]},writeRawMessage:function(I,g){this.pos++;var C=this.pos;I(g,this);var A=this.pos-C;A>=128&&X(C,A,this),this.pos=C-1,this.writeVarint(A),this.pos+=A},writeMessage:function(I,g,C){this.writeTag(I,h.Bytes),this.writeRawMessage(g,C)},writePackedVarint:function(I,g){g.length&&this.writeMessage(I,J,g)},writePackedSVarint:function(I,g){g.length&&this.writeMessage(I,F,g)},writePackedBoolean:function(I,g){g.length&&this.writeMessage(I,v,g)},writePackedFloat:function(I,g){g.length&&this.writeMessage(I,S,g)},writePackedDouble:function(I,g){g.length&&this.writeMessage(I,T,g)},writePackedFixed32:function(I,g){g.length&&this.writeMessage(I,k,g)},writePackedSFixed32:function(I,g){g.length&&this.writeMessage(I,N,g)},writePackedFixed64:function(I,g){g.length&&this.writeMessage(I,D,g)},writePackedSFixed64:function(I,g){g.length&&this.writeMessage(I,P,g)},writeBytesField:function(I,g){this.writeTag(I,h.Bytes),this.writeBytes(g)},writeFixed32Field:function(I,g){this.writeTag(I,h.Fixed32),this.writeFixed32(g)},writeSFixed32Field:function(I,g){this.writeTag(I,h.Fixed32),this.writeSFixed32(g)},writeFixed64Field:function(I,g){this.writeTag(I,h.Fixed64),this.writeFixed64(g)},writeSFixed64Field:function(I,g){this.writeTag(I,h.Fixed64),this.writeSFixed64(g)},writeVarintField:function(I,g){this.writeTag(I,h.Varint),this.writeVarint(g)},writeSVarintField:function(I,g){this.writeTag(I,h.Varint),this.writeSVarint(g)},writeStringField:function(I,g){this.writeTag(I,h.Bytes),this.writeString(g)},writeFloatField:function(I,g){this.writeTag(I,h.Fixed32),this.writeFloat(g)},writeDoubleField:function(I,g){this.writeTag(I,h.Fixed64),this.writeDouble(g)},writeBooleanField:function(I,g){this.writeVarintField(I,Boolean(g))}};var z,U=u(B);!function(I){I[I.esriGeometryTypePoint=0]="esriGeometryTypePoint",I[I.esriGeometryTypeMultipoint=1]="esriGeometryTypeMultipoint",I[I.esriGeometryTypePolyline=2]="esriGeometryTypePolyline",I[I.esriGeometryTypePolygon=3]="esriGeometryTypePolygon",I[I.esriGeometryTypeMultipatch=4]="esriGeometryTypeMultipatch",I[I.esriGeometryTypeNone=127]="esriGeometryTypeNone"}(z||(z={}));const Q={ConvertPbf:class{constructor(I){this.data=I}async convert(){var I;const g=new U(this.data),C=function(){let I={read:function(g,C){return g.readFields(I._readField,{version:"",queryResult:null},C)},_readField:function(g,C,A){1===g?C.version=A.readString():2===g&&(C.queryResult=I.QueryResult.read(A,A.readVarint()+A.pos))},write:function(g,C){g.version&&C.writeStringField(1,g.version),g.queryResult&&C.writeMessage(2,I.QueryResult.write,g.queryResult)},GeometryType:{esriGeometryTypePoint:{value:0,options:{}},esriGeometryTypeMultipoint:{value:1,options:{}},esriGeometryTypePolyline:{value:2,options:{}},esriGeometryTypePolygon:{value:3,options:{}},esriGeometryTypeMultipatch:{value:4,options:{}},esriGeometryTypeNone:{value:127,options:{}}},FieldType:{esriFieldTypeSmallInteger:{value:0,options:{}},esriFieldTypeInteger:{value:1,options:{}},esriFieldTypeSingle:{value:2,options:{}},esriFieldTypeDouble:{value:3,options:{}},esriFieldTypeString:{value:4,options:{}},esriFieldTypeDate:{value:5,options:{}},esriFieldTypeOID:{value:6,options:{}},esriFieldTypeGeometry:{value:7,options:{}},esriFieldTypeBlob:{value:8,options:{}},esriFieldTypeRaster:{value:9,options:{}},esriFieldTypeGUID:{value:10,options:{}},esriFieldTypeGlobalID:{value:11,options:{}},esriFieldTypeXML:{value:12,options:{}}},SQLType:{sqlTypeBigInt:{value:0,options:{}},sqlTypeBinary:{value:1,options:{}},sqlTypeBit:{value:2,options:{}},sqlTypeChar:{value:3,options:{}},sqlTypeDate:{value:4,options:{}},sqlTypeDecimal:{value:5,options:{}},sqlTypeDouble:{value:6,options:{}},sqlTypeFloat:{value:7,options:{}},sqlTypeGeometry:{value:8,options:{}},sqlTypeGUID:{value:9,options:{}},sqlTypeInteger:{value:10,options:{}},sqlTypeLongNVarchar:{value:11,options:{}},sqlTypeLongVarbinary:{value:12,options:{}},sqlTypeLongVarchar:{value:13,options:{}},sqlTypeNChar:{value:14,options:{}},sqlTypeNVarchar:{value:15,options:{}},sqlTypeOther:{value:16,options:{}},sqlTypeReal:{value:17,options:{}},sqlTypeSmallInt:{value:18,options:{}},sqlTypeSqlXml:{value:19,options:{}},sqlTypeTime:{value:20,options:{}},sqlTypeTimestamp:{value:21,options:{}},sqlTypeTimestamp2:{value:22,options:{}},sqlTypeTinyInt:{value:23,options:{}},sqlTypeVarbinary:{value:24,options:{}},sqlTypeVarchar:{value:25,options:{}}},QuantizeOriginPostion:{upperLeft:{value:0,options:{}},lowerLeft:{value:1,options:{}}},SpatialReference:{}};return I.SpatialReference.read=function(g,C){return g.readFields(I.SpatialReference._readField,{wkid:0,lastestWkid:0,vcsWkid:0,latestVcsWkid:0,wkt:""},C)},I.SpatialReference._readField=function(I,g,C){1===I?g.wkid=C.readVarint():2===I?g.lastestWkid=C.readVarint():3===I?g.vcsWkid=C.readVarint():4===I?g.latestVcsWkid=C.readVarint():5===I&&(g.wkt=C.readString())},I.SpatialReference.write=function(I,g){I.wkid&&g.writeVarintField(1,I.wkid),I.lastestWkid&&g.writeVarintField(2,I.lastestWkid),I.vcsWkid&&g.writeVarintField(3,I.vcsWkid),I.latestVcsWkid&&g.writeVarintField(4,I.latestVcsWkid),I.wkt&&g.writeStringField(5,I.wkt)},I.Field={},I.Field.read=function(g,C){return g.readFields(I.Field._readField,{name:"",fieldType:0,alias:"",sqlType:0,domain:"",defaultValue:""},C)},I.Field._readField=function(I,g,C){1===I?g.name=C.readString():2===I?g.fieldType=C.readVarint():3===I?g.alias=C.readString():4===I?g.sqlType=C.readVarint():5===I?g.domain=C.readString():6===I&&(g.defaultValue=C.readString())},I.Field.write=function(I,g){I.name&&g.writeStringField(1,I.name),I.fieldType&&g.writeVarintField(2,I.fieldType),I.alias&&g.writeStringField(3,I.alias),I.sqlType&&g.writeVarintField(4,I.sqlType),I.domain&&g.writeStringField(5,I.domain),I.defaultValue&&g.writeStringField(6,I.defaultValue)},I.Value={},I.Value.read=function(g,C){return g.readFields(I.Value._readField,{string_value:"",value_type:null,float_value:0,double_value:0,sint_value:0,uint_value:0,int64_value:0,uint64_value:0,sint64_value:0,bool_value:!1},C)},I.Value._readField=function(I,g,C){1===I?(g.string_value=C.readString(),g.value_type="string_value"):2===I?(g.float_value=C.readFloat(),g.value_type="float_value"):3===I?(g.double_value=C.readDouble(),g.value_type="double_value"):4===I?(g.sint_value=C.readSVarint(),g.value_type="sint_value"):5===I?(g.uint_value=C.readVarint(),g.value_type="uint_value"):6===I?(g.int64_value=C.readVarint(!0),g.value_type="int64_value"):7===I?(g.uint64_value=C.readVarint(),g.value_type="uint64_value"):8===I?(g.sint64_value=C.readSVarint(),g.value_type="sint64_value"):9===I&&(g.bool_value=C.readBoolean(),g.value_type="bool_value")},I.Value.write=function(I,g){I.string_value&&g.writeStringField(1,I.string_value),I.float_value&&g.writeFloatField(2,I.float_value),I.double_value&&g.writeDoubleField(3,I.double_value),I.sint_value&&g.writeSVarintField(4,I.sint_value),I.uint_value&&g.writeVarintField(5,I.uint_value),I.int64_value&&g.writeVarintField(6,I.int64_value),I.uint64_value&&g.writeVarintField(7,I.uint64_value),I.sint64_value&&g.writeSVarintField(8,I.sint64_value),I.bool_value&&g.writeBooleanField(9,I.bool_value)},I.Geometry={},I.Geometry.read=function(g,C){return g.readFields(I.Geometry._readField,{lengths:[],coords:[]},C)},I.Geometry._readField=function(I,g,C){2===I?C.readPackedVarint(g.lengths):3===I&&C.readPackedSVarint(g.coords)},I.Geometry.write=function(I,g){I.lengths&&g.writePackedVarint(2,I.lengths),I.coords&&g.writePackedSVarint(3,I.coords)},I.esriShapeBuffer={},I.esriShapeBuffer.read=function(g,C){return g.readFields(I.esriShapeBuffer._readField,{bytes:null},C)},I.esriShapeBuffer._readField=function(I,g,C){1===I&&(g.bytes=C.readBytes())},I.esriShapeBuffer.write=function(I,g){I.bytes&&g.writeBytesField(1,I.bytes)},I.Feature={},I.Feature.read=function(g,C){return g.readFields(I.Feature._readField,{attributes:[],geometry:null,compressed_geometry:null,shapeBuffer:null,centroid:null},C)},I.Feature._readField=function(g,C,A){1===g?C.attributes.push(I.Value.read(A,A.readVarint()+A.pos)):2===g?(C.geometry=I.Geometry.read(A,A.readVarint()+A.pos),C.compressed_geometry="geometry"):3===g?(C.shapeBuffer=I.esriShapeBuffer.read(A,A.readVarint()+A.pos),C.compressed_geometry="shapeBuffer"):4===g&&(C.centroid=I.Geometry.read(A,A.readVarint()+A.pos))},I.Feature.write=function(g,C){if(g.attributes)for(var A=0;A<g.attributes.length;A++)C.writeMessage(1,I.Value.write,g.attributes[A]);g.geometry&&C.writeMessage(2,I.Geometry.write,g.geometry),g.shapeBuffer&&C.writeMessage(3,I.esriShapeBuffer.write,g.shapeBuffer),g.centroid&&C.writeMessage(4,I.Geometry.write,g.centroid)},I.UniqueIdField={},I.UniqueIdField.read=function(g,C){return g.readFields(I.UniqueIdField._readField,{name:"",isSystemMaintained:!1},C)},I.UniqueIdField._readField=function(I,g,C){1===I?g.name=C.readString():2===I&&(g.isSystemMaintained=C.readBoolean())},I.UniqueIdField.write=function(I,g){I.name&&g.writeStringField(1,I.name),I.isSystemMaintained&&g.writeBooleanField(2,I.isSystemMaintained)},I.GeometryProperties={},I.GeometryProperties.read=function(g,C){return g.readFields(I.GeometryProperties._readField,{shapeAreaFieldName:"",shapeLengthFieldName:"",units:""},C)},I.GeometryProperties._readField=function(I,g,C){1===I?g.shapeAreaFieldName=C.readString():2===I?g.shapeLengthFieldName=C.readString():3===I&&(g.units=C.readString())},I.GeometryProperties.write=function(I,g){I.shapeAreaFieldName&&g.writeStringField(1,I.shapeAreaFieldName),I.shapeLengthFieldName&&g.writeStringField(2,I.shapeLengthFieldName),I.units&&g.writeStringField(3,I.units)},I.ServerGens={},I.ServerGens.read=function(g,C){return g.readFields(I.ServerGens._readField,{minServerGen:0,serverGen:0},C)},I.ServerGens._readField=function(I,g,C){1===I?g.minServerGen=C.readVarint():2===I&&(g.serverGen=C.readVarint())},I.ServerGens.write=function(I,g){I.minServerGen&&g.writeVarintField(1,I.minServerGen),I.serverGen&&g.writeVarintField(2,I.serverGen)},I.Scale={},I.Scale.read=function(g,C){return g.readFields(I.Scale._readField,{xScale:0,yScale:0,mScale:0,zScale:0},C)},I.Scale._readField=function(I,g,C){1===I?g.xScale=C.readDouble():2===I?g.yScale=C.readDouble():3===I?g.mScale=C.readDouble():4===I&&(g.zScale=C.readDouble())},I.Scale.write=function(I,g){I.xScale&&g.writeDoubleField(1,I.xScale),I.yScale&&g.writeDoubleField(2,I.yScale),I.mScale&&g.writeDoubleField(3,I.mScale),I.zScale&&g.writeDoubleField(4,I.zScale)},I.Translate={},I.Translate.read=function(g,C){return g.readFields(I.Translate._readField,{xTranslate:0,yTranslate:0,mTranslate:0,zTranslate:0},C)},I.Translate._readField=function(I,g,C){1===I?g.xTranslate=C.readDouble():2===I?g.yTranslate=C.readDouble():3===I?g.mTranslate=C.readDouble():4===I&&(g.zTranslate=C.readDouble())},I.Translate.write=function(I,g){I.xTranslate&&g.writeDoubleField(1,I.xTranslate),I.yTranslate&&g.writeDoubleField(2,I.yTranslate),I.mTranslate&&g.writeDoubleField(3,I.mTranslate),I.zTranslate&&g.writeDoubleField(4,I.zTranslate)},I.Transform={},I.Transform.read=function(g,C){return g.readFields(I.Transform._readField,{quantizeOriginPostion:0,scale:null,translate:null},C)},I.Transform._readField=function(g,C,A){1===g?C.quantizeOriginPostion=A.readVarint():2===g?C.scale=I.Scale.read(A,A.readVarint()+A.pos):3===g&&(C.translate=I.Translate.read(A,A.readVarint()+A.pos))},I.Transform.write=function(g,C){g.quantizeOriginPostion&&C.writeVarintField(1,g.quantizeOriginPostion),g.scale&&C.writeMessage(2,I.Scale.write,g.scale),g.translate&&C.writeMessage(3,I.Translate.write,g.translate)},I.FeatureResult={},I.FeatureResult.read=function(g,C){return g.readFields(I.FeatureResult._readField,{objectIdFieldName:"",uniqueIdField:null,globalIdFieldName:"",geohashFieldName:"",geometryProperties:null,serverGens:null,geometryType:0,spatialReference:null,exceededTransferLimit:!1,hasZ:!1,hasM:!1,transform:null,fields:[],values:[],features:[]},C)},I.FeatureResult._readField=function(g,C,A){1===g?C.objectIdFieldName=A.readString():2===g?C.uniqueIdField=I.UniqueIdField.read(A,A.readVarint()+A.pos):3===g?C.globalIdFieldName=A.readString():4===g?C.geohashFieldName=A.readString():5===g?C.geometryProperties=I.GeometryProperties.read(A,A.readVarint()+A.pos):6===g?C.serverGens=I.ServerGens.read(A,A.readVarint()+A.pos):7===g?C.geometryType=A.readVarint():8===g?C.spatialReference=I.SpatialReference.read(A,A.readVarint()+A.pos):9===g?C.exceededTransferLimit=A.readBoolean():10===g?C.hasZ=A.readBoolean():11===g?C.hasM=A.readBoolean():12===g?C.transform=I.Transform.read(A,A.readVarint()+A.pos):13===g?C.fields.push(I.Field.read(A,A.readVarint()+A.pos)):14===g?C.values.push(I.Value.read(A,A.readVarint()+A.pos)):15===g&&C.features.push(I.Feature.read(A,A.readVarint()+A.pos))},I.FeatureResult.write=function(g,C){if(g.objectIdFieldName&&C.writeStringField(1,g.objectIdFieldName),g.uniqueIdField&&C.writeMessage(2,I.UniqueIdField.write,g.uniqueIdField),g.globalIdFieldName&&C.writeStringField(3,g.globalIdFieldName),g.geohashFieldName&&C.writeStringField(4,g.geohashFieldName),g.geometryProperties&&C.writeMessage(5,I.GeometryProperties.write,g.geometryProperties),g.serverGens&&C.writeMessage(6,I.ServerGens.write,g.serverGens),g.geometryType&&C.writeVarintField(7,g.geometryType),g.spatialReference&&C.writeMessage(8,I.SpatialReference.write,g.spatialReference),g.exceededTransferLimit&&C.writeBooleanField(9,g.exceededTransferLimit),g.hasZ&&C.writeBooleanField(10,g.hasZ),g.hasM&&C.writeBooleanField(11,g.hasM),g.transform&&C.writeMessage(12,I.Transform.write,g.transform),g.fields)for(var A=0;A<g.fields.length;A++)C.writeMessage(13,I.Field.write,g.fields[A]);if(g.values)for(A=0;A<g.values.length;A++)C.writeMessage(14,I.Value.write,g.values[A]);if(g.features)for(A=0;A<g.features.length;A++)C.writeMessage(15,I.Feature.write,g.features[A])},I.CountResult={},I.CountResult.read=function(g,C){return g.readFields(I.CountResult._readField,{count:0},C)},I.CountResult._readField=function(I,g,C){1===I&&(g.count=C.readVarint())},I.CountResult.write=function(I,g){I.count&&g.writeVarintField(1,I.count)},I.ObjectIdsResult={},I.ObjectIdsResult.read=function(g,C){return g.readFields(I.ObjectIdsResult._readField,{objectIdFieldName:"",serverGens:null,objectIds:[]},C)},I.ObjectIdsResult._readField=function(g,C,A){1===g?C.objectIdFieldName=A.readString():2===g?C.serverGens=I.ServerGens.read(A,A.readVarint()+A.pos):3===g&&A.readPackedVarint(C.objectIds)},I.ObjectIdsResult.write=function(g,C){g.objectIdFieldName&&C.writeStringField(1,g.objectIdFieldName),g.serverGens&&C.writeMessage(2,I.ServerGens.write,g.serverGens),g.objectIds&&C.writePackedVarint(3,g.objectIds)},I.QueryResult={},I.QueryResult.read=function(g,C){return g.readFields(I.QueryResult._readField,{featureResult:null,Results:null,countResult:null,idsResult:null},C)},I.QueryResult._readField=function(g,C,A){1===g?(C.featureResult=I.FeatureResult.read(A,A.readVarint()+A.pos),C.Results="featureResult"):2===g?(C.countResult=I.CountResult.read(A,A.readVarint()+A.pos),C.Results="countResult"):3===g&&(C.idsResult=I.ObjectIdsResult.read(A,A.readVarint()+A.pos),C.Results="idsResult")},I.QueryResult.write=function(g,C){g.featureResult&&C.writeMessage(1,I.FeatureResult.write,g.featureResult),g.countResult&&C.writeMessage(2,I.CountResult.write,g.countResult),g.idsResult&&C.writeMessage(3,I.ObjectIdsResult.write,g.idsResult)},I}().read(g);if(null===C.queryResult)return this._buildResponse({exceededTransferLimit:!0},[]);const A=C.queryResult.featureResult,i=A.fields.map((I=>I.name)),e=A.transform.translate,l=A.transform.scale,Z=A.geometryType,s=A.transform.quantizeOriginPostion,o=null===(I=A.spatialReference)||void 0===I?void 0:I.wkid.toString(),d=A.features.map((I=>{let g=I.attributes.map(((I,g)=>({key:i[g],value:I[I.value_type]}))).reduce(((I,g)=>{const C={};return C[g.key]=g.value,{...I,...C}}),{}),C=[[[]]];if(null!==I.geometry){let g=Z===z.esriGeometryTypePoint?[1]:I.geometry.lengths,A=[],i=[];I.geometry.coords.forEach(((I,g)=>{g%2==0?A.push(I):i.push(I)})),C=b(V(A,g,l.xScale,e.xTranslate,!1),V(i,g,l.yScale,e.yTranslate,0===s),o)}let A={};return"esriGeometryTypePoint"===z[Z]?A={x:C[0][0][0],y:C[0][0][1]}:"esriGeometryTypeMultiPoint"===z[Z]?A={points:C[0]}:"esriGeometryTypePolyline"===z[Z]?A={paths:C}:"esriGeometryTypePolygon"===z[Z]&&(A={rings:C}),{geometry:A,attributes:g}}));return this._buildResponse(A,d)}_buildResponse(I,g){return{features:g,exceededTransferLimit:I.exceededTransferLimit,spatialReference:{wkid:4326,latestWkid:4326},geometryType:z[I.geometryType||127].replace("Type",""),hasM:I.hasM,hasZ:I.hasZ,globalIdFieldName:I.globalIdFieldName}}},GeometriesAtZoom:class{constructor(){this._geometriesAtZoom=new Array(24),this._maxGeometryZoom=0}async getKeysAtZoom(I,g){g=void 0!==g?g:this._maxGeometryZoom;const C=[];for(let A=Math.min(g,this._maxGeometryZoom);A>=I;A--)void 0!==this._geometriesAtZoom[A]&&C.push([...this._geometriesAtZoom[A].keys()]);return C.flat()}updateKeyAtZoom(I,g){let C="added";void 0===this._geometriesAtZoom[I]&&(this._geometriesAtZoom[I]=new Map),this._maxGeometryZoom=Math.max(this._maxGeometryZoom,I);for(let A=0;A<I;A++)void 0!==this._geometriesAtZoom[A]&&(this._geometriesAtZoom[A].delete(g),C="updated");return this._geometriesAtZoom[I].set(g,!0),C}async updateKeysAtZoom(I,g){return g.map((g=>this.updateKeyAtZoom(I,g)))}},DeZigZagJSON:class{constructor(I,g,C){this.srid="3857",this.features=I,this.transform=g,this.geometryType=C}async convert(){return this.features.map((I=>(I.geometry=this.convertGeometry(I.geometry),I)))}convertGeometry(I){const g=[],C=[],A=[];"esriGeometryPoint"===this.geometryType?(g.push(1),C.push(I.x),A.push(I.y)):"esriGeometryMultipoint"===this.geometryType?I.points.forEach((I=>{g.push(1),C.push(I[0]),A.push(I[1])})):"esriGeometryPolyline"===this.geometryType?I.paths.forEach((I=>{g.push(I.length),I.forEach((I=>{C.push(I[0]),A.push(I[1])}))})):"esriGeometryPolygon"===this.geometryType&&I.rings.forEach((I=>{g.push(I.length),I.forEach((I=>{C.push(I[0]),A.push(I[1])}))}));const i=b(V(C,g,this.transform.scale[0],this.transform.translate[0],!1),V(A,g,this.transform.scale[1],this.transform.translate[1],"upperLeft"===this.transform.originPosition),this.srid);let e={};return"esriGeometryPoint"===this.geometryType?e={x:i[0][0][0],y:i[0][0][1]}:"esriGeometryMultipoint"===this.geometryType?e={points:i[0]}:"esriGeometryPolyline"===this.geometryType?e={paths:i}:"esriGeometryPolygon"===this.geometryType&&(e={rings:i}),e}}};let x;self.addEventListener("message",(I=>{const g=I.data||I,C=(I,g,C,A)=>{postMessage({type:A||(g?"error":"response"),id:I,message:C,error:g})},A={init:I=>{const{id:g,command:A,message:i}=I;x=new Q[A](...i);const e=[...Object.getOwnPropertyNames(Q[A].prototype),...Object.keys(x)].map((I=>[I,typeof Q[A].prototype[I]])).reduce(((I,g)=>({...I,[g[0]]:g[1]})),{});C(g,void 0,e,"init_response")},get:function(I){const{id:g,command:A}=I;x&&x[A]?C(g,void 0,x[A]):C(g,void 0,void 0)},exec:function(I){const{id:g,command:A,message:i}=I;if(x&&x[A]&&"function"==typeof x[A]){const I=x[A].apply(x,i);I&&"function"==typeof I.then?I.then((I=>C(g,void 0,I))).catch((I=>C(g,I))):C(g,void 0,I)}else C(g,new Error(`command "${A}" not found`))}};A[g.type]&&A[g.type](g)}));const O=()=>Math.random().toString(36).substring(2);function j(I,g=[]){return function(){let I=!1;try{I="function"==typeof window.Worker}catch(g){I=!1}return I}()?new E(I,g):new _(I,g)}class E{constructor(I,g=[]){this.initId=O()+"-"+I,this.worker=new m,this.handlers=new Map,this.worker.onmessage=I=>{const g=I.data,C=this.handlers.get(g.id),A=this;if(C){if("response"===g.type&&C.res(g.message),"error"===g.type){const I=g.error||new Error(`Unknown error with ${this.subClass}`);C.rej(I)}"init_response"===g.type&&(this._=Object.keys(g.message).map((I=>{const C=typeof g.message[I];return[I,function(){return C?A.exec(I)(...arguments):A.get(I)}]})).reduce(((I,g)=>({...I,[g[0]]:g[1]})),{}),C.res(this._))}},this.worker.postMessage({type:"init",id:this.initId,command:I,message:g})}onLoad(){return new Promise((I=>{void 0===this._?this.handlers.set(this.initId,{res:I,rej:I}):I(this._)}))}exec(I){const g=this;return function(...C){return new Promise(((A,i)=>{const e=O()+"-"+I;g.handlers.set(e,{res:A,rej:i}),g.worker.postMessage({type:"exec",id:e,command:I,message:[...C]})}))}}get(I){return new Promise(((g,C)=>{const A=O()+"-"+I;this.handlers.set(A,{res:g,rej:C}),this.worker.postMessage({type:"get",id:A,command:I,message:[]})}))}}class _{constructor(I,g=[]){this.subClass=new Q[I](...g)}onLoad(){return new Promise((I=>I(this)))}get(I){return new Promise((g=>g(this.subClass[I])))}exec(I){const g=this;return function(...C){return Promise.resolve(g.subClass[I](...C))}}}class q{constructor(I){this._map=I}async fetch(I,g={},C){let A=I.toString();const i=g.body?A.replace(/\??$/,"?")+g.body:A;i.length>2048&&void 0===g.method&&(g.method="POST"),g.method=["POST","GET","PUT"].indexOf((g.method||"").toUpperCase())>-1?(g.method||"").toUpperCase():"GET","GET"===g.method&&(A=i);const e={url:A,method:g.method};return"POST"===g.method&&(g.headers&&(e.headers=g.headers),g.body&&(e.body=g.body.toString())),{arrayBuffer:async()=>(e.type="arrayBuffer",this._getResource(e,C)),json:async()=>(e.type="json",this._getResource(e,C)),text:async()=>(e.type="string",this._getResource(e,C))}}async _getResource(I,g){return new Promise(((C,A)=>{let i=this._map.style.getResource(Math.random().toString(32).substring(2),I,((I,g)=>{I?A(I.toString()):C(g)}));g&&g({cancel:()=>{i.cancel(),A("cancel")}})}))}}const $={where:"1=1",outfields:"*",resultRecordCount:void 0};function II(I){return class extends I.GeoJSONSource{constructor(g,C,A,i){super(g,{type:"geojson",collectResourceTiming:!1,data:{}},A,i),this._quantizedQuery=!1,this._requestFormat="json",this._geometriesAtZoom=j("GeometriesAtZoom"),this._requests=[],this._sortableFields=[],this._events=new I.Evented,this._liveLayer=!1,this._waitTimes={},this._isUpdateable=!1,window.layer=this,this.id=g,this._originalSource={...$,...C};const e=this._originalSource.url.match(/.+?[Feature|Map]Server\/\d{1,}/);if(!e)throw new Error("ArcGisRest URL is invalid "+this._originalSource.url);this._originalSource.url=e[0],window.source=this}onAdd(I){this.map=I,this._asyncLoad(I).then((()=>this.load()))}async _asyncLoad(I){const g=new URL(this._originalSource.url);g.searchParams.append("f","json"),this._originalSource.token&&g.searchParams.append("token",this._originalSource.token);const C=new q(I),A=await(await C.fetch(g)).json();if(A.error)return console.error("ArcGIS Error",A.error),!1;const i=A.maxRecordCount||500,e=(A.supportedQueryFormats||"").toLowerCase().replace(/\s/g,"").split(",").indexOf("pbf")>-1;this._requestFormat=e?"pbf":"json",this._quantizedQuery=!0===A.supportsCoordinatesQuantization&&("esriGeometryPolygon"===A.geometryType||"esriGeometryPolyline"===A.geometryType),A.fields&&(this._sortableFields=A.fields.filter((I=>["esriFieldTypeString","esriFieldTypeDouble","esriFieldTypeDate","esriFieldTypeGUID","esriFieldTypeGlobalID","esriFieldTypeInteger","esriFieldTypeOID","esriFieldTypeSingle","esriFieldTypeSmallInteger"].indexOf(I.type)>-1&&-1===I.name.indexOf("()")&&-1===(I.alias||"").indexOf("()"))).map((I=>I.name))),A.indexes&&(this.promoteId=A.indexes.filter((I=>!0===I.isUnique&&I.fields&&this._sortableFields.indexOf(I.fields)>-1)).map((I=>I.fields))[0]),A.fields&&(this._primaryKeyType=A.fields.filter((I=>I.name===this.promoteId)).map((I=>["esriFieldTypeDouble","esriFieldTypeDate","esriFieldTypeGUID","esriFieldTypeGlobalID","esriFieldTypeInteger","esriFieldTypeOID","esriFieldTypeSingle","esriFieldTypeSmallInteger"].indexOf(I.type)>-1?"number":"string"))[0]),this._originalSource.resultRecordCount=(this._originalSource.resultRecordCount||1/0)<i?this._originalSource.resultRecordCount:i,this.setData({type:"FeatureCollection",features:[]}),this._events.on("data",(I=>this.drawMapData(I.json,I.zoom))),this.loadMapData(I),I.on("moveend",(()=>this._liveLayer&&this._waitEvent("redrawMap",100))),this._events.on("redrawMap",(()=>this.loadMapData(I)))}loadTile(I,g){this._liveLayer||(this._liveLayer=!0,this._waitEvent("redrawMap",1e3)),super.loadTile(I,g)}async loadMapData(I,g){if(void 0===(I=void 0===I?this.map:I))throw new Error("Source Data (Source ID: "+this.id+") could not be loaded");console.log("LOADING");const C=this._quantizedQuery?Math.floor(this.map.getZoom()):this.map.getMaxZoom();let A=this._originalSource.where;const i={where:A};if(this.promoteId){const e=c((g=g||[I.getBounds().getWest(),I.getBounds().getSouth(),I.getBounds().getEast(),I.getBounds().getNorth()])[0],g[1]),l=c(g[2],g[3]),Z=[e.x,e.y,l.x,l.y],s=await this._geometriesAtZoom.exec("getKeysAtZoom")(C);i.geometry=Z.join(","),i.geometryType="esriGeometryEnvelope",i.inSR="3857";const o=I=>"string"===this._primaryKeyType?`'${I}'`:I;s.length&&(i.where=`(${A}) AND "${this.promoteId}" NOT IN (${s.map((I=>o(I))).join(",")})`)}this._requests.forEach((I=>I.cancel())),this._queryFeatures(this._originalSource.url,i,0,(I=>this._requests.push(I)),I,C),this._liveLayer=!1}async drawMapData(I,g){const C=this._esriJsonToFeatures(I),A=C.map((I=>I.properties[this.promoteId])),i=await this._geometriesAtZoom.exec("updateKeysAtZoom")(g,A),e={add:i.map(((I,g)=>{if("added"===I)return C[g]})).filter((I=>void 0!==I)),update:i.map(((I,g)=>{if("updated"===I){const I=C[g].geometry;return{id:A[g],newGeometry:I}}})).filter((I=>void 0!==I)),removeAll:!1,remove:[]};if(e.update.length||e.add.length)if(this.updateData&&this._isUpdateable)this.updateData(e);else{console.log("this._data",this._data);const I=this._data.features,g=I.map((I=>I.properties[this.promoteId]));for(let C=0;C<e.update.length;C++){let A=g.indexOf(e.update[C].id);A>-1&&(I[A].geometry=e.update[C].newGeometry||I[A].geometry)}for(let g=0;g<e.add.length;g++){const C=e.add[g];C.properties&&(C.id=C.id||C.properties[this.promoteId]),I.push(C)}this._data&&this.setData(this._data)}}_updateWorkerData(I){console.log("UPDATING!!",I),super._updateWorkerData(I)}async _queryFeatures(I,g,C,A,i,e){if(void 0===(i=void 0===i?this.map:i))throw new Error("Source Data (Source ID: "+this.id+") could not be loaded");const l=Array.isArray(this._originalSource.outfields)?this._originalSource.outfields.map((I=>`"${I}"`)).join(","):"*",Z=this._quantizedQuery?JSON.stringify(function(I,g=256){return{mode:"view",originPosition:"upperLeft",tolerance:G(I,g),extent:W([-180,-85.06,180,85.06])}}(e,this.tileSize)):"",s={where:this._originalSource.where,spatialRel:"esriSpatialRelIntersects",outFields:l,returnGeometry:!0,returnTrueCurves:!1,outSR:this._quantizedQuery||"pbf"===this._requestFormat?"3857":"4326",returnIdsOnly:!1,returnCountOnly:!1,returnZ:!1,returnM:!1,returnDistinctValues:!1,returnExtentOnly:!1,featureEncoding:"esriDefault",orderByFields:this._sortableFields.map((I=>`"${I}"`)).join(","),resultOffset:void 0!==C?C:0,resultRecordCount:this._originalSource.resultRecordCount,quantizationParameters:Z,f:this._requestFormat,...g},o=new q(i),d=new URL(I);Object.keys(s).map((I=>d.searchParams.append(I,s[I].toString())));const t=o.fetch(I+"/query",{body:d.search.replace(/^\?/,""),headers:{"content-type":"application/x-www-form-urlencoded"}},(I=>A&&A(I))),a=await await t;let m={features:[],exceededTransferLimit:!1};try{if("pbf"===s.f){const I=j("ConvertPbf",[await a.arrayBuffer()]);m=await I.exec("convert")()}else if(m=await a.json(),this._quantizedQuery){const I=j("DeZigZagJSON",[m.features,m.transform,m.geometryType]),g=await I.exec("convert")();m.spatialReference={wkid:4326},m.features=g}}catch(I){return void("cancel"!==I&&console.error("Error with request",I))}m&&m.features.length&&this._events.fire("data",{json:m,zoom:e}),!0===m.exceededTransferLimit&&this._queryFeatures(I,g,(C||0)+m.features.length,A,i,e)}_esriJsonToFeatures(I){if(-1===Object.keys({esriGeometryPoint:"Point",esriGeometryMultipoint:"MultiPoint",esriGeometryLine:"LineString",esriGeometryPolyline:"MultiLineString",esriGeometryPolygon:"MultiPolygon"}).indexOf(I.geometryType))throw new Error("Geometry "+I.geometryType+" not supported");return I.features.map((g=>(4326!==(I.spatialReference.latestWkid||I.spatialReference.wkid)&&console.warn("Unspported Projection ("+(I.spatialReference.latestWkid||I.spatialReference.wkid)+"), some data may not display correctly"),{type:"Feature",properties:g.attributes,geometry:i(g.geometry)})))}_waitEvent(I,g=100){console.log("Called",I,g),this._waitTimes[I]=(this._waitTimes[I]||0)+g,setTimeout((()=>{void 0!==this._waitTimes[I]&&(this._waitTimes[I]=this._waitTimes[I]-g,this._waitTimes[I]<=0&&(this._waitTimes[I]=0,this._events.fire(I)))}),g)}}}export{II as default};
