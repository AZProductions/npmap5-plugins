!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Interactivity=e()}(this,(function(){"use strict";class t{constructor(t,e,o){this.options={minOpacity:.5,...o};const i=e.style.getImage(t);i&&i.data&&(this.sdf=i.sdf,this.width=i.data.width,this.height=i.data.height,this.layerIconData=i.data,this.pixelRatio=i.pixelRatio,this.mask=this.create())}imageData(){if(this.layerIconData&&this.height&&this.width)return new ImageData(Uint8ClampedArray.from(this.layerIconData.data),this.width,this.height)}create(t=this.options.minOpacity){if(!this.width||!this.height||!this.layerIconData)return[];const e=[],o=100*t;for(let t=3;t<this.layerIconData.data.length;t+=4)e.push(this.layerIconData.data[t]>=o);return e}readCoord(t,e,o=0){const i=(t,e)=>{if(this.height&&this.width&&this.mask&&e<this.height&&t<this.width&&e>=0&&t>=0&&this.mask[t+e*this.width])return!0};if(i(t,e))return!0;if(!(o>0))return!1;{let r,a,n,s;for(r=-1*o;r<o;r++)for(a=-1*o;a<o;a++)if(n=t+r,s=e+a,i(n,s))return!0}}}const e={fill:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='22' height='22' xml:space='preserve'%3E%3Cpath d='M20.38 17.17V4.83A2.49 2.49 0 0 0 22 2.5 2.5 2.5 0 0 0 19.5 0c-1.07 0-1.98.68-2.33 1.63H4.83A2.486 2.486 0 0 0 2.5 0 2.5 2.5 0 0 0 0 2.5c0 1.07.68 1.98 1.63 2.33v1.33C.68 6.52 0 7.43 0 8.5A2.5 2.5 0 0 0 2.5 11c1.07 0 1.98-.68 2.33-1.63h3.33c.25.67.78 1.21 1.46 1.46v6.33C8.68 17.52 8 18.43 8 19.5a2.5 2.5 0 0 0 2.5 2.5c1.07 0 1.98-.68 2.33-1.63h4.33c.36.95 1.27 1.63 2.34 1.63a2.5 2.5 0 0 0 2.5-2.5c0-1.07-.68-1.98-1.62-2.33zm-3.21 1.46h-4.33c-.25-.67-.78-1.21-1.46-1.46v-6.33C12.32 10.48 13 9.57 13 8.5A2.5 2.5 0 0 0 10.5 6c-1.07 0-1.98.68-2.33 1.63H4.83c-.25-.68-.78-1.21-1.45-1.46V4.83c.67-.25 1.21-.78 1.46-1.46h12.33c.25.67.78 1.21 1.46 1.46v12.33c-.68.26-1.21.79-1.46 1.47zM9.75 8.5c0-.41.34-.75.75-.75s.75.34.75.75-.34.75-.75.75-.75-.34-.75-.75zm9.75-6.75c.41 0 .75.34.75.75s-.34.75-.75.75-.75-.34-.75-.75.34-.75.75-.75zm-17 0c.41 0 .75.34.75.75s-.34.75-.75.75-.75-.34-.75-.75.34-.75.75-.75zm0 7.5c-.41 0-.75-.34-.75-.75s.34-.75.75-.75.75.34.75.75-.34.75-.75.75zm8 11c-.41 0-.75-.34-.75-.75s.34-.75.75-.75.75.34.75.75-.34.75-.75.75zm9 0c-.41 0-.75-.34-.75-.75s.34-.75.75-.75.75.34.75.75-.34.75-.75.75z'/%3E%3C/svg%3E",line:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='22' height='22' xml:space='preserve'%3E%3Cpath d='M1 21v-3c.48 0 .94-.02 1.37-.06l.25 2.99C2.1 20.98 1.55 21 1 21zM4.82 20.59l-.7-2.92c.88-.21 1.65-.53 2.3-.94l1.61 2.53c-.92.59-2 1.04-3.21 1.33zm5.05-2.91L7.6 15.72c.5-.58.87-1.27 1.1-2.06l2.88.85c-.36 1.21-.93 2.27-1.71 3.17zm2.11-5.46-2.99-.19c0-.18.01-.36.01-.53 0-.95.08-1.81.23-2.63l2.95.56c-.12.62-.18 1.32-.18 2.07 0 .24-.01.48-.02.72zm.68-4.37L9.91 6.64c.5-1.13 1.21-2.12 2.11-2.92l1.99 2.24c-.58.52-1.02 1.14-1.35 1.89zm2.69-2.78L14 2.39c.94-.47 2.03-.83 3.22-1.06l.57 2.95c-.93.18-1.75.44-2.44.79zM19.6 4.05l-.2-3C19.9 1.02 20.44 1 21 1v3c-.49 0-.96.02-1.4.05z'/%3E%3C/svg%3E",symbol:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='22' height='22' style='enable-background:new 0 0 22 22' xml:space='preserve'%3E%3Ccircle cx='11' cy='11' r='4'/%3E%3C/svg%3E",circle:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='22' height='22' style='enable-background:new 0 0 22 22' xml:space='preserve'%3E%3Ccircle cx='11' cy='11' r='11'/%3E%3C/svg%3E"};class o{constructor(t){this._color=this._rgbaToColors(this._colorToRgba(t))}set color(t){this._color=this._rgbaToColors(this._colorToRgba(t))}get hex(){return"#"+[this._color.red,this._color.green,this._color.blue].map((t=>("00"+t.toString(16)).slice(-2))).join("")}set alpha(t){this._color.alpha=t}get alpha(){return this._color.alpha}get rgbaString(){return`rgba(${this._color.red}, ${this._color.green}, ${this._color.blue}, ${this._color.alpha})`}get rgba(){return{red:this._color.red,green:this._color.green,blue:this._color.blue,alpha:this._color.alpha}}get array(){return[this._color.red,this._color.green,this._color.blue,this._color.alpha]}_colorToRgba(t){"string"==typeof(t=t.toLowerCase())&&t.match(/^[0-9a-f]{6}$/)&&(t="#"+t);const e=document.createElement("canvas").getContext("2d");if(!e)throw new Error("Color cannot be parsed");e.fillStyle=t;const o=e.fillStyle;let i;if("#"===o.substring(0,1))i=`rgba(${parseInt(e.fillStyle.substring(1,3),16)}, ${parseInt(e.fillStyle.substring(3,5),16)}, ${parseInt(e.fillStyle.substring(5,7),16)}, 1)`;else{if("rgba"!==o.substring(0,4))throw new Error("Color cannot be parsed");i=o}return i}_rgbaToColors(t){const e=new RegExp("rgba\\((\\d{1,3}),(\\d{1,3}),(\\d{1,3}),(\\d?\\.?\\d){1,}\\)"),o=t.replace(/\s/g,"").match(e);if(!o)throw new Error("Color cannot be parsed");const[i,r,a,n,s]=o;return{red:parseInt(r,10),green:parseInt(a,10),blue:parseInt(n,10),alpha:parseFloat(s)}}}const i=(t,e,i)=>{const r=e.style.getImage(t);if(!r)throw new Error("Image not found");const n=new ImageData(Uint8ClampedArray.from(r.data.data),r.data.width,r.data.height),s=new a;if(s.updateImageData(n,r.pixelRatio),i){const t=new o(i),e=s.colorMask(t.rgbaString,n);s.updateImageData(e,r.pixelRatio)}return s};class r{constructor(t){this._svgUrl="string"==typeof t?t:this._toUrl(t)}toElement(t=this._svgUrl){const e=new RegExp("^data:image/svg\\+xml,","i"),o=new RegExp("%[A-Fa-f0-9]{2,2}","g");let i=t;if(i.match(e)){i=i.replace(e,"");const t=i.match(o)||[];i=t.filter(((t,e,o)=>e===o.indexOf(t))).reduce(((t,e)=>{const o=new RegExp(e,"g");return t.replace(o,String.fromCharCode(parseInt(e.substring(1),16)))}),i)}const r=document.createElement("span");return r.innerHTML=i,r.children[0]}get dataUrl(){return this._toUrl()}_toUrl(t=this._svgUrl){if("string"==typeof t)return this._svgUrl;return"data:image/svg+xml,"+["%","#","{","}","<",">"].reduce(((t,e)=>{const o=new RegExp(e,"g"),i=("%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).toUpperCase();return t.replace(o,i)}),t.outerHTML).replace(/"/g,"'")}recolor(t,e,i){const a=this.toElement();return[...a.children].forEach((r=>{const a=(t,e)=>{const i=r.getAttribute(t);let a,n=-1;if(n=i?e.map((t=>t[0])).indexOf(i):e.map((t=>t[0])).indexOf(void 0),n>-1)if(a=e[n][1],void 0!==a){const e=new o(a);r.setAttribute(t,e.hex),r.setAttribute(t+"-opacity",e.alpha.toString())}else i&&(r.removeAttribute(t),r.removeAttribute(t+"-opacity"))};if(t&&a("fill",t),e&&a("stroke",e),i&&"circle"===r.nodeName){let t=r.getAttribute("r");t&&r.setAttribute("r",(parseInt(t,10)-i).toString()),r.setAttribute("stroke-width",i.toString())}})),new r(a)}async addToMap(t,e,o,i,r=window.devicePixelRatio){let a;try{a=await this.toImageData(o,i,r)}catch(t){throw t}if(e.hasImage(t))return!1;{const o=window.devicePixelRatio;return e.addImage(t,a,{pixelRatio:o}),!0}}toImageData(t,e,o){return new Promise(((i,r)=>{const a=document.createElement("canvas"),n=a.getContext("2d"),s=new Image;t*=o,e*=o,a.width=t,a.height=e,s.onload=()=>{if(n){n.drawImage(s,0,0,t,e);const o=n.getImageData(0,0,t,e);i(o)}else r("Unable to create content")},s.src=this.dataUrl}))}}class a{constructor(t=new Image){this._img=t}_getCanvas(t,e){const o=document.createElement("canvas"),i=o.getContext("2d");if(t=o.height=t||this._img.naturalHeight||this._img.offsetHeight||this._img.height,e=o.width=e||this._img.naturalWidth||this._img.offsetWidth||this._img.width,i&&o.height>0&&o.width>0)return i.drawImage(this._img,0,0,e,t),o;throw new Error("Unable to create content")}get dataUrl(){return this._getCanvas().toDataURL()}updateImageData(t,e=window.devicePixelRatio){const o=document.createElement("canvas"),i=o.getContext("2d");o.width=t.width,o.height=t.height,i&&(i.putImageData(t,0,0),this._img.width=t.width/e,this._img.height=t.height/e,this._img.src=o.toDataURL())}get displayedImageData(){return this._getImageData()}get element(){return this._img}_getImageData(t,e){const o=this._getCanvas(t,e),i=o.getContext("2d");if(i){return i.getImageData(0,0,o.width,o.height)}throw new Error("Unable to create content")}colorMask(t,e=this.displayedImageData){const i=new o(t).array,r=[];for(let t=0;t<e.data.length;t++){const o=t%4;r.push(3===o?e.data[t]:i[o])}return new ImageData(Uint8ClampedArray.from(r),e.width,e.height)}setContrastingBackgroundColor(t=5){const e=()=>{const e=this.displayedImageData,o=e?((t,e)=>{if(e<1)throw new Error("blockSize must be greater than 0");let o=0,i=0;for(let r=0;r<t.data.length;r+=4*e){let[e,a,n,s]=[t.data[r],t.data[r+1],t.data[r+2],t.data[r+3]];o+=s/255*(.299*e+.587*a+.114*n),i+=s/255}return Math.round(o/i)})(e,t):0,i=o<127.5?255:0;return this._img.style.backgroundColor=`rgba(${i},${i},${i},1)`,this};this._img.complete?e():this._img.onload=e}}const n={container:document.createElement("div"),style:{version:8,glyphs:"{fontstack}/{range}.pbf",sources:{blank:{type:"geojson",data:{type:"FeatureCollection",features:[]}}},layers:[]}};class s{constructor(t){this._map=new t.Map(n)}evaluateText(t,e,o){const i=document.createElement("p");return this._evaluate(t,e,o).then((t=>i.textContent=t.map((t=>t.text)).join(""))),i}evaluateHtml(t,e,o,i){const r=i?i.style._availableImages:[],a=document.createElement("div");return this._evaluate(t,e,o,void 0,r).then((t=>{t.forEach((t=>a.appendChild(this._sectionToHtml(t,i)))),console.log("sections",t,a)})).catch((t=>{console.log("ERROR WITH DIV",t)})),a}_sectionToHtml(t,e){const o=document.createElement("span");if(o.textContent=t.text||null,t.fontStack&&(o.style.fontFamily=t.fontStack),t.scale&&(o.style.fontSize=100*t.scale+"%"),t.textColor&&(o.style.color=t.textColor),e&&t.image&&e.hasImage(t.image)){const i=this._drawIcon(t.image,t.image,e);i&&o.appendChild(i)}return o}async _evaluate(t,e,o,i,r){const a=Math.random().toString(32).substring(2);this._map.addLayer({id:a,source:"blank",type:"symbol",layout:{"text-field":t}}),await new Promise((t=>this._map.once("styledata",(()=>t()))));const n=this._map.getLayer(a),s=n.layout&&n.layout._values["text-field"].evaluate({properties:e,state:o},o,i,r).sections||[];return this._map.removeLayer(a),s}_drawIcon(t,e,o){const r=i(t,o);return e&&e.toString&&(r.element.title=r.element.alt=e.toString()),r.element}}class l{constructor(t,e,o){const i={closeButton:!0,closeOnClick:!0,closeOnMove:!1,focusAfterOpen:!0,pointer:"pointer",tolerance:3,formatter:this._formatter.bind(this),templater:this._templater.bind(this),highlightFeature:!1};if(e.highlightFeature){const t="object"==typeof e.highlightFeature?e.highlightFeature:{};e.highlightFeature={highlightColor:"#00ffff",opacity:void 0,layerName:Math.random().toString(36).substring(2),layerConfig:void 0,...t}}"tooltip"===e.type&&(i.anchor="top-left",i.focusAfterOpen=!1),e.formatter||e.templater||(this._expressionTemplate=new s(o)),this.options={...i,...e},this.popupTemplate=t,this.popup=new o.Popup(this.options)}showing(){return this.popup.isOpen}showMulti(t,e,o,i,r){if(!this.options.multiFormatter)throw new Error("No multiFormatter found");this._show(t,this.options.multiFormatter(e,this.popupTemplate,i,r,this.popup),o)}show(t,e,o,i,r,a=!1!==this.options.highlightFeature){this._show(t,(this.options.formatter||this._formatter)(e,this.popupTemplate,i,r),o),i&&a&&this.highlightFeature(e,i)}highlightFeature(t,e){var i;if(t.id=t.id||Math.floor(100*Math.random()),t.state.hover=!0,"object"!=typeof this.options.highlightFeature)throw new Error("Invalid type of highlight layer:"+typeof this.options.highlightFeature);const r=this.options.highlightFeature,a=new o(r.highlightColor);a.alpha=r.opacity?r.opacity:a.alpha;const n=t.layer.type;let s,l,p;window.feature=t,"symbol"===n?s=null===(i=t.layer.layout["icon-image"])||void 0===i?void 0:i.name:"circle"===n?l=t.layer.paint["circle-radius"]:"line"===n&&(p=t.layer.paint["line-width"]);const c=t=>Object.keys(t).map((e=>[e,t[e]])).filter((t=>void 0!==t[1]&&null!==t[1])).reduce(((t,e)=>({...t,[e[0]]:e[1]})),{}),h={circle:{type:"circle",paint:c({"circle-color":a.hex,"circle-radius":l,"circle-opacity":a.alpha})},fill:{type:"fill",paint:c({"fill-color":a.hex,"fill-opacity":a.alpha})},line:{type:"line",paint:c({"line-color":a.hex,"line-width":p,"line-opacity":a.alpha})},symbol:{type:"symbol",layout:{"icon-image":s},paint:c({"icon-color":r.highlightColor,"icon-opacity":a.alpha})}},d=t.toJSON();return r.layerName||(r.layerName=Math.random().toString(36).substring(2)),e.addSource(r.layerName,{type:"geojson",data:d}),e.addLayer({...h[n]||h.circle,minzoom:0,maxzoom:20,...r.layerConfig||{},id:r.layerName,source:r.layerName}),this.popup.once("close",(()=>{r.layerName&&(e.getLayer(r.layerName)&&e.removeLayer(r.layerName),e.getSource(r.layerName)&&e.removeSource(r.layerName))})),r.layerName}_show(t,e,o){o instanceof HTMLElement?o.appendChild(e):(this.popup.setDOMContent(e),this.popup.setLngLat(t),this.popup.addTo(o))}_templater(t,e,o){if("string"==typeof t)return this._simpleTemplater(t,e.properties);if(this._expressionTemplate)return this._expressionTemplate.evaluateHtml(t,e.properties,e.state,o);throw new Error("Cannot load expression template")}_simpleTemplater(t,e){const o=document.createElement("span");return Object.keys(e).forEach((o=>{const i=new RegExp("{"+o+"}","g");t=t.replace(i,e[o])})),o.textContent=t,o}_formatter(t,e,o){const i=this.options.templater||this._templater,r=(e,r)=>{const a=document.createElement(e);let n=i(r,t,o);return"string"==typeof n?a.textContent=n:a.appendChild(n),a},a=document.createElement("div");if(void 0===e)throw new Error("The default Popup Formatter requires a template");if("string"==typeof e)a.appendChild(r("p",e));else if(e instanceof HTMLElement)a.appendChild(e);else{if(e.header){const t=a.appendChild(r("strong",e.header));a.appendChild(t)}if(e.body)if(e.body instanceof HTMLElement)a.appendChild(e.body);else{const t=a.appendChild(r("div",e.body));a.appendChild(t)}if(e.footer){const t=a.appendChild(r("div",e.footer));a.appendChild(t)}}return a}}const p=t=>{if(t)return`rgba(${Math.round(255*t.r)},${Math.round(255*t.g)},${Math.round(255*t.b)},${t.a})`};function c(t,e,o,i,r){if(!o||!i)throw new Error("activePopups is required for the default multi popup");const a=document.createElement("span"),n=document.createElement("ul"),s=h(t,o,i,r);return Object.keys(s).forEach((t=>{const e=document.createElement("li");e.textContent=t;const i=d(s[t],o,a);e.appendChild(i),n.appendChild(e)})),a.appendChild(n),a}const h=(t,e,i,r)=>t.map((t=>{var a,n;const s=null===(a=i.get("popup"))||void 0===a?void 0:a.get(t.layer.id);let l=p(t.layer.paint[t.layer.type+"-color"])||p(t.layer.paint["icon-color"]);if(l&&void 0!==t.layer.paint[t.layer.type+"-opacity"]){const e=new o(l);e.alpha=t.layer.paint[t.layer.type+"-opacity"],l=e.rgbaString}let c,h=p(t.layer.paint["circle-stroke-color"])||p(t.layer.paint["fill-outline-color"]);if(h&&void 0!==t.layer.paint["circle-stroke-opacity"]){const e=new o(h);e.alpha=t.layer.paint["circle-stroke-opacity"],h=e.rgbaString}h&&(c=t.layer.paint["circle-stroke-width"]||1);const d=document.createElement("div");let u,g,m="",y=t.layer.id;return s&&(s.show([0,0],t,d,e,void 0,!1),m=[...d.children[0].children].map((t=>t.textContent)).filter((t=>t&&t.trim().length))[0]||"",""===m.trim()&&(m=t.layer.type+" Feature"),y=s.options.groupName||y,u=s.options.icon,"symbol"===t.layer.type&&(g=null===(n=t.layer.layout["icon-image"])||void 0===n?void 0:n.name),null==r||r.on("open",(t=>s.popup.fire("open",t))),null==r||r.on("close",(t=>s.popup.fire("close",t)))),{groupName:y,groupIcon:u,symbolIcon:g,popup:s,primaryKeys:null==s?void 0:s.options.primaryKeys,iconColor:l,iconStroke:h,iconStrokeWidth:c,content:d,textContent:m,feature:t}})).reduce(((t,e)=>(e.popup&&(t[e.groupName]=t[e.groupName]||[],t[e.groupName].push(e)),t)),{}),d=(t,n,s)=>{const l=document.createElement("ul");return t.forEach((t=>{const p=document.createElement("li"),c=document.createElement("a"),h=t.symbolIcon||t.groupIcon;let d;if(h)try{d=i(h,n,t.iconColor)}catch(t){d=void 0}if(!d){let i=new r(e[t.feature.layer.type]||e.symbol);if(t.iconColor){const e=new o(t.iconColor).rgbaString,r=t.iconStroke&&new o(t.iconStroke).rgbaString;i=i.recolor([[void 0,e]],r&&"circle"===t.feature.layer.type?[[void 0,r]]:void 0,t.iconStrokeWidth)}d=new a,d.element.src=i.dataUrl}d.setContrastingBackgroundColor(5),c.textContent=" "+t.textContent,c.href="",c.addEventListener("click",(e=>{e.preventDefault(),u(t,s,n)}),!1),p.appendChild(d.element),p.appendChild(c),l.appendChild(p)})),l},u=(t,e,o)=>{const i=[...e.children];let r;o&&t.popup.options.highlightFeature&&(r=t.popup.highlightFeature(t.feature,o));const a=()=>{o&&r&&(o.getLayer(r)&&o.removeLayer(r),o.getSource(r)&&o.removeSource(r))};t.popup.popup.once("close",(t=>{a()}));const n=document.createElement("a");n.href="",n.addEventListener("click",(t=>{t.preventDefault(),[...e.children].forEach((t=>e.removeChild(t))),i.forEach((t=>e.appendChild(t))),a()}),!1),n.textContent="« Back",[...e.children].forEach((t=>e.removeChild(t))),e.appendChild(t.content),e.appendChild(n)};return class{constructor(t,e,o={}){this._activePopups=new Map,this._map=e,this._mapLibrary=t,this._activeTooltip=void 0,this._iconMasks=new Map,this._clicks=0,this._touch=[];const i={type:"popup",multiFormatter:c};this._genericPopup=new l(void 0,{...i,...o},t),this._initMapListeners(),window.MMAAPP=e}addTooltip(t,e,o){return o={focusAfterOpen:!1,closeButton:!1,type:"tooltip",...o},this._add(t,e,o)}removeTooltip(t){return this._remove(t,"tooltip")}addPopup(t,e,o){return this._add(t,e,{type:"popup",...o})}removePopup(t){return this._remove(t,"popup")}_add(t,e,o){if(void 0===o.type)throw new Error("The _add function requires a type (popup or tooltup)");this._activePopups.get(o.type)||this._activePopups.set(o.type,new Map);const i=this._activePopups.get(o.type);if(i){let r=i.get(t);if(r)throw new Error(`Layer ${t} already has a ${o.type}, remove the other ${o.type} first`);return r=new l(e,o,this._mapLibrary),i.set(t,r),!0}}_remove(t,e){this._activePopups.get(e)||this._activePopups.set(e,new Map);const o=this._activePopups.get(e);if(o){if(!o.get(t))throw new Error(`Layer ${t} does not have a ${e}.`);return o.delete(t),!0}}_initMapListeners(){this._map.on("click",(t=>{this._clicks+=1,setTimeout((()=>{1===this._clicks&&this._click(t),this._clicks=0}),200)})),this._map.on("mousemove",(t=>{if(2!==t.originalEvent.button){this._touch.filter((e=>{const o=t.point.x-e[0],i=t.point.y-e[1];return Math.sqrt(o*o+i*i)<3})).length>0||this._mousemove(t)}})),this._map.on("touchstart",(t=>{this._touch.push([t.point.x,t.point.y]),setTimeout((()=>{this._touch=this._touch.filter((e=>t.point.x!==e[0]&&t.point.x!==e[1]))}),800)})),this._map.on("mousedown",(t=>{var e,o;if(2===t.originalEvent.button&&this._activeTooltip){const t=null===(o=null===(e=this._activePopups.get("tooltip"))||void 0===e?void 0:e.get(this._activeTooltip))||void 0===o?void 0:o.popup;t&&t.remove()}}))}_click(t){var e;const{featuresUnderMouse:o,popupLayers:i}=this._getActiveFeatures(t.point),r=this._dedupeFeatures(o.filter((t=>i.indexOf(t.layer.id)>-1)),"popup");if(r.length>1){const e=this._map;this._genericPopup.showMulti(t.lngLat,r,e,this._map,this._activePopups),this._genericPopup.popup._container.addEventListener("mouseenter",(()=>this._mousemove()))}else if(1===r.length){const o=r[0],i=this._wrapCoords(t,"Point"===o.geometry.type?o.geometry.coordinates.slice():[t.lngLat.lng,t.lngLat.lat]),a=null===(e=this._activePopups.get("popup"))||void 0===e?void 0:e.get(o.layer.id);if(a){const t=a.options.context||this._map;a.show(i,o,t,this._map),a.popup._container.addEventListener("mouseenter",(()=>this._mousemove()))}}}_quickHash(t){let e=0;for(var o=0;o<t.length;o++){e=(e<<5)-e+t.charCodeAt(o),e&=e}return e.toString(32)}_mousemove(t){var e;if(!t)return void(this._activeTooltipPopup&&this._activeTooltipPopup.popup.remove());const{featuresUnderMouse:o,popupLayers:i,tooltipLayers:r}=this._getActiveFeatures(t.point);const a=o.filter((t=>i.indexOf(t.layer.id)>-1)).map((t=>{var e,o;return(null===(o=null===(e=this._activePopups.get("popup"))||void 0===e?void 0:e.get(t.layer.id))||void 0===o?void 0:o.options.pointer)||"pointer"}))[0]||"";this._map.getCanvas().style.cursor=a;const n=this._dedupeFeatures(o.filter((t=>r.indexOf(t.layer.id)>-1)),"tooltip")[0],s=n&&this._quickHash(JSON.stringify(n.toJSON()));if(this._activeTooltip&&this._activeTooltip!==s&&this._activeTooltipPopup&&this._activeTooltipPopup.popup.remove(),n&&this._activeTooltip!==s){const o=this._wrapCoords(t,"Point"===n.geometry.type?n.geometry.coordinates.slice():[t.lngLat.lng,t.lngLat.lat]),i=null===(e=this._activePopups.get("tooltip"))||void 0===e?void 0:e.get(n.layer.id);if(i){this._activeTooltip=s,this._activeTooltipPopup=i;const e=i.options.context||this._map;i.show(o,n,e,this._map),"Point"!==n.geometry.type&&"mousemove"===t.originalEvent.type&&i.popup.trackPointer(),i.popup.once("close",(()=>{this._activeTooltip=void 0,this._activeTooltipPopup=void 0}))}}}_getActiveFeatures(t){var e,o;const i=[...(null===(e=this._activePopups.get("popup"))||void 0===e?void 0:e.keys())||[]],r=[...(null===(o=this._activePopups.get("tooltip"))||void 0===o?void 0:o.keys())||[]],a=[...i,...r].filter(((t,e,o)=>o.indexOf(t)===e));return{featuresUnderMouse:this._getAllFeatures(t,3,a),popupLayers:i,tooltipLayers:r,activeLayers:a}}_wrapCoords(t,e){for(;Math.abs(t.lngLat.lng-e[0])>180;)e[0]+=t.lngLat.lng>e[0]?360:-360;return{lng:e[0],lat:e[1]}}_getAllFeatures(e,o,i){const r=[[e.x-o,e.y-o],[e.x+o,e.y+o]];return this._map.queryRenderedFeatures(r,{layers:i.map((t=>t)).filter((t=>Object.keys(this._map.style._layers).indexOf(t)>-1))}).filter((o=>{if("symbol"===o.layer.type){const s=this._map.getLayer(o.layer.id).layout._values["icon-image"].evaluate(o,o.state,null,this._map.style._availableImages).name,l=this._map.style.getImage(s);let p=this._iconMasks.get(s);if(p||(p=new t(s,this._map,{}),this._iconMasks.set(s,p)),l&&p){var i,r=l.pixelRatio||1,a=[(i=Array.isArray(o.geometry.coordinates[0])?this._map.project(o.geometry.coordinates[0]):this._map.project(o.geometry.coordinates)).x-l.data.width/2/r,i.y-l.data.height/2/r],n=[Math.floor((e.x-a[0])*r),Math.floor((e.y-a[1])*r)];return p.readCoord(n[0],n[1],3)}return!0}return!0})).filter((t=>!0))}_dedupeFeatures(t,e="popup"){const o={};return t.forEach((t=>{var i,r;const a=(null===(r=null===(i=this._activePopups.get(e))||void 0===i?void 0:i.get(t.layer.id))||void 0===r?void 0:r.options.primaryKeys)||[];let n=t.layer.id;a.length?n+=JSON.stringify(Object.keys(t.properties).filter((t=>a.indexOf(t)>-1)).map((e=>[e,t.properties[e]])).reduce(((t,e)=>({...t,[e[0]]:e[1]})),{})):n+=JSON.stringify(t.properties);const s=(t=>{let e=0;for(let o=0;o<t.length;o++)e=(e<<5)-e+t.charCodeAt(o),e|=0;return e.toString(36)})(n);if(o[s]){const e=o[s].geometry;"Point"!==e.type&&"LineString"!==e.type&&"Polygon"!==e.type||(e.type="Multi"+e.type,e.coordinates=[e.coordinates]),"MultiPoint"!==e.type&&"MultiLineString"!==e.type&&"MultiPolygon"!==e.type||t.geometry.type===e.type.replace(/^Multi/g,"")&&(e.coordinates.push(t.geometry.coordinates),o[s].geometry=e)}else o[s]=t})),Object.keys(o).map((t=>o[t]))}}}));
//# sourceMappingURL=maplibre-gl-interactivity.min.js.map
